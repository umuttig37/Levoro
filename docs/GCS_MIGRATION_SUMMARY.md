# GCS Bucket Migration - Summary

## What Was Created

I've created a complete toolkit to help you migrate your GCS buckets to a new billing account and project. Here's what you have:

---

## üìö Documentation (3 Files)

### 1. **GCS_QUICK_START.md** ‚≠ê START HERE
- **Location:** `docs/GCS_QUICK_START.md`
- **Purpose:** Quick 3-step guide to get you up and running fast
- **Best for:** When you just want to get it done quickly

### 2. **GCS_NEW_BUCKET_SETUP_GUIDE.md** üìñ COMPLETE GUIDE
- **Location:** `docs/GCS_NEW_BUCKET_SETUP_GUIDE.md`
- **Purpose:** Comprehensive step-by-step instructions with screenshots locations
- **Covers:**
  - Google Cloud Console setup (17 steps)
  - Application configuration
  - Testing & verification
  - Monitoring & security
  - Troubleshooting (8+ common issues)
  - Cost estimation
- **Best for:** First-time setup or if something goes wrong

### 3. **GCS_MIGRATION_SCRIPTS.md** üõ†Ô∏è SCRIPTS REFERENCE
- **Location:** `docs/GCS_MIGRATION_SCRIPTS.md`
- **Purpose:** Documentation for all the helper scripts
- **Best for:** Understanding what each script does

---

## üîß Scripts (5 Files)

### 1. **setup-gcs-buckets.ps1** (Windows)
- **Location:** `scripts/setup-gcs-buckets.ps1`
- **Purpose:** Automated setup for Windows users
- **What it does:**
  - Creates Google Cloud project resources
  - Sets up both buckets with correct permissions
  - Downloads and converts service account credentials
  - Outputs ready-to-paste environment variables
- **Usage:**
  ```powershell
  .\setup-gcs-buckets.ps1 -ProjectId "your-new-project-id"
  ```

### 2. **setup-gcs-buckets.sh** (Linux/Mac)
- **Location:** `scripts/setup-gcs-buckets.sh`
- **Purpose:** Automated setup for Linux/Mac users
- **Same functionality as Windows version**
- **Usage:**
  ```bash
  ./setup-gcs-buckets.sh your-new-project-id
  ```

### 3. **verify-gcs-setup.py** (Cross-platform)
- **Location:** `scripts/verify-gcs-setup.py`
- **Purpose:** Verify your GCS configuration is correct
- **What it checks:**
  - Environment variables are set
  - Credentials are valid JSON
  - GCS service initializes
  - Buckets are accessible
- **Usage:**
  ```bash
  python scripts/verify-gcs-setup.py
  ```

### 4. **cors.json** (Configuration)
- **Location:** `scripts/cors.json`
- **Purpose:** CORS configuration for buckets
- **When to use:** If you implement browser-based uploads later
- **Usage:**
  ```bash
  gsutil cors set scripts/cors.json gs://levoro-transport-images
  ```

### 5. **.env.gcs.template** (Template)
- **Location:** `scripts/.env.gcs.template`
- **Purpose:** Template for your environment variables
- **Usage:** Reference when updating `.env` file

---

## üéØ Your Setup Plan (Recommended)

### Phase 1: Preparation (5 minutes)
1. ‚úÖ Install gcloud CLI if not already installed
2. ‚úÖ Authenticate: `gcloud auth login`
3. ‚úÖ Create new project in Google Cloud Console (manual)
4. ‚úÖ Link new billing account to project (manual)
5. ‚úÖ Note down your new PROJECT_ID

### Phase 2: Automated Setup (5 minutes)
1. ‚úÖ Open PowerShell/Terminal in project directory
2. ‚úÖ Navigate to: `cd scripts`
3. ‚úÖ Run setup script:
   - Windows: `.\setup-gcs-buckets.ps1 -ProjectId "YOUR_PROJECT_ID"`
   - Linux/Mac: `./setup-gcs-buckets.sh YOUR_PROJECT_ID`
4. ‚úÖ Wait for completion (2-3 minutes)
5. ‚úÖ Copy output environment variables

### Phase 3: Configuration (3 minutes)
1. ‚úÖ Open `.env` file
2. ‚úÖ Paste GCS environment variables
3. ‚úÖ Save file
4. ‚úÖ Delete downloaded JSON key file (security)

### Phase 4: Verification (2 minutes)
1. ‚úÖ Run: `python scripts/verify-gcs-setup.py`
2. ‚úÖ Confirm all checks pass
3. ‚úÖ Start app: `python app.py`
4. ‚úÖ Check logs for `[GCS] Enabled`

### Phase 5: Testing (10 minutes)
1. ‚úÖ Create test order with images
2. ‚úÖ Submit driver application with license images
3. ‚úÖ Verify uploads in GCS Console
4. ‚úÖ Check public images are accessible
5. ‚úÖ Verify private images are NOT directly accessible

### Phase 6: Production (5 minutes)
1. ‚úÖ Update production environment variables
2. ‚úÖ Deploy to production
3. ‚úÖ Test image uploads on production
4. ‚úÖ Set up monitoring & budget alerts

**Total time: ~30 minutes**

---

## üîë Key Configuration Values

You'll need to set these in your `.env` file:

```env
GCS_PROJECT_ID=your-new-project-id
GCS_BUCKET_NAME=levoro-transport-images
GCS_PRIVATE_BUCKET_NAME=levoro-transport-images-private
GCS_CREDENTIALS_JSON=<very long base64 string>
```

**Important:**
- `GCS_PROJECT_ID` - Get from Google Cloud Console
- `GCS_BUCKET_NAME` - Same as before (public)
- `GCS_PRIVATE_BUCKET_NAME` - Same as before (private)
- `GCS_CREDENTIALS_JSON` - Generated by setup script

---

## üìä What You're Migrating

### Current Setup (OLD):
- Project: `levoro-473806`
- Public Bucket: `levoro-transport-images`
- Private Bucket: `levoro-transport-images-private`
- Region: `EUROPE-NORTH1`

### New Setup:
- Project: `YOUR_NEW_PROJECT_ID` ‚Üê You choose
- Public Bucket: `levoro-transport-images` ‚Üê Same name
- Private Bucket: `levoro-transport-images-private` ‚Üê Same name
- Region: `EUROPE-NORTH1` ‚Üê Same region

**Why same bucket names?**
- No code changes needed
- Environment variables stay the same
- Only credentials and project ID change

---

## ‚ö†Ô∏è Important Notes

### Security
- ‚úÖ `.gitignore` already includes `*.json`
- ‚ùå Never commit service account keys
- ‚úÖ Delete JSON key after converting to base64
- ‚úÖ Rotate credentials every 90 days

### Bucket Policies
Your buckets will have:
- **Public bucket:** 
  - Publicly readable (allUsers:objectViewer)
  - Service account can upload (Storage Object Admin)
- **Private bucket:**
  - NOT publicly readable
  - Service account can upload (Storage Object Admin)
  - Access via signed URLs only

### Cost
Expected monthly cost:
- Small scale (< 100 orders/month): ‚Ç¨1-2
- Medium scale (< 1000 orders/month): ‚Ç¨5-10
- Large scale (> 1000 orders/month): ‚Ç¨10-20

Factors:
- Storage: ~‚Ç¨0.020 per GB/month
- Egress: ~‚Ç¨0.12 per GB
- Operations: ~‚Ç¨0.05 per 10k writes

---

## üö® Common Mistakes to Avoid

1. **Forgetting to authenticate gcloud**
   ```bash
   gcloud auth login
   ```

2. **Not setting correct project**
   ```bash
   gcloud config set project YOUR_PROJECT_ID
   ```

3. **Line breaks in base64 credentials**
   - Should be one continuous string
   - No newlines, no spaces

4. **Not restarting app after updating .env**
   - Changes only apply after restart

5. **Committing credentials to Git**
   - Always check before committing

6. **Using old project ID**
   - Make sure to use NEW project ID

---

## ‚úÖ How to Know It's Working

### Startup Logs (Success):
```
[GCS] Enabled - images will be stored in: orders/{order_id}/{filename}
[GCS] Bucket: levoro-transport-images
[GCS] Project: YOUR_NEW_PROJECT_ID
```

### Startup Logs (Failure):
```
[GCS] Not configured - image upload will use local storage
[GCS] Missing environment variables: GCS_BUCKET_NAME
```

### Image Upload (Success):
```
Uploading image to GCS: orders/123/pickup_abc123.jpg
Image uploaded successfully to GCS
```

### Image Upload (Failure):
```
GCS upload failed: Permission denied
Falling back to local storage
```

---

## üìû Where to Get Help

### Documentation Order (Read in this order if stuck):
1. **GCS_QUICK_START.md** - Quick troubleshooting
2. **GCS_NEW_BUCKET_SETUP_GUIDE.md** - Detailed troubleshooting
3. **GCS_MIGRATION_SCRIPTS.md** - Script-specific issues

### External Resources:
- Google Cloud Storage: https://cloud.google.com/storage/docs
- Service Accounts: https://cloud.google.com/iam/docs/service-accounts
- gcloud CLI: https://cloud.google.com/sdk/gcloud/reference

### Your Codebase:
- `services/gcs_service.py` - GCS implementation
- `CLAUDE.md` - Application architecture
- `docs/fixes/GCS_SERVICE_ACCOUNT_FIX.md` - Previous GCS fixes

---

## üéâ What Happens After Setup

Once everything is configured:

1. **Development:**
   - Images upload to: `dev/orders/{order_id}/` (when FLASK_ENV=development)
   - Driver licenses to: `dev/driver-licenses/{id}/`

2. **Production:**
   - Images upload to: `orders/{order_id}/`
   - Driver licenses to: `driver-licenses/{id}/`

3. **Automatic Features:**
   - Image resizing (max 1200px width)
   - Compression (80% quality)
   - Format conversion (all to JPEG)
   - Automatic cleanup on order deletion
   - Public URLs for order images
   - Signed URLs for private images (1 hour validity)

---

## üîÑ Migration Impact

### What Changes:
- ‚úÖ Billing account (new)
- ‚úÖ Google Cloud project (new)
- ‚úÖ Service account credentials (new)
- ‚úÖ GCS project ID (new)

### What Stays Same:
- ‚úÖ Bucket names
- ‚úÖ Bucket policies
- ‚úÖ Application code
- ‚úÖ File structure
- ‚úÖ URL patterns
- ‚úÖ Database (no changes)

### What Needs Update:
- ‚úÖ `.env` file (4 variables)
- ‚úÖ Production environment (4 variables)

---

## üìÖ Next Steps After Migration

1. **Monitor costs** for first month
2. **Set up budget alerts** (recommended: ‚Ç¨10/month)
3. **Schedule key rotation** (90 days)
4. **Document new project ID** in your password manager
5. **Optional:** Set up Cloud Monitoring dashboard
6. **Optional:** Configure lifecycle policies for old dev images

---

## üìù Checklist Summary

Use this to track your progress:

```
PRE-SETUP
‚ñ° gcloud CLI installed
‚ñ° Authenticated with gcloud
‚ñ° New project created in console
‚ñ° New billing account linked
‚ñ° Project ID documented

AUTOMATED SETUP
‚ñ° Ran setup script successfully
‚ñ° Copied environment variables
‚ñ° Updated .env file
‚ñ° Deleted JSON key file

VERIFICATION
‚ñ° Ran verify-gcs-setup.py
‚ñ° All checks passed
‚ñ° Restarted application
‚ñ° Confirmed [GCS] Enabled in logs

TESTING
‚ñ° Tested order image upload
‚ñ° Tested driver license upload
‚ñ° Verified public images accessible
‚ñ° Verified private images protected

PRODUCTION
‚ñ° Updated production environment
‚ñ° Deployed to production
‚ñ° Tested production uploads
‚ñ° Confirmed working in production

POST-SETUP
‚ñ° Set up budget alerts
‚ñ° Scheduled credential rotation
‚ñ° Documented new setup
‚ñ° Archived old credentials securely
```

---

## üéØ Ready to Start?

**Quick start command (Windows):**
```powershell
cd C:\Users\Lenovo\Desktop\DEV\vscode\Levoro\scripts
.\setup-gcs-buckets.ps1 -ProjectId "your-new-project-id"
```

**Quick start command (Linux/Mac):**
```bash
cd ~/path/to/Levoro/scripts
./setup-gcs-buckets.sh your-new-project-id
```

Then follow the on-screen instructions!

---

**Created:** 2025-01-08  
**Author:** GitHub Copilot  
**Version:** 1.0
