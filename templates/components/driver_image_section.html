<!-- Driver Image Section Component -->
<div class="image-section">
    <h3>{{ 'Nouto' if image_type == 'pickup' else 'Toimitus' }} kuvat</h3>
    <div class="image-counter">
        <span class="image-counter-text">{{ images_data|length if images_data else 0 }}/15 kuvaa</span>
        <span class="image-counter-limit">Maksimi 15 kuvaa</span>
    </div>

    {% if images_data and images_data|length > 0 %}
    <!-- Images Grid -->
    <div class="images-grid">
        {% for img in images_data|sort(attribute='order') %}
        <div class="image-item" data-image-type="{{ image_type }}">
            <img src="{{ img.file_path }}"
                 alt="{{ 'Nouto kuva' if image_type == 'pickup' else 'Toimitus kuva' }}"
                 class="image-thumbnail"
                 data-image-id="{{ img.id }}"
                 onclick="openImageModal('{{ image_type }}', '{{ img.id }}')">
            <div class="image-actions">
                <button class="image-action-btn delete"
                        onclick="deleteDriverImage('{{ order.id }}', '{{ image_type }}', '{{ img.id }}')"
                        title="Poista kuva">×</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Upload Form -->
    {% if can_upload and (not images_data or images_data|length < 15) %}
    <form method="POST" action="{{ url_for('driver.upload_image', order_id=order.id) }}"
          enctype="multipart/form-data"
          class="upload-form driver-upload-form"
          id="driver-{{ image_type }}-form-{{ order.id }}">
        <input type="hidden" name="image_type" value="{{ image_type }}">
        <input type="file" name="image" accept=".jpg,.jpeg,.png,.webp" required onchange="submitDriverImageForm(this)">

        {% if images_data and images_data|length > 0 %}
        <button type="submit" class="btn btn-primary">Lataa lisää kuvia</button>
        {% else %}
        <button type="submit" class="btn btn-primary">Lataa {{ 'nouto' if image_type == 'pickup' else 'toimitus' }} kuva</button>
        {% endif %}

        <div class="upload-status" style="display: none;">
            <span class="uploading">Ladataan...</span>
        </div>
    </form>
    {% elif not can_upload %}
    <p class="text-muted text-sm">
        {% if image_type == 'pickup' %}
        Kuvien lataus mahdollista kun olet saapunut noutopaikalle
        {% else %}
        Kuvien lataus mahdollista kun olet saapunut toimituspaikalle
        {% endif %}
    </p>
    {% else %}
    <p class="text-muted text-sm">Maksimi kuvia (15) ladattu</p>
    {% endif %}
</div>

<script>
function submitDriverImageForm(input) {
    const form = input.closest('form');
    const status = form.querySelector('.upload-status');
    const button = form.querySelector('button[type="submit"]');

    status.style.display = 'block';
    button.disabled = true;

    form.submit();
}

function deleteDriverImage(orderId, imageType, imageId) {
    if (confirm('Haluatko varmasti poistaa tämän kuvan?')) {
        fetch(`/driver/order/${orderId}/image/${imageType}/${imageId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Kuvan poistaminen epäonnistui: ' + (data.error || 'Tuntematon virhe'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Kuvan poistaminen epäonnistui');
        });
    }
}
</script>