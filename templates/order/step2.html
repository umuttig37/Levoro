{% extends "order/wizard_base.html" %}

{% block title %}Toimitus - Uusi tilaus{% endblock %}
{% block page_title %}Auton toimitus{% endblock %}
{% block page_subtitle %}Minne auto toimitetaan?{% endblock %}

{% block content %}
<form method="POST" class="space-y-6">
    <!-- Hidden fields for route calculation -->
    <input type="hidden" id="from_step" value="{{ pickup_address }}">
    <input type="hidden" id="pickup_date_step2" value="{{ pickup_date }}">
    <input type="hidden" id="saved_dropoff_phone" name="saved_dropoff_phone" value="{{ saved_phone }}">

    <!-- Delivery Address -->
    <div class="space-y-2 animate-fade-in-1 opacity-0">
        <label for="to_step" class="block text-xs font-semibold uppercase tracking-wider text-slate-500 pl-1">
            Toimitusosoite *
        </label>
        <div class="input-group relative">
            <span class="input-icon material-symbols-outlined text-lg text-primary">location_on</span>
            <input 
                type="text" 
                id="to_step" 
                name="dropoff" 
                required 
                value="{{ dropoff_value }}"
                placeholder="Esim. Hämeenkatu 1, Tampere"
                title="Syötä toimitusosoite"
                class="wizard-input"
                autocomplete="off" 
                autocorrect="off"
                spellcheck="false"
            >
            <input type="hidden" id="dropoff_place_id" name="dropoff_place_id" value="{{ dropoff_place_id }}">
            <div id="ac_to_step" class="ac-list" role="listbox" aria-label="Osoite-ehdotukset"></div>
        </div>
    </div>

    <!-- Date and Time -->
    <div class="datetime-grid animate-fade-in-2 opacity-0">
        <div class="space-y-2">
            <label for="last_delivery_date" class="block text-xs font-semibold uppercase tracking-wider text-slate-500 pl-1">
                Toimituspäivä *
            </label>
            <div class="datetime-input relative">
                <span class="input-icon material-symbols-outlined text-lg">calendar_today</span>
                <input 
                    type="date" 
                    id="last_delivery_date" 
                    name="last_delivery_date" 
                    required 
                    value="{{ delivery_date }}"
                    title="Valitse toimituspäivä"
                >
            </div>
        </div>
        <div class="space-y-2">
            <label for="delivery_time" class="block text-xs font-semibold uppercase tracking-wider text-slate-500 pl-1">
                Toimitusaika <span class="text-slate-400 font-normal normal-case">(valinnainen)</span>
            </label>
            <div class="datetime-input relative">
                <span class="input-icon material-symbols-outlined text-lg">schedule</span>
                <input 
                    type="time" 
                    id="delivery_time" 
                    name="delivery_time" 
                    value="{{ delivery_time }}"
                    title="Valitse toimitusaika"
                >
            </div>
        </div>
    </div>

    <!-- Saved Addresses -->
    {% if current_user %}
    <div class="space-y-2 animate-fade-in-3 opacity-0">
        <button type="button" onclick="toggleSavedAddresses()" class="saved-addresses-toggle" id="savedAddressesBtn">
            <span class="flex items-center gap-2 text-sm text-slate-600">
                <span class="material-symbols-outlined text-primary text-lg icon-filled">bookmark</span>
                Tallennetut osoitteet
            </span>
            <div class="flex items-center gap-2">
                <button type="button" onclick="event.stopPropagation(); openAddressModal();" class="text-xs font-semibold text-primary hover:text-blue-700 transition-colors">
                    + Lisää
                </button>
                <span id="savedAddressesChevron" class="material-symbols-outlined text-slate-400 text-lg toggle-icon">expand_more</span>
            </div>
        </button>
        <div id="savedAddressesContainer" class="saved-addresses-content">
            <div id="addressesContainer" class="max-h-48 overflow-y-auto space-y-2"></div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="flex gap-4 pt-4 animate-fade-in-4 opacity-0">
        <button type="submit" name="action" value="back" class="btn-secondary px-6 py-4 border border-slate-200 rounded-xl text-slate-600 font-semibold hover:bg-slate-50 hover:border-slate-300 flex items-center gap-2">
            <span class="material-symbols-outlined">arrow_back</span>
            Takaisin
        </button>
        <button type="submit" name="action" value="continue" class="btn-gradient flex-1 inline-flex justify-center items-center rounded-xl from-brand-gradient-start to-brand-gradient-end px-6 py-4 text-base font-bold text-white shadow-lg shadow-blue-500/30 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Jatka
            <span class="material-symbols-outlined ml-2">arrow_forward</span>
        </button>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
// Saved Addresses Logic
const STORAGE_KEY = 'levoro.savedAddresses.v1';
window.savedAddresses = [];

async function apiCall(url, options = {}) {
    const res = await fetch(url, options);
    let data = null;
    try { data = await res.json(); } catch {}
    if (!res.ok) throw new Error((data && (data.error || data.message)) || ('HTTP ' + res.status));
    return data;
}

async function fetchServerAddresses() {
    const data = await apiCall('/api/saved_addresses', { method: 'GET' });
    return Array.isArray(data.items) ? data.items : [];
}

async function createServerAddress(displayName, fullAddress, phone) {
    const payload = { displayName, fullAddress };
    if (phone) payload.phone = phone;
    const data = await apiCall('/api/saved_addresses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    return data.item;
}

async function deleteServerAddress(id) {
    await apiCall(`/api/saved_addresses/${encodeURIComponent(id)}`, { method: 'DELETE' });
}

function applySavedPhoneToStep2(phone) {
    const hidden = document.getElementById('saved_dropoff_phone');
    if (hidden) hidden.value = (phone || '').trim();
}

function renderAddresses() {
    const container = document.getElementById('addressesContainer');
    if (!container) return;
    const list = window.savedAddresses || [];
    
    if (!list.length) {
        container.innerHTML = '<p class="text-slate-400 text-center text-sm py-4">Ei vielä tallennettuja osoitteita.</p>';
        return;
    }
    
    container.innerHTML = list.map((a, i) => `
        <div class="flex items-start justify-between p-3 bg-white border border-slate-200 rounded-lg hover:border-primary/50 transition-colors cursor-pointer group" onclick="useAddress('${a.id}')">
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-slate-900 text-sm">${a.displayName}</div>
                <div class="text-slate-500 text-sm truncate">${a.fullAddress}</div>
                ${a.phone ? `<div class="text-slate-400 text-xs mt-1">Puhelin: ${a.phone}</div>` : ''}
            </div>
            <button type="button" onclick="event.stopPropagation(); deleteAddressDirectly(${i});" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors">
                <span class="material-symbols-outlined text-lg">delete</span>
            </button>
        </div>
    `).join('');
}

function toggleSavedAddresses() {
    const container = document.getElementById('savedAddressesContainer');
    const icon = document.getElementById('savedAddressesChevron');
    if (!container) return;
    
    const isOpen = container.classList.contains('open');
    container.classList.toggle('open');
    if (icon) icon.style.transform = isOpen ? '' : 'rotate(180deg)';
}

function useAddress(id) {
    const addr = (window.savedAddresses || []).find(x => String(x.id) === String(id));
    if (!addr) return;
    const input = document.getElementById('to_step');
    if (input) {
        input.value = addr.fullAddress;
        input.dispatchEvent(new Event('change'));
    }
    applySavedPhoneToStep2(addr.phone || '');
}

async function deleteAddressDirectly(index) {
    const item = (window.savedAddresses || [])[index];
    if (!item) return;
    try { if (item.id) await deleteServerAddress(item.id); } catch(e) {}
    window.savedAddresses.splice(index, 1);
    renderAddresses();
}

function openAddressModal() {
    const html = `
    <div id="addressModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold text-slate-900 mb-4">Lisää uusi osoite</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nimi *</label>
                    <input id="addrName" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none" placeholder="Esim. Koti, Toimisto">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Osoite *</label>
                    <input id="addrFull" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none" placeholder="Esim. Mannerheimintie 1, Helsinki">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Puhelinnumero <span class="text-slate-400 font-normal">(valinnainen)</span></label>
                    <input id="addrPhone" type="tel" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none" placeholder="+358...">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeAddressModal()" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-slate-50 transition-colors">Peruuta</button>
                <button type="button" onclick="saveAddress()" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors">Tallenna</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.getElementById('addrName').focus();
}

function closeAddressModal() {
    const m = document.getElementById('addressModal');
    if (m) m.remove();
}

async function saveAddress() {
    const name = document.getElementById('addrName').value.trim();
    const addr = document.getElementById('addrFull').value.trim();
    const phoneInput = document.getElementById('addrPhone');
    const phone = phoneInput ? phoneInput.value.trim() : '';
    
    if (!name || !addr) {
        alert('Täytä molemmat kentät');
        return;
    }
    
    if (phone && !/^[+]?[0-9\s\-()]+$/.test(phone)) {
        alert('Syötä vain numeroita ja merkit +, -, ( )');
        return;
    }
    
    let created = null;
    try { created = await createServerAddress(name, addr, phone); } catch(e) {}
    const item = created || { id: Date.now(), displayName: name, fullAddress: addr, phone };
    window.savedAddresses.push(item);
    renderAddresses();
    closeAddressModal();
}

async function loadSavedAddresses() {
    try {
        const server = await fetchServerAddresses();
        if (Array.isArray(server)) {
            window.savedAddresses = server;
            renderAddresses();
        }
    } catch(e) {}
}

// Google Places Autocomplete
class WizardAutocomplete {
    constructor(input, listEl, placeIdInput) {
        this.input = input;
        this.list = listEl;
        this.placeIdInput = placeIdInput;
        this.timer = null;
        this.items = [];
        this.cache = new Map();
        this.isRequestInProgress = false;

        input.setAttribute('autocomplete', 'off');
        input.addEventListener('input', () => this.onInput());
        input.addEventListener('focus', () => this.onFocus());
        input.addEventListener('keydown', (e) => this.onKey(e));
        document.addEventListener('mousedown', (e) => {
            if (!e.target.closest('#' + this.list.id) && e.target !== this.input) {
                this.hide();
            }
        });
        this.list.addEventListener('mousedown', (e) => {
            const el = e.target.closest('.ac-item');
            if (!el) return;
            e.preventDefault();
            const type = el.getAttribute('data-type');
            if (type === 'saved') {
                this.pickSaved(el.getAttribute('data-id'));
            } else {
                this.pick(+el.getAttribute('data-i'));
            }
        });
    }

    onFocus() {
        if (!this.input.value.trim()) this.showSavedAddresses();
    }

    onInput() {
        clearTimeout(this.timer);
        if (this.placeIdInput) this.placeIdInput.value = '';
        applySavedPhoneToStep2('');
        const q = this.input.value.trim();
        if (!q) { this.showSavedAddresses(); return; }

        const cached = this.cache.get(q.toLowerCase());
        if (cached && (Date.now() - cached.timestamp < 300000)) {
            this.items = cached.results;
            this.render();
            return;
        }

        this.timer = setTimeout(() => {
            if (this.isRequestInProgress) return;
            this.showLoading();
            this.fetch(q);
        }, 400);
    }

    showLoading() {
        this.list.innerHTML = '<div class="ac-loading"><div class="spinner"></div>Haetaan osoitteita...</div>';
        this.list.style.display = 'block';
    }

    async fetch(q) {
        this.isRequestInProgress = true;
        try {
            const response = await fetch('/api/places_autocomplete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: q })
            });
            if (!response.ok) throw new Error();
            const data = await response.json();
            this.items = data.predictions || [];
            this.cache.set(q.toLowerCase(), { results: this.items, timestamp: Date.now() });
            this.render();
        } catch(e) {
            this.items = [];
            this.list.innerHTML = '<div class="ac-error p-3 text-red-500 text-sm">Osoitetta ei löytynyt</div>';
        } finally {
            this.isRequestInProgress = false;
        }
    }

    render() {
        const q = this.input.value.trim().toLowerCase();
        let html = '';

        const filteredSaved = window.savedAddresses?.filter(a =>
            a.displayName?.toLowerCase().includes(q) || a.fullAddress?.toLowerCase().includes(q)
        ).slice(0, 3) || [];

        if (filteredSaved.length) {
            html += '<div class="px-3 py-2 text-xs font-semibold text-slate-500 bg-slate-50 border-b">Tallennetut osoitteet</div>';
            html += filteredSaved.map(a => `
                <div class="ac-item saved-address" data-type="saved" data-id="${a.id}">
                    <div class="font-semibold text-slate-900">${a.displayName}</div>
                    <div class="text-sm text-slate-500">${a.fullAddress}</div>
                </div>
            `).join('');
        }

        if (this.items.length) {
            if (filteredSaved.length) {
                html += '<div class="px-3 py-2 text-xs font-semibold text-slate-500 bg-slate-50 border-b border-t">Karttahaku</div>';
            }
            html += this.items.slice(0, 6).map((item, i) => `
                <div class="ac-item" data-type="map" data-i="${i}">${item.description}</div>
            `).join('');
        }

        if (!html) {
            this.list.innerHTML = '<div class="p-3 text-slate-400 text-sm">Ei ehdotuksia</div>';
        } else {
            this.list.innerHTML = html;
        }
        this.show();
    }

    showSavedAddresses() {
        if (!window.savedAddresses?.length) return;
        let html = '<div class="px-3 py-2 text-xs font-semibold text-slate-500 bg-slate-50 border-b">Tallennetut osoitteet</div>';
        html += window.savedAddresses.slice(0, 6).map(a => `
            <div class="ac-item saved-address" data-type="saved" data-id="${a.id}">
                <div class="font-semibold text-slate-900">${a.displayName}</div>
                <div class="text-sm text-slate-500">${a.fullAddress}</div>
            </div>
        `).join('');
        this.list.innerHTML = html;
        this.show();
    }

    pickSaved(id) {
        const addr = window.savedAddresses?.find(a => String(a.id) === String(id));
        if (!addr) return;
        this.input.value = addr.fullAddress;
        if (this.placeIdInput) this.placeIdInput.value = '';
        applySavedPhoneToStep2(addr.phone || '');
        this.hide();
    }

    pick(i) {
        const item = this.items[i];
        if (!item) return;
        this.input.value = item.description;
        if (this.placeIdInput) this.placeIdInput.value = item.place_id || '';
        applySavedPhoneToStep2('');
        this.hide();
    }

    onKey(e) {
        if (this.list.style.display !== 'block') return;
        if (e.key === 'Escape') this.hide();
    }

    show() { this.list.style.display = 'block'; }
    hide() { this.list.style.display = 'none'; }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadSavedAddresses();
    
    new WizardAutocomplete(
        document.getElementById('to_step'),
        document.getElementById('ac_to_step'),
        document.getElementById('dropoff_place_id')
    );

    // Date validation
    const pickupDateStep2 = document.getElementById('pickup_date_step2');
    const deliveryDate = document.getElementById('last_delivery_date');
    
    if (deliveryDate) {
        const today = new Date().toISOString().split('T')[0];
        const minDate = pickupDateStep2?.value || today;
        deliveryDate.min = minDate;
        if (!deliveryDate.value || deliveryDate.value < minDate) {
            deliveryDate.value = minDate;
        }
    }
});
</script>
{% endblock %}
