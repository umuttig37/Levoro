{% extends "order/wizard_base.html" %}

{% block title %}Vahvista tilaus{% endblock %}
{% block page_title %}Vahvista tilaus{% endblock %}
{% block page_subtitle %}Tarkista tiedot ja lähetä tilaus{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
    .trip-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        transition: all 0.2s;
    }

    .trip-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    .trip-card--return {
        border-color: #fde68a;
    }

    .route-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .route-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 1.5rem;
        bottom: 1.5rem;
        width: 2px;
        background: linear-gradient(to bottom, #3b82f6, #10b981);
        border-radius: 1px;
    }

    .trip-card--return .route-timeline::before {
        background: linear-gradient(to bottom, #f59e0b, #10b981);
    }

    .route-point {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .route-point:last-child {
        padding-bottom: 0;
    }

    .route-marker {
        position: absolute;
        left: -1.5rem;
        top: 0.25rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .route-point--end .route-marker {
        background: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
    }

    .trip-card--return .route-marker {
        background: #f59e0b;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
    }

    .trip-card--return .route-point--end .route-marker {
        background: #10b981;
    }

    .confirmation-map {
        height: 200px;
        border-radius: 0.75rem;
        overflow: hidden;
        background: #f1f5f9;
    }

    .distance-label {
        background: transparent;
        border: none;
    }

    .distance-text {
        background: rgba(59, 130, 246, 0.95);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        white-space: nowrap;
    }

    .price-highlight {
        background: linear-gradient(135deg, #f8fafc, #fff);
    }

    @media (max-width: 1024px) {
        .confirm-grid-custom {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 1025px) {
        .confirm-grid-custom {
            grid-template-columns: 1fr 380px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="grid gap-6 confirm-grid-custom animate-fade-in opacity-0">
    <!-- Left Column: Order Details -->
    <div class="space-y-4">
        <!-- Outbound Trip Card -->
        <div class="trip-card animate-fade-in-1 opacity-0">
            <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-lg">directions_car</span>
                    </div>
                    <span class="font-semibold text-slate-900">{{ 'Menomatka' if paluu_auto else 'Kuljetus' }}</span>
                </div>
                <span class="text-sm font-medium text-slate-500">{{ "%.1f"|format(km) }} km</span>
            </div>
            <div class="p-5">
                <div class="route-timeline">
                    <div class="route-point">
                        <div class="route-marker"></div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-slate-400 mb-1">Nouto</div>
                        <div class="font-medium text-slate-900">{{ pickup_address }}</div>
                        {% if pickup_date_display %}
                        <div class="text-sm text-slate-500 mt-1">{{ pickup_date_display }}</div>
                        {% endif %}
                    </div>
                    <div class="route-point route-point--end">
                        <div class="route-marker"></div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-slate-400 mb-1">Toimitus</div>
                        <div class="font-medium text-slate-900">{{ dropoff_address }}</div>
                        {% if delivery_date_display %}
                        <div class="text-sm text-slate-500 mt-1">{{ delivery_date_display }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="flex gap-6 px-5 py-3 bg-slate-50/50 border-t border-slate-100">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide">Rekisterinumero</div>
                    <div class="font-semibold text-slate-900">{{ reg_number }}</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide">Talvirenkaat</div>
                    <div class="font-semibold text-slate-900">{{ 'Kyllä' if winter_tires else 'Ei' }}</div>
                </div>
            </div>
        </div>

        <!-- Return Trip Card (if applicable) -->
        {% if paluu_auto %}
        <div class="trip-card trip-card--return">
            <div class="flex items-center justify-between px-5 py-4 bg-amber-50/50 border-b border-amber-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-amber-600 text-lg">sync</span>
                    </div>
                    <span class="font-semibold text-amber-900">Paluumatka</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="bg-orange-500 text-white text-xs font-bold px-2.5 py-1 rounded-md">-30%</span>
                    <span class="text-sm font-medium text-amber-700">{{ "%.1f"|format(return_km) }} km</span>
                </div>
            </div>
            <div class="p-5">
                <div class="route-timeline">
                    <div class="route-point">
                        <div class="route-marker"></div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-amber-500 mb-1">Nouto</div>
                        <div class="font-medium text-slate-900">{{ dropoff_address }}</div>
                        {% if return_pickup_display %}
                        <div class="text-sm text-slate-500 mt-1">{{ return_pickup_display }}</div>
                        {% endif %}
                    </div>
                    <div class="route-point route-point--end">
                        <div class="route-marker"></div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-amber-500 mb-1">Toimitus</div>
                        <div class="font-medium text-slate-900">{{ pickup_address }}</div>
                        {% if return_delivery_display %}
                        <div class="text-sm text-slate-500 mt-1">{{ return_delivery_display }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="flex gap-6 px-5 py-3 bg-amber-50/30 border-t border-amber-100">
                <div>
                    <div class="text-xs text-amber-600 uppercase tracking-wide">Rekisterinumero</div>
                    <div class="font-semibold text-slate-900">{{ return_reg_number or 'Ei asetettu' }}</div>
                </div>
                <div>
                    <div class="text-xs text-amber-600 uppercase tracking-wide">Talvirenkaat</div>
                    <div class="font-semibold text-slate-900">{{ 'Kyllä' if return_winter_tires else 'Ei' }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Contact Info -->
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-5">
            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-4">Yhteystiedot</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-1">Tilaaja</div>
                    <div class="font-semibold text-slate-900">{{ orderer_name }}</div>
                    <div class="text-sm text-slate-500">{{ orderer_email }}</div>
                    <div class="text-sm text-slate-500">{{ orderer_phone }}</div>
                </div>
                {% if customer_name or customer_phone %}
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-1">Asiakas</div>
                    {% if customer_name %}<div class="font-semibold text-slate-900">{{ customer_name }}</div>{% endif %}
                    {% if customer_phone %}<div class="text-sm text-slate-500">{{ customer_phone }}</div>{% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Additional Info -->
        {% if additional_info %}
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-5">
            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-3">Lisätiedot</h3>
            <p class="text-slate-600 whitespace-pre-wrap">{{ additional_info }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Map & Pricing -->
    <div class="space-y-4">
        <!-- Map -->
        <div class="bg-white border border-slate-200 rounded-xl p-4">
            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider mb-3">Reitti</h3>
            <div id="confirmation_map" class="confirmation-map"></div>
        </div>

        <!-- Pricing Card -->
        <div class="bg-white border border-slate-200 rounded-xl p-5 price-highlight sticky top-4">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Yhteenveto</div>

            <!-- Price Breakdown -->
            <div class="bg-slate-50 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200">
                    <div>
                        <div class="font-semibold text-slate-900">{{ 'Menomatka' if paluu_auto else 'Kuljetus' }}</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(km) }} km</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-900">{{ "%.2f"|format(net) }} €</div>
                        {% if outbound_original_net and outbound_original_net > net + 0.01 %}
                        <div class="text-sm text-slate-400 line-through">{{ "%.2f"|format(outbound_original_net) }} €
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if paluu_auto %}
                <div class="flex justify-between items-center pb-3 border-b border-slate-200">
                    <div>
                        <div class="font-semibold text-slate-900">Paluumatka</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(return_km) }} km</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-900">{{ "%.2f"|format(return_net) }} €</div>
                        {% if return_original_net and return_original_net > return_net + 0.01 %}
                        <div class="text-sm text-slate-400 line-through">{{ "%.2f"|format(return_original_net) }} €
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Total -->
            <div class="text-center py-5">
                <div
                    class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-semibold mb-2">
                    {{ "%.1f"|format(total_km) }} km yhteensä
                </div>
                <div class="text-4xl font-extrabold text-slate-900">{{ "%.2f"|format(total_net) }} €</div>
                {% if total_original_net and total_original_net > total_net + 0.01 %}
                <div class="text-lg text-slate-400 line-through">{{ "%.2f"|format(total_original_net) }} €</div>
                {% endif %}
                <div class="text-sm text-slate-500 mt-2">
                    ALV 25,5%: {{ "%.2f"|format(total_vat) }} € • Sis. ALV: {{ "%.2f"|format(total_gross) }} €
                </div>
            </div>

            <!-- Discount Summary -->
            {% if total_discount_amount > 0 %}
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 mt-4">
                <div class="flex justify-between items-center font-bold text-green-700">
                    <span>Säästät yhteensä</span>
                    <span>-{{ "%.2f"|format(total_discount_amount) }} €</span>
                </div>
            </div>
            {% endif %}

            <!-- Error Message -->
            {% if pricing_error %}
            <div class="bg-red-50 border border-red-200 rounded-xl p-4 mt-4 text-sm text-red-700">
                {{ pricing_error }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Terms and Submit -->
<form method="POST" class="mt-6" id="orderConfirmForm">
    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-6">
        <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="termsCheckbox" required class="w-5 h-5 mt-0.5 accent-blue-600 cursor-pointer">
            <span class="text-sm text-slate-600">
                Hyväksyn <a href="/ehdot" target="_blank"
                    class="text-primary underline hover:no-underline">käyttöehdot</a> ja
                <a href="/tietosuoja" target="_blank"
                    class="text-primary underline hover:no-underline">tietosuojakäytännön</a>.
                Ymmärrän, että tilaus on sitova vahvistuksen jälkeen.
            </span>
        </label>
    </div>

    <div class="flex gap-4">
        <a href="/order/new/step5"
            class="btn-secondary px-6 py-4 border border-slate-200 rounded-xl text-slate-600 font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined">arrow_back</span>
            Takaisin
        </a>
        <button type="submit"
            class="btn-gradient flex-1 inline-flex justify-center items-center rounded-xl from-secondary to-emerald-600 px-6 py-4 text-base font-bold text-white shadow-lg shadow-emerald-500/30 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            id="submitOrderBtn" {{ 'disabled' if pricing_error else '' }}>
            <span class="btn-text">Vahvista ja lähetä tilaus</span>
            <span class="btn-spinner hidden items-center gap-2">
                <svg class="animate-spin" viewBox="0 0 24 24" width="20" height="20">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none"
                        stroke-dasharray="31.4 31.4" stroke-linecap="round"></circle>
                </svg>
                Lähetetään...
            </span>
            <span class="material-symbols-outlined ml-2 btn-text">check_circle</span>
        </button>
    </div>

    {% if pricing_error %}
    <p class="text-center text-sm text-red-500 mt-4">Hinnanlaskenta epäonnistui, joten tilausta ei voi lähettää. Yritä
        myöhemmin uudelleen.</p>
    {% endif %}
</form>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    // Form submission handling
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('orderConfirmForm');
        const submitBtn = document.getElementById('submitOrderBtn');
        const termsCheckbox = document.getElementById('termsCheckbox');

        if (form && submitBtn) {
            form.addEventListener('submit', function (e) {
                if (!termsCheckbox.checked) {
                    e.preventDefault();
                    termsCheckbox.focus();
                    return;
                }

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.querySelectorAll('.btn-text').forEach(el => el.classList.add('hidden'));
                submitBtn.querySelector('.btn-spinner').classList.remove('hidden');
                submitBtn.querySelector('.btn-spinner').classList.add('inline-flex');
            });
        }

        // Initialize map
        initConfirmationMap();
    });

    function initConfirmationMap() {
        const mapEl = document.getElementById('confirmation_map');
        if (!mapEl) return;

        const map = L.map('confirmation_map', {
            zoomControl: false,
            dragging: false,
            touchZoom: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        map.setView([61.9241, 25.7482], 5);

        // Fetch route
        const pickup = '{{ pickup_address }}';
        const dropoff = '{{ dropoff_address }}';
        const pickupPlaceId = '{{ pickup_place_id or "" }}';
        const dropoffPlaceId = '{{ dropoff_place_id or "" }}';

        fetch('/api/route_geo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pickup: pickup,
                dropoff: dropoff,
                pickup_place_id: pickupPlaceId,
                dropoff_place_id: dropoffPlaceId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.latlngs && data.start && data.end) {
                    const polyline = L.polyline(data.latlngs, { weight: 4, opacity: 0.8, color: '#3b82f6' }).addTo(map);
                    L.marker([data.start[0], data.start[1]]).addTo(map);
                    L.marker([data.end[0], data.end[1]]).addTo(map);
                    map.fitBounds(polyline.getBounds(), { padding: [20, 20] });

                    // Add distance label
                    const center = polyline.getBounds().getCenter();
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'distance-label',
                            html: '<div class="distance-text">{{ "%.1f"|format(total_km) }} km</div>',
                            iconSize: [100, 35],
                            iconAnchor: [50, 17]
                        }),
                        zIndexOffset: 1000
                    }).addTo(map);
                }
            })
            .catch(err => console.error('Map error:', err));
    }
</script>
{% endblock %}