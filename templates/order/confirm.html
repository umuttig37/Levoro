{% extends "order/wizard_base.html" %}

{% block title %}Vahvista tilaus{% endblock %}
{% block page_title %}Vahvista tilaus{% endblock %}
{% block page_subtitle %}Tarkista tiedot ja lähetä tilaus{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<style>
    .trip-card {
        background: white;
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        transition: all 0.2s;
    }

    .trip-card:hover {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    .trip-card--return {
        border-color: #fde68a;
    }

    .route-timeline {
        position: relative;
    }

    .route-timeline::before {
        content: '';
        position: absolute;
        left: 5px;
        top: 18px;
        bottom: 18px;
        width: 2px;
        background: linear-gradient(to bottom, #3b82f6, #10b981);
    }

    .trip-card--return .route-timeline::before {
        background: linear-gradient(to bottom, #f59e0b, #10b981);
    }

    .route-point {
        display: flex;
        gap: 12px;
        padding-bottom: 16px;
    }

    .route-point:last-child {
        padding-bottom: 0;
    }

    .route-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 3px;
        position: relative;
        z-index: 1;
    }

    .route-marker--start {
        background: #3b82f6;
    }

    .route-marker--end {
        background: #10b981;
    }

    .trip-card--return .route-marker--start {
        background: #f59e0b;
    }

    .route-point-content {
        flex: 1;
        min-width: 0;
    }

    .confirmation-map {
        height: 200px;
        border-radius: 0.75rem;
        overflow: hidden;
        background: #f1f5f9;
    }

    .confirmation-map .leaflet-control-attribution {
        display: none;
    }

    .distance-label {
        background: transparent;
        border: none;
    }

    .distance-text {
        background: rgba(59, 130, 246, 0.95);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 1.5rem;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        white-space: nowrap;
    }

    .price-highlight {
        background: linear-gradient(135deg, #f8fafc, #fff);
    }

    @media (max-width: 1024px) {
        .confirm-grid-custom {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 1025px) {
        .confirm-grid-custom {
            grid-template-columns: 1fr 380px;
        }
    }

    /* Checkbox animation */
    input[type="checkbox"] {
        transition: transform 0.15s ease-in-out;
    }

    input[type="checkbox"]:checked {
        animation: checkPop 0.2s ease-out;
    }

    @keyframes checkPop {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.15);
        }

        100% {
            transform: scale(1);
        }
    }

    /* Section styling */
    .section-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid gap-6 confirm-grid-custom">
    <!-- Left Column: Order Details -->
    <div class="space-y-5">
        <!-- Outbound Trip Card -->
        <div class="trip-card">
            <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-blue-100 flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-600">directions_car</span>
                    </div>
                    <div>
                        <div class="font-bold text-slate-900">{{ 'Menomatka' if paluu_auto else 'Kuljetus' }}</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(km) }} km</div>
                    </div>
                </div>
            </div>

            <div class="p-5">
                <div class="route-timeline">
                    <div class="route-point">
                        <div class="route-marker route-marker--start"></div>
                        <div class="route-point-content">
                            <div class="text-xs font-semibold uppercase tracking-wider text-blue-600 mb-1">Nouto</div>
                            <div class="font-medium text-slate-900">{{ pickup_address }}</div>
                            {% if pickup_date_display %}
                            <div class="text-sm text-slate-500 mt-1">{{ pickup_date_display }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="route-point">
                        <div class="route-marker route-marker--end"></div>
                        <div class="route-point-content">
                            <div class="text-xs font-semibold uppercase tracking-wider text-emerald-600 mb-1">Toimitus
                            </div>
                            <div class="font-medium text-slate-900">{{ dropoff_address }}</div>
                            {% if delivery_date_display %}
                            <div class="text-sm text-slate-500 mt-1">{{ delivery_date_display }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 px-5 py-4 bg-slate-50 border-t border-slate-100">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-0.5">Rekisterinumero</div>
                    <div class="font-bold text-slate-900 text-lg">{{ reg_number }}</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-0.5">Talvirenkaat</div>
                    <div class="font-semibold text-slate-900">{{ 'Kyllä' if winter_tires else 'Ei' }}</div>
                </div>
            </div>
        </div>

        <!-- Return Trip Card (if applicable) -->
        {% if paluu_auto %}
        <div class="trip-card trip-card--return">
            <div class="flex items-center justify-between px-5 py-4 bg-slate-50 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-orange-50 flex items-center justify-center">
                        <span class="material-symbols-outlined text-orange-600">sync</span>
                    </div>
                    <div>
                        <div class="font-bold text-slate-900">Paluumatka</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(return_km) }} km</div>
                    </div>
                </div>
                <span
                    class="bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm">-30%
                    Alennus</span>
            </div>

            <div class="p-5">
                <div class="route-timeline">
                    <div class="route-point">
                        <div class="route-marker route-marker--start"></div>
                        <div class="route-point-content">
                            <div class="text-xs font-semibold uppercase tracking-wider text-amber-600 mb-1">Nouto</div>
                            <div class="font-medium text-slate-900">{{ dropoff_address }}</div>
                            {% if return_pickup_display %}
                            <div class="text-sm text-slate-500 mt-1">{{ return_pickup_display }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="route-point">
                        <div class="route-marker route-marker--end"></div>
                        <div class="route-point-content">
                            <div class="text-xs font-semibold uppercase tracking-wider text-emerald-600 mb-1">Toimitus
                            </div>
                            <div class="font-medium text-slate-900">{{ pickup_address }}</div>
                            {% if return_delivery_display %}
                            <div class="text-sm text-slate-500 mt-1">{{ return_delivery_display }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 px-5 py-4 bg-slate-50 border-t border-slate-100">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-0.5">Rekisterinumero</div>
                    <div class="font-bold text-slate-900 text-lg">{{ return_reg_number or 'Ei asetettu' }}</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-0.5">Talvirenkaat</div>
                    <div class="font-semibold text-slate-900">{{ 'Kyllä' if return_winter_tires else 'Ei' }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Contact Info -->
        <div class="section-card">
            <h3 class="section-title">Yhteystiedot</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-2">Tilaaja</div>
                    <div class="font-bold text-slate-900 text-lg">{{ orderer_name }}</div>
                    <div class="text-slate-600 mt-1">{{ orderer_email }}</div>
                    <div class="text-slate-600">{{ orderer_phone }}</div>
                </div>
                {% if customer_name or customer_phone %}
                <div>
                    <div class="text-xs text-amber-600 uppercase tracking-wide mb-2">Asiakas (vastaanottaja)</div>
                    {% if customer_name %}<div class="font-bold text-slate-900 text-lg">{{ customer_name }}</div>{%
                    endif %}
                    {% if customer_phone %}<div class="text-slate-600 mt-1">{{ customer_phone }}</div>{% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Direct to Customer Flag -->
        {% if direct_to_customer %}
        <div class="section-card border-2 border-blue-200">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0">
                    <span class="material-symbols-outlined text-blue-600">local_shipping</span>
                </div>
                <div>
                    <h3 class="font-bold text-slate-900 text-lg">Toimitus suoraan loppuasiakkaalle</h3>
                    <p class="text-sm text-slate-600 mt-1">
                        Tämä auto toimitetaan suoraan loppuasiakkaalle. Auto käsitellään erityisen huolellisesti.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Additional Info -->
        {% if additional_info %}
        <div class="section-card">
            <h3 class="section-title">Lisätiedot</h3>
            <p class="text-slate-700 whitespace-pre-wrap leading-relaxed">{{ additional_info }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Map & Pricing -->
    <div class="space-y-5">
        <!-- Map -->
        <div class="section-card">
            <h3 class="section-title">Reitti kartalla</h3>
            <div id="confirmation_map" class="confirmation-map"></div>
        </div>

        <!-- Pricing Card -->
        <div class="section-card price-highlight sticky top-32">
            <h3 class="section-title">Hinta</h3>

            <!-- Price Breakdown -->
            <div class="space-y-4">
                <div class="flex justify-between items-center py-3 border-b border-slate-200">
                    <div>
                        <div class="font-semibold text-slate-900">{{ 'Menomatka' if paluu_auto else 'Kuljetus' }}</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(km) }} km</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-900 text-lg">{{ "%.2f"|format(net) }} €</div>
                        {% if outbound_original_net and outbound_original_net > net + 0.01 %}
                        <div class="text-sm text-slate-400 line-through">{{ "%.2f"|format(outbound_original_net) }} €
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if paluu_auto %}
                <div class="flex justify-between items-center py-3 border-b border-slate-200">
                    <div>
                        <div class="font-semibold text-slate-900">Paluumatka</div>
                        <div class="text-sm text-slate-500">{{ "%.1f"|format(return_km) }} km</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-900 text-lg">{{ "%.2f"|format(return_net) }} €</div>
                        {% if return_original_net and return_original_net > return_net + 0.01 %}
                        <div class="text-sm text-slate-400 line-through">{{ "%.2f"|format(return_original_net) }} €
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Total -->
            <div class="text-center pt-6 pb-4">
                <div
                    class="inline-flex items-center gap-1.5 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm font-semibold mb-3">
                    {{ "%.1f"|format(total_km) }} km yhteensä
                </div>
                <div class="text-4xl font-extrabold text-slate-900 mb-1">{{ "%.2f"|format(total_net) }} €</div>
                {% if total_original_net and total_original_net > total_net + 0.01 %}
                <div class="text-lg text-slate-400 line-through mb-2">{{ "%.2f"|format(total_original_net) }} €</div>
                {% endif %}
                <div class="text-sm text-slate-500">
                    ALV 25,5%: {{ "%.2f"|format(total_vat) }} € • Sis. ALV: {{ "%.2f"|format(total_gross) }} €
                </div>
            </div>

            <!-- Discount Summary -->
            {% if total_discount_amount > 0 %}
            <div class="bg-green-50 border border-green-200 rounded-xl p-4 mt-4">
                <div class="flex justify-between items-center font-bold text-green-700">
                    <span>Säästät yhteensä</span>
                    <span class="text-lg">-{{ "%.2f"|format(total_discount_amount) }} €</span>
                </div>
            </div>
            {% endif %}

            <!-- Error Message -->
            {% if pricing_error %}
            <div class="bg-red-50 border border-red-200 rounded-xl p-4 mt-4 text-sm text-red-700">
                {{ pricing_error }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Terms and Submit -->
<form method="POST" class="mt-8" id="orderConfirmForm" novalidate>


    <div class="flex gap-4">
        <a href="/order/new/step5"
            class="btn-secondary px-6 py-4 border border-slate-200 rounded-xl text-slate-600 font-semibold hover:bg-slate-50 hover:border-slate-300 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined">arrow_back</span>
            Takaisin
        </a>
        <button type="submit"
            class="btn-gradient flex-1 inline-flex justify-center items-center rounded-xl from-secondary to-emerald-600 px-6 py-4 text-base font-bold text-white shadow-lg shadow-emerald-500/30 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            id="submitOrderBtn" {{ 'disabled' if pricing_error else '' }}>
            <span class="btn-text">Vahvista ja lähetä tilaus</span>
            <span class="btn-spinner hidden items-center gap-2">
                <svg class="animate-spin" viewBox="0 0 24 24" width="20" height="20">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none"
                        stroke-dasharray="31.4 31.4" stroke-linecap="round"></circle>
                </svg>
                Lähetetään...
            </span>
        </button>
    </div>

    {% if pricing_error %}
    <p class="text-center text-sm text-red-500 mt-4">Hinnanlaskenta epäonnistui, joten tilausta ei voi lähettää. Yritä
        myöhemmin uudelleen.</p>
    {% endif %}
</form>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    // Form submission handling
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('orderConfirmForm');
        const submitBtn = document.getElementById('submitOrderBtn');


        if (form && submitBtn) {
            form.addEventListener('submit', function (e) {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.querySelectorAll('.btn-text').forEach(el => el.classList.add('hidden'));
                submitBtn.querySelector('.btn-spinner').classList.remove('hidden');
                submitBtn.querySelector('.btn-spinner').classList.add('inline-flex');
            });
        }

        // Initialize map
        initConfirmationMap();
    });

    function initConfirmationMap() {
        const mapEl = document.getElementById('confirmation_map');
        if (!mapEl) return;

        const map = L.map('confirmation_map', {
            zoomControl: false,
            dragging: false,
            touchZoom: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        map.setView([61.9241, 25.7482], 5);

        // Fetch route
        const pickup = '{{ pickup_address }}';
        const dropoff = '{{ dropoff_address }}';
        const pickupPlaceId = '{{ pickup_place_id or "" }}';
        const dropoffPlaceId = '{{ dropoff_place_id or "" }}';

        fetch('/api/route_geo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pickup: pickup,
                dropoff: dropoff,
                pickup_place_id: pickupPlaceId,
                dropoff_place_id: dropoffPlaceId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.latlngs && data.start && data.end) {
                    const polyline = L.polyline(data.latlngs, { weight: 4, opacity: 0.8, color: '#3b82f6' }).addTo(map);

                    // Custom icons matching calculator page
                    const startIcon = L.divIcon({
                        className: 'bg-transparent',
                        html: `<div class="w-4 h-4 rounded-full bg-white border-4 border-blue-600 shadow-sm"></div>`,
                        iconSize: [16, 16], iconAnchor: [8, 8]
                    });
                    const endIcon = L.divIcon({
                        className: 'bg-transparent',
                        html: `<span class="material-symbols-outlined text-blue-600 text-3xl drop-shadow-md" style="font-variation-settings: 'FILL' 1;">location_on</span>`,
                        iconSize: [30, 30], iconAnchor: [15, 30]
                    });

                    L.marker([data.start[0], data.start[1]], { icon: startIcon }).addTo(map);
                    L.marker([data.end[0], data.end[1]], { icon: endIcon }).addTo(map);
                    map.fitBounds(polyline.getBounds(), { padding: [40, 40] });

                    // Add distance label
                    const center = polyline.getBounds().getCenter();
                    L.marker(center, {
                        icon: L.divIcon({
                            className: 'distance-label',
                            html: '<div class="distance-text">{{ "%.1f"|format(total_km) }} km</div>',
                            iconSize: [100, 35],
                            iconAnchor: [50, 17]
                        }),
                        zIndexOffset: 1000
                    }).addTo(map);
                }
            })
            .catch(err => console.error('Map error:', err));
    }
</script>
{% endblock %}