{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Admin – Tilaukset{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <h2>Admin – Tilaukset</h2>
    <div class="admin-actions">
      <a class="btn btn-ghost" href="/admin/users">Käyttäjät</a>
      <a class="btn btn-ghost" href="/admin/drivers">Kuljettajat</a>
      <a class="btn btn-ghost" href="/admin/driver-applications">Kuljettajahakemukset</a>
      <a class="btn btn-secondary" href="/logout">Kirjaudu ulos</a>
    </div>
  </div>

  <table class="admin-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Tila</th>
        <th>Näkyvyys</th>
        <th>Asiakas</th>
        <th>Kuljettaja</th>
        <th>Reitti</th>
        <th>Km</th>
        <th>Hinta (ALV 0%)</th>
        <th>Kuvat</th>
        <th>Hallinta</th>
      </tr>
    </thead>
    <tbody>
      {% if orders %}
      {% for order in orders %}
      {% set status_fi = {
      'NEW': 'Uusi',
      'CONFIRMED': 'Vahvistettu',
      'ASSIGNED_TO_DRIVER': 'Kuljettaja määritetty',
      'DRIVER_ARRIVED': 'Kuljettaja paikalla',
      'PICKUP_IMAGES_ADDED': 'Noutokuva lisätty',
      'IN_TRANSIT': 'Kuljetuksessa',
      'DELIVERY_ARRIVED': 'Toimitus paikalla',
      'DELIVERY_IMAGES_ADDED': 'Toimituskuva lisätty',
      'DELIVERED': 'Toimitettu',
      'CANCELLED': 'Peruutettu'
      }.get(order.status, order.status) %}

      {% set pickup_icon = "✓" if order.get('images', {}).get('pickup') else "-" %}
      {% set delivery_icon = "✓" if order.get('images', {}).get('delivery') else "-" %}

      {% set driver_info = "Ei kuljettajaa" %}
      {% if order.get('driver_name') %}
      {% set driver_info = order.get('driver_name', '?') %}
      {% elif order.get('status') in ['NEW', 'CONFIRMED'] %}
      {% set driver_info = "Odottaa" %}
      {% endif %}

      {% set is_visible = order.status in ['CONFIRMED', 'ASSIGNED_TO_DRIVER', 'DRIVER_ARRIVED', 'PICKUP_IMAGES_ADDED',
      'IN_TRANSIT', 'DELIVERY_ARRIVED', 'DELIVERY_IMAGES_ADDED'] and not order.get('driver_id') %}
      {% set visibility_icon = "Näkyvissä" if is_visible else ("Otettu" if order.get('driver_id') else "Ei julkaistu")
      %}
      {% set visibility_class = "visible" if is_visible else ("assigned" if order.get('driver_id') else "hidden") %}

      <tr class="admin-table-row">
        <td>
          <strong>#{{ order.id }}</strong>
          {% if order.trip_type %}
            <span class="trip-type-badge trip-type-{{ order.trip_type.lower() }}">{{ order.trip_type }}</span>
          {% endif %}
        </td>
        <td><span class="status {{ order.status }}">{{ status_fi }}</span></td>
        <td><span class="visibility-badge {{ visibility_class }}"
            title="{% if is_visible %}Kuljettajat voivat nähdä ja ottaa vastaan{% elif order.get('driver_id') %}Kuljettaja on ottanut keikan{% else %}Vahvista tilaus julkaistaksesi kuljettajille{% endif %}">{{
            visibility_icon }}</span></td>
        <td>
          <div>{{ order.get('customer_name', '?') }}</div>
          {% if order.get('customer_phone') %}<div class="admin-customer-phone">{{ order.get('customer_phone') }}</div>{% endif %}
        </td>
        <td>{{ driver_info }}</td>
        <td>{{ order.pickup_address }} → {{ order.dropoff_address }}</td>
        <td>{{ "%.1f"|format(order.distance_km|float) }} km</td>
        <td><strong class="admin-price-net">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</strong> <span
            class="admin-price-vat">ALV 0%</span></td>
        <td class="image-status">{{ pickup_icon }} {{ delivery_icon }}</td>
        <td class="admin-table-actions">
          <a href="/admin/order/{{ order.id }}" class="btn btn-primary admin-table-manage-btn">
            Hallinta
          </a>
        </td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
        <td colspan="9" class="muted">Ei tilauksia</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
