{% extends "base/layout.html" %}

{% block title %}Admin ‚Äì Tilaukset{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <h2>Admin ‚Äì Tilaukset</h2>
    <div class="admin-actions">
      <a class="btn btn-ghost" href="/admin/users">K√§ytt√§j√§t</a>
      <a class="btn btn-ghost" href="/admin/drivers">Kuljettajat</a>
      <a class="btn btn-ghost" href="/admin/driver-applications">Kuljettajahakemukset</a>
      <a class="btn btn-secondary" href="/logout">Kirjaudu ulos</a>
    </div>
  </div>

  <table class="admin-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Tila</th>
        <th>N√§kyvyys</th>
        <th>Asiakas</th>
        <th>Kuljettaja</th>
        <th>Reitti</th>
        <th>Km</th>
        <th>Hinta (ALV 0%)</th>
        <th>Kuvat</th>
        <th>P√§ivit√§</th>
      </tr>
    </thead>
    <tbody>
      {% if orders %}
        {% for order in orders %}
          {% set status_fi = {
            'NEW': 'Uusi',
            'CONFIRMED': 'Vahvistettu',
            'ASSIGNED_TO_DRIVER': 'Kuljettaja osoitettu',
            'DRIVER_ARRIVED': 'Kuljettaja paikalla',
            'PICKUP_IMAGES_ADDED': 'Noutokuva lis√§tty',
            'IN_TRANSIT': 'Kuljetuksessa',
            'DELIVERY_ARRIVED': 'Toimitus paikalla',
            'DELIVERY_IMAGES_ADDED': 'Toimituskuva lis√§tty',
            'DELIVERED': 'Toimitettu',
            'CANCELLED': 'Peruutettu'
          }.get(order.status, order.status) %}

          {% set pickup_icon = "üì∑" if order.get('images', {}).get('pickup') else "‚≠ï" %}
          {% set delivery_icon = "üì∑" if order.get('images', {}).get('delivery') else "‚≠ï" %}

          {% set driver_info = "Ei kuljettajaa" %}
          {% if order.get('driver_name') %}
            {% set driver_info = order.get('driver_name', '?') %}
          {% elif order.get('status') in ['NEW', 'CONFIRMED'] %}
            {% set driver_info = "Odottaa" %}
          {% endif %}

          {% set is_visible = order.status in ['CONFIRMED', 'ASSIGNED_TO_DRIVER', 'DRIVER_ARRIVED', 'PICKUP_IMAGES_ADDED', 'IN_TRANSIT', 'DELIVERY_ARRIVED', 'DELIVERY_IMAGES_ADDED'] and not order.get('driver_id') %}
          {% set visibility_icon = "üëÅÔ∏è N√§kyviss√§" if is_visible else ("üîí Otettu" if order.get('driver_id') else "‚è∏Ô∏è Ei julkaistu") %}
          {% set visibility_class = "visible" if is_visible else ("assigned" if order.get('driver_id') else "hidden") %}

          <tr class="admin-table-row" onclick="window.location.href='/admin/order/{{ order.id }}'" style="cursor: pointer;">
            <td><strong>#{{ order.id }}</strong></td>
            <td><span class="status {{ order.status }}">{{ status_fi }}</span></td>
            <td><span class="visibility-badge {{ visibility_class }}" title="{% if is_visible %}Kuljettajat voivat n√§hd√§ ja ottaa vastaan{% elif order.get('driver_id') %}Kuljettaja on ottanut keikan{% else %}Vahvista tilaus julkaistaksesi kuljettajille{% endif %}">{{ visibility_icon }}</span></td>
            <td>{{ order.get('customer_name', '?') }} &lt;{{ order.get('customer_email', '?') }}&gt;</td>
            <td>{{ driver_info }}</td>
            <td>{{ order.pickup_address }} ‚Üí {{ order.dropoff_address }}</td>
            <td>{{ "%.1f"|format(order.distance_km|float) }} km</td>
            <td><strong style="font-size: 1.1em;">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} ‚Ç¨</strong> <span style="font-size: 0.85em; opacity: 0.7;">+ ALV 0%</span></td>
            <td class="image-status">{{ pickup_icon }} {{ delivery_icon }}</td>
            <td onclick="event.stopPropagation();">
              <form method="POST" action="/admin/update" class="admin-inline-form">
                <input type="hidden" name="id" value="{{ order.id }}">
                <select name="status">
                  <option value="NEW" {% if order.status == 'NEW' %}selected{% endif %}>UUSI</option>
                  <option value="CONFIRMED" {% if order.status == 'CONFIRMED' %}selected{% endif %}>TEHT√ÑV√Ñ VAHVISTETTU</option>
                  <option value="ASSIGNED_TO_DRIVER" {% if order.status == 'ASSIGNED_TO_DRIVER' %}selected{% endif %}>M√Ñ√ÑRITETTY KULJETTAJALLE</option>
                  <option value="DRIVER_ARRIVED" {% if order.status == 'DRIVER_ARRIVED' %}selected{% endif %}>KULJETTAJA SAAPUNUT</option>
                  <option value="PICKUP_IMAGES_ADDED" {% if order.status == 'PICKUP_IMAGES_ADDED' %}selected{% endif %}>NOUTOKUVAT LIS√ÑTTY</option>
                  <option value="IN_TRANSIT" {% if order.status == 'IN_TRANSIT' %}selected{% endif %}>TOIMITUKSESSA</option>
                  <option value="DELIVERY_ARRIVED" {% if order.status == 'DELIVERY_ARRIVED' %}selected{% endif %}>KULJETUS SAAPUNUT</option>
                  <option value="DELIVERY_IMAGES_ADDED" {% if order.status == 'DELIVERY_IMAGES_ADDED' %}selected{% endif %}>TOIMITUSKUVAT LIS√ÑTTY</option>
                  <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>TOIMITETTU</option>
                  <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>PERUUTETTU</option>
                </select>
                <button type="submit">P√§ivit√§</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" class="muted">Ei tilauksia</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}