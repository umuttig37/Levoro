{% extends "base/layout.html" %}

{% block title %}Kuljettajien hallinta – Admin{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <h2>Kuljettajien hallinta</h2>
    <div class="admin-actions">
      <a class="btn btn-ghost" href="{{ url_for('main.admin_dashboard') }}">Takaisin tilauksiin</a>
      <a class="btn btn-ghost" href="{{ url_for('admin.users') }}">Käyttäjät</a>
      <a class="btn btn-secondary" href="{{ url_for('auth.logout') }}">Kirjaudu ulos</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{% if category == 'error' %}danger{% else %}{{ category }}{% endif %} mb-4">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Driver Statistics -->
  <div class="mb-6">
    <h3>Kuljettajat</h3>
    <table class="admin-table admin-users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nimi</th>
          <th>Sähköposti</th>
          <th>Tila</th>
          <th>Yhteensä</th>
          <th>Suoritettu</th>
          <th>Aktiivisia</th>
          <th>Luotu</th>
        </tr>
      </thead>
      <tbody>
        {% if drivers_performance %}
          {% for driver in drivers_performance %}
            {% set status_class = 'status-confirmed' if driver.get('status') == 'active' else 'status-new' %}
            {% set status_text = '✅ Aktiivinen' if driver.get('status') == 'active' else '⏳ Odottaa' %}
            <tr>
              <td>#{{ driver.id }}</td>
              <td>{{ driver.name }}</td>
              <td>{{ driver.email }}</td>
              <td><span class="status {{ status_class }}">{{ status_text }}</span></td>
              <td>{{ driver.total_jobs }}</td>
              <td>{{ driver.completed_jobs }}</td>
              <td>{{ driver.active_jobs }}</td>
              <td>{{ driver.created_at | helsinki_time if driver.created_at else '-' }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="muted">Ei kuljettajia</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Available Orders for Assignment -->
  <div>
    <h3>Saatavilla olevat tilaukset</h3>
    <p class="text-muted">Määritä kuljettaja saataville oleviin tilauksiin</p>
    <table class="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Reitti</th>
          <th>Matka</th>
          <th>Hinta</th>
          <th>Toiminnot</th>
        </tr>
      </thead>
      <tbody>
        {% if available_orders %}
          {% for order in available_orders %}
            <tr>
              <td>#{{ order.id }}</td>
              <td>{{ order.pickup_address }} → {{ order.dropoff_address }}</td>
              <td>{{ "%.1f"|format(order.distance_km) }} km</td>
              <td><strong style="font-size: 1.1em;">{{ "%.2f"|format(order.price_gross / 1.255) }} €</strong> <span style="font-size: 0.85em; opacity: 0.7;">+ ALV 0%</span></td>
              <td>
                <form method="POST" action="{{ url_for('admin.assign_driver') }}" style="display: inline;">
                  <input type="hidden" name="order_id" value="{{ order.id }}">
                  <select name="driver_id" required>
                    <option value="">Valitse kuljettaja</option>
                    {% for driver in drivers_performance %}
                      {% if driver.get('status') == 'active' %}
                        <option value="{{ driver.id }}">{{ driver.name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-sm">Määritä</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="muted">Ei saatavilla olevia tilauksia</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}