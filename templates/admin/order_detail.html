{% extends "base/layout.html" %}

{% block title %}Admin - Tilaus #{{ order.id }} ‚Äì Levoro{% endblock %}

{% block extra_css %}
<link rel='stylesheet' href='/static/css/admin-images.css'>
{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-order-detail">
        <div class="order-header">
            <h2>Tilaus #{{ order.id }} - {{ status_fi }}</h2>
            <a href="/admin" class="btn btn-secondary">Takaisin tilauksiin</a>
        </div>

        <div class="order-info">
            <div class="info-section">
                <h3>Tilauksen tiedot</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Asiakas:</span>
                        <span class="info-value">{{ order.user_name or 'Tuntematon' }} ({{ order.user_email or 'Tuntematon' }})</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rekisterinumero:</span>
                        <span class="info-value">{{ order.reg_number or 'Ei tiedossa' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Talvirenkaat:</span>
                        <span class="info-value">{{ 'Kyll√§' if order.winter_tires else 'Ei' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Reitti:</span>
                        <span class="info-value">{{ order.pickup_address }} ‚Üí {{ order.dropoff_address }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Matka:</span>
                        <span class="info-value">{{ "%.1f"|format(order.distance_km or 0) }} km</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Hinta:</span>
                        <span class="info-value">{{ (order.price_gross or 0)|format_price_with_vat|safe }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Noutop√§iv√§:</span>
                        <span class="info-value">{{ pickup_date_fi }}</span>
                    </div>
                </div>
            </div>

            <div class="status-section">
                <h3>Tilaustoiminnot</h3>

                {% if order.status == 'NEW' %}
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #92400e;">‚ö†Ô∏è Toimenpide vaaditaan</h4>
                    <p style="margin: 8px 0; color: #78350f;">T√§m√§ tilaus odottaa vahvistusta. Vahvista tilaus julkaistaksesi sen kuljettajille.</p>
                    <form method="POST" action="{{ url_for('admin.confirm_order', order_id=order.id) }}" class="confirm-order-form" style="margin-top: 16px;">
                        <button type="submit" class="btn btn-success" style="font-size: 16px; padding: 12px 24px;">
                            ‚úÖ Vahvista tilaus ja julkaise kuljettajille
                        </button>
                    </form>
                    <div style="margin-top: 12px; font-size: 0.9em; color: #78350f;">
                        <strong>Vahvistamisen j√§lkeen:</strong><br>
                        ‚Ä¢ Asiakas saa vahvistusviestin s√§hk√∂postiin<br>
                        ‚Ä¢ Tilaus tulee n√§kyviin kuljettajien "Saatavilla olevat ty√∂t" -listaan<br>
                        ‚Ä¢ Kuljettajat voivat ottaa tilauksen vastaan
                    </div>
                </div>
                {% elif order.status == 'CONFIRMED' and not order.driver_id %}
                <div style="background: #dcfce7; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #166534;">üëÅÔ∏è Julkaistu kuljettajille</h4>
                    <p style="margin: 8px 0; color: #166534;">T√§m√§ tilaus on n√§kyviss√§ kuljettajille ja odottaa ett√§ kuljettaja ottaa sen vastaan.</p>
                </div>
                {% elif order.driver_id %}
                <div style="background: #e0e7ff; border: 2px solid #6366f1; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #3730a3;">üîí Kuljettaja m√§√§ritetty</h4>
                    <p style="margin: 8px 0; color: #3730a3;">Kuljettaja on ottanut t√§m√§n tilauksen vastaan ja suorittaa kuljetusta.</p>
                </div>
                {% endif %}

                <h4>P√§ivit√§ tila</h4>
                <form method="POST" action="/admin/update">
                    <input type="hidden" name="id" value="{{ order.id }}">
                    <select name="status" class="status-select">
                        <option value="NEW" {% if order.status == 'NEW' %}selected{% endif %}>UUSI</option>
                        <option value="CONFIRMED" {% if order.status == 'CONFIRMED' %}selected{% endif %}>VAHVISTETTU</option>
                        <option value="ASSIGNED_TO_DRIVER" {% if order.status == 'ASSIGNED_TO_DRIVER' %}selected{% endif %}>KULJETTAJA M√Ñ√ÑRITETTY</option>
                        <option value="DRIVER_ARRIVED" {% if order.status == 'DRIVER_ARRIVED' %}selected{% endif %}>KULJETTAJA PAIKALLA</option>
                        <option value="PICKUP_IMAGES_ADDED" {% if order.status == 'PICKUP_IMAGES_ADDED' %}selected{% endif %}>NOUTOKUVAT LIS√ÑTTY</option>
                        <option value="IN_TRANSIT" {% if order.status == 'IN_TRANSIT' %}selected{% endif %}>KULJETUKSESSA</option>
                        <option value="DELIVERY_ARRIVED" {% if order.status == 'DELIVERY_ARRIVED' %}selected{% endif %}>TOIMITUS PAIKALLA</option>
                        <option value="DELIVERY_IMAGES_ADDED" {% if order.status == 'DELIVERY_IMAGES_ADDED' %}selected{% endif %}>TOIMITUSKUVAT LIS√ÑTTY</option>
                        <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>TOIMITETTU</option>
                        <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>PERUUTETTU</option>
                    </select>
                    <button type="submit" class="btn btn-primary">P√§ivit√§</button>
                </form>

                <div class="driver-section">
                    <h4>Kuljettaja</h4>
                    {% if order.driver_id %}
                        <div class="current-driver">
                            <p><strong>Nykyinen kuljettaja:</strong> {{ order.driver_name or 'Tuntematon' }}</p>
                            {% if order.driver_phone %}
                            <p><strong>Puhelin:</strong> <a href="tel:{{ order.driver_phone }}">{{ order.driver_phone }}</a></p>
                            {% endif %}
                        </div>
                    {% endif %}
                    <form method="POST" action="{{ url_for('admin.assign_driver_to_order', order_id=order.id) }}">
                        <select name="driver_id" class="status-select" required>
                            <option value="">{{ 'Vaihda kuljettaja' if order.driver_id else 'Valitse kuljettaja' }}</option>
                            {% for driver in available_drivers %}
                                <option value="{{ driver.id }}" {% if driver.id == order.driver_id %}selected{% endif %}>
                                    {{ driver.name }} - {{ driver.phone or 'Ei puhelinnumeroa' }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">{{ 'Vaihda kuljettaja' if order.driver_id else 'M√§√§rit√§ kuljettaja' }}</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="images-section">
            {% set image_type = 'pickup' %}
            {% set images_data = order.images.pickup if order.images else [] %}
            {% include 'components/admin_image_section.html' with context %}

            {% set image_type = 'delivery' %}
            {% set images_data = order.images.delivery if order.images else [] %}
            {% include 'components/admin_image_section.html' with context %}
        </div>
    </div>
</div>

<!-- Include Admin Image Modal Component -->
{% include 'components/admin_image_modal.html' %}
{% endblock %}

{% block extra_js %}
<!-- Admin Image Modal -->
<script src="{{ url_for('static', filename='js/components/admin-image-modal.js') }}"></script>

<script>
// Set global order ID for image modal
window.currentOrderId = {{ order.id }};
</script>
{% endblock %}