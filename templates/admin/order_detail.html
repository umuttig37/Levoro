{% extends "base/layout.html" %}

{% block title %}Admin - Tilaus #{{ order.id }} ‚Äì Levoro{% endblock %}

{% block extra_css %}
<link rel='stylesheet' href='/static/css/admin-images.css'>
{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-order-detail">
        <div class="order-header">
            <h2>Tilaus #{{ order.id }} - {{ status_fi }}</h2>
            <a href="/admin" class="btn btn-secondary">Takaisin tilauksiin</a>
        </div>

        <div class="order-info-cards">
            <!-- Orderer Card -->
            <div class="info-card info-card-orderer">
                <h3 class="info-card-title">Tilaaja</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Nimi</span>
                        <span class="info-value">{{ order.orderer_name or order.user_name or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">S√§hk√∂posti</span>
                        <span class="info-value">{{ order.orderer_email or order.user_email or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Puhelin</span>
                        <span class="info-value">{{ order.orderer_phone or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Customer/Recipient Card -->
            <div class="info-card info-card-customer">
                <h3 class="info-card-title">Vastaanottaja</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Nimi</span>
                        <span class="info-value">{{ order.customer_name or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Puhelin</span>
                        <span class="info-value">{{ order.customer_phone or order.phone or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Route & Vehicle Card -->
            <div class="info-card info-card-route">
                <h3 class="info-card-title">Reitti ja Ajoneuvo</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Reitti</span>
                        <span class="info-value">{{ order.pickup_address }} ‚Üí {{ order.dropoff_address }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Matka</span>
                        <span class="info-value">{{ "%.1f"|format(order.distance_km or 0) }} km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Noutop√§iv√§</span>
                        <span class="info-value">{{ pickup_date_fi }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Rekisterinumero</span>
                        <span class="info-value">{{ order.reg_number or 'Ei tiedossa' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Talvirenkaat</span>
                        <span class="info-value">{{ 'Kyll√§' if order.winter_tires else 'Ei' }}</span>
                    </div>
                    {% if order.car_brand or order.car_model %}
                    <div class="info-row">
                        <span class="info-label">Auton merkki/malli</span>
                        <span class="info-value">{{ order.car_brand or '' }} {{ order.car_model or '' }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pricing Card -->
            <div class="info-card info-card-pricing">
                <h3 class="info-card-title">Hinnoittelu</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Asiakkaan hinta</span>
                        <span class="info-value info-value-price-large">{{ (order.price_gross or
                            0)|format_price_with_vat|safe }}</span>
                    </div>
                    <div class="info-row info-row-highlight">
                        <span class="info-label">Kuskin palkkio</span>
                        <span class="info-value-highlight">
                            {% if order.driver_reward %}{{ order.driver_reward|round(2) }} ‚Ç¨
                            {% else %}<span class="text-danger">Ei asetettu</span>{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Section -->
        <div class="admin-config-section"
            style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h3
                style="color: #166534; margin-top: 0; margin-bottom: 20px; font-size: 1.25rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 12px;">
                ‚öôÔ∏è Tilauksen asetukset</h3>

            <form method="POST" action="{{ url_for('admin.update_order_details', order_id=order.id) }}"
                style="display: flex; flex-direction: column; gap: 20px;">
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 2px solid #bbf7d0;">
                    <label
                        style="display: block; font-weight: 600; margin-bottom: 8px; color: #166534; font-size: 1rem;">Kuskin
                        palkkio (‚Ç¨) *</label>
                    <input type="number" name="driver_reward" step="0.01" min="0"
                        value="{{ order.driver_reward or '' }}" placeholder="Esim. 150.00" required
                        style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #86efac; border-radius: 8px; background: white;">
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; color: #166534;">üí° T√§m√§ summa n√§kyy kuljettajalle
                        (ei ALV-tietoja)</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Auton
                            merkki</label>
                        <input type="text" name="car_brand" value="{{ order.car_brand or '' }}"
                            placeholder="Esim. Toyota"
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Auton
                            malli</label>
                        <input type="text" name="car_model" value="{{ order.car_model or '' }}"
                            placeholder="Esim. Corolla"
                            style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                    </div>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Lis√§tiedot
                        kuljettajalle</label>
                    <textarea name="additional_info" rows="4"
                        placeholder="Kirjoita ohjeita tai tietoja kuljettajalle..."
                        style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical; background: white;">{{ order.additional_info or '' }}</textarea>
                    <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #6b7280;">‚ÑπÔ∏è N√§m√§ tiedot n√§kyv√§t
                        kuljettajalle ennen ty√∂n vastaanottamista</p>
                </div>

                <button type="submit" class="btn btn-success"
                    style="padding: 14px 32px; font-size: 16px; font-weight: 600; margin-top: 8px;">
                    üíæ Tallenna asetukset
                </button>
            </form>
        </div>

        <!-- Actions Section -->
        <div class="admin-actions-section"
            style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h3
                style="color: #dc2626; margin-top: 0; margin-bottom: 20px; font-size: 1.25rem; border-bottom: 2px solid #fecaca; padding-bottom: 12px;">
                üîÑ Tilauksen toiminnot</h3>

            <div class="status-section">
                <!-- Order Status Alerts -->

                {% if order.status == 'NEW' %}
                <div class="alert-box alert-warning" style="margin-bottom: 24px;">
                    <h4 class="alert-title">‚ö†Ô∏è Toimenpide vaaditaan</h4>
                    <p style="margin: 8px 0; color: #78350f;">T√§m√§ tilaus odottaa vahvistusta. Aseta ensin kuskin
                        palkkio, sitten vahvista tilaus.</p>
                    {% if not order.driver_reward or order.driver_reward <= 0 %} <div class="alert-box alert-error"
                        style="margin: 12px 0;">
                        <strong style="color: #991b1b;">‚ùå Kuskin palkkio puuttuu!</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.9em; color: #991b1b;">Aseta kuskin palkkio yll√§
                            olevassa lomakkeessa ennen vahvistamista.</p>
                </div>
                {% endif %}
                <form method="POST" action="{{ url_for('admin.confirm_order', order_id=order.id) }}"
                    class="confirm-order-form" style="margin-top: 16px;">
                    <button type="submit" class="btn btn-success" {% if not order.driver_reward or order.driver_reward
                        <=0 %}disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}
                        style="padding: 14px 32px; font-size: 16px; font-weight: 600;">
                        ‚úÖ Vahvista tilaus ja julkaise kuljettajille
                    </button>
                </form>
                <div style="margin-top: 12px; font-size: 0.9em; color: #78350f;">
                    <strong>Vahvistamisen j√§lkeen:</strong><br>
                    ‚Ä¢ Asiakas saa vahvistusviestin s√§hk√∂postiin<br>
                    ‚Ä¢ Tilaus tulee n√§kyviin kuljettajille (vain jos palkkio on asetettu)<br>
                    ‚Ä¢ Kuljettajat voivat ottaa tilauksen vastaan
                </div>
            </div>
            {% elif order.status == 'CONFIRMED' and not order.driver_id %}
            {% if order.driver_reward and order.driver_reward > 0 %}
            <div class="alert-box alert-success" style="margin-bottom: 24px;">
                <h4 class="alert-title">‚úÖ Julkaistu kuljettajille</h4>
                <p style="margin: 8px 0; color: #166534;">T√§m√§ tilaus on n√§kyviss√§ kuljettajille (palkkio: {{
                    order.driver_reward|round(2) }} ‚Ç¨) ja odottaa ett√§ kuljettaja ottaa sen vastaan.</p>
            </div>
            {% else %}
            <div class="alert-box alert-warning" style="margin-bottom: 24px;">
                <h4 class="alert-title">‚ö†Ô∏è Palkkio puuttuu</h4>
                <p style="margin: 8px 0; color: #78350f;">Tilaus on vahvistettu, mutta se EI n√§y kuljettajille koska
                    kuskin palkkio puuttuu. Aseta palkkio yll√§.</p>
            </div>
            {% endif %}
            {% elif order.driver_id %}
            <div class="alert-box alert-info" style="margin-bottom: 24px;">
                <h4 class="alert-title">üë§ Kuljettaja m√§√§ritetty</h4>
                <p style="margin: 8px 0; color: #3730a3;">Kuljettaja on ottanut t√§m√§n tilauksen vastaan ja suorittaa
                    kuljetusta.</p>
            </div>
            {% endif %}

            <!-- Status Update Form -->
            <div
                style="background: #fef2f2; padding: 20px; border-radius: 8px; border: 2px solid #fecaca; margin-top: 24px;">
                <h4 style="margin: 0 0 16px 0; color: #991b1b; font-size: 1.1rem;">‚ö†Ô∏è Vaihda tilauksen tila</h4>
                <p style="margin: 0 0 16px 0; font-size: 0.9em; color: #7f1d1d;">Tilan muutos l√§hett√§√§
                    s√§hk√∂posti-ilmoituksen asiakkaalle t√§rkeiss√§ tiloissa (VAHVISTETTU, KULJETTAJA M√Ñ√ÑRITETTY,
                    KULJETUKSESSA, TOIMITETTU).</p>

                <form method="POST" action="/admin/update" style="display: flex; flex-direction: column; gap: 16px;">
                    <input type="hidden" name="id" value="{{ order.id }}">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Valitse
                            uusi tila:</label>
                        <select name="status" class="status-select"
                            style="padding: 14px; font-size: 15px; border: 2px solid #dc2626; border-radius: 8px; background: white; width: 100%; font-weight: 500; color: #374151;">
                            <option value="NEW" {% if order.status=='NEW' %}selected{% endif %}>üÜï UUSI</option>
                            <option value="CONFIRMED" {% if order.status=='CONFIRMED' %}selected{% endif %}>‚úÖ
                                VAHVISTETTU</option>
                            <option value="ASSIGNED_TO_DRIVER" {% if order.status=='ASSIGNED_TO_DRIVER' %}selected{%
                                endif %}>üë§ KULJETTAJA M√Ñ√ÑRITETTY</option>
                            <option value="DRIVER_ARRIVED" {% if order.status=='DRIVER_ARRIVED' %}selected{% endif %}>üìç
                                KULJETTAJA PAIKALLA (NOUTO)</option>
                            <option value="PICKUP_IMAGES_ADDED" {% if order.status=='PICKUP_IMAGES_ADDED' %}selected{%
                                endif %}>üì∏ NOUTOKUVAT LIS√ÑTTY</option>
                            <option value="IN_TRANSIT" {% if order.status=='IN_TRANSIT' %}selected{% endif %}>üöó
                                KULJETUKSESSA</option>
                            <option value="DELIVERY_ARRIVED" {% if order.status=='DELIVERY_ARRIVED' %}selected{% endif
                                %}>üìç KULJETTAJA PAIKALLA (TOIMITUS)</option>
                            <option value="DELIVERY_IMAGES_ADDED" {% if order.status=='DELIVERY_IMAGES_ADDED'
                                %}selected{% endif %}>üì∏ TOIMITUSKUVAT LIS√ÑTTY</option>
                            <option value="DELIVERED" {% if order.status=='DELIVERED' %}selected{% endif %}>‚úîÔ∏è
                                TOIMITETTU</option>
                            <option value="CANCELLED" {% if order.status=='CANCELLED' %}selected{% endif %}>‚ùå PERUUTETTU
                            </option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger"
                        style="padding: 16px 32px; font-size: 17px; font-weight: 700; letter-spacing: 0.5px;">
                        üîÑ P√ÑIVIT√Ñ TILA
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Driver Information Section -->
    {% if order.driver_id %}
    <div class="admin-driver-section"
        style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <h3
            style="color: #4f46e5; margin-top: 0; margin-bottom: 20px; font-size: 1.25rem; border-bottom: 2px solid #c7d2fe; padding-bottom: 12px;">
            üë§ M√§√§ritetty kuljettaja</h3>
        <div style="background: #eef2ff; padding: 20px; border-radius: 8px; border: 2px solid #c7d2fe;">
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <span
                        style="display: block; font-size: 0.85em; color: #6366f1; font-weight: 600; margin-bottom: 4px;">NIMI</span>
                    <span style="font-size: 1.1rem; font-weight: 600; color: #1e1b4b;">{{ order.driver_name or
                        'Tuntematon' }}</span>
                </div>
                {% if order.driver_phone %}
                <div>
                    <span
                        style="display: block; font-size: 0.85em; color: #6366f1; font-weight: 600; margin-bottom: 4px;">PUHELIN</span>
                    <a href="tel:{{ order.driver_phone }}"
                        style="font-size: 1.1rem; font-weight: 600; color: #4f46e5; text-decoration: none;">üìû {{
                        order.driver_phone }}</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="images-section">
        {% set image_type = 'pickup' %}
        {% set images_data = order.images.pickup if order.images else [] %}
        {% include 'components/admin_image_section.html' with context %}

        {% set image_type = 'delivery' %}
        {% set images_data = order.images.delivery if order.images else [] %}
        {% include 'components/admin_image_section.html' with context %}
    </div>
</div>
</div>

<!-- Include Admin Image Modal Component -->
{% include 'components/admin_image_modal.html' %}
{% endblock %}

{% block extra_js %}
<!-- Admin Image Modal -->
<script src="{{ url_for('static', filename='js/components/admin-image-modal.js') }}"></script>

<script>
    // Set global order ID for image modal
    window.currentOrderId = {{ order.id }};
</script>
{% endblock %}