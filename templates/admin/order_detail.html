{% extends "base/layout.html" %}

{% block title %}Admin - Tilaus #{{ order.id }} – Levoro{% endblock %}

{% block extra_css %}
<link rel='stylesheet' href='/static/css/admin-images.css'>
{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-order-detail">
        <div class="order-header">
            <h2>Tilaus #{{ order.id }} - {{ status_fi }}</h2>
            <a href="/admin" class="btn btn-secondary">Takaisin tilauksiin</a>
        </div>

        <div class="order-info-cards">
            <!-- Orderer Card -->
            <div class="info-card info-card-orderer">
                <h3 class="info-card-title">Tilaaja</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Nimi</span>
                        <span class="info-value">{{ order.orderer_name or order.user_name or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Sähköposti</span>
                        <span class="info-value">{{ order.orderer_email or order.user_email or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Puhelin</span>
                        <span class="info-value">{{ order.orderer_phone or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Customer/Recipient Card -->
            <div class="info-card info-card-customer">
                <h3 class="info-card-title">Vastaanottaja</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Nimi</span>
                        <span class="info-value">{{ order.customer_name or 'Tuntematon' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Puhelin</span>
                        <span class="info-value">{{ order.customer_phone or order.phone or '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Route & Vehicle Card -->
            <div class="info-card info-card-route">
                <h3 class="info-card-title">Reitti ja Ajoneuvo</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Reitti</span>
                        <span class="info-value">{{ order.pickup_address }} → {{ order.dropoff_address }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Matka</span>
                        <span class="info-value">{{ "%.1f"|format(order.distance_km or 0) }} km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Noutopäivä</span>
                        <span class="info-value">{{ pickup_date_fi }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Rekisterinumero</span>
                        <span class="info-value">{{ order.reg_number or 'Ei tiedossa' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Talvirenkaat</span>
                        <span class="info-value">{{ 'Kyllä' if order.winter_tires else 'Ei' }}</span>
                    </div>
                    {% if order.car_brand or order.car_model %}
                    <div class="info-row">
                        <span class="info-label">Auton merkki/malli</span>
                        <span class="info-value">{{ order.car_brand or '' }} {{ order.car_model or '' }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Pricing Card -->
            <div class="info-card info-card-pricing">
                <h3 class="info-card-title">Hinnoittelu</h3>
                <div class="info-card-body">
                    <div class="info-row">
                        <span class="info-label">Asiakkaan hinta</span>
                        <span class="info-value">{{ (order.price_gross or 0)|format_price_with_vat|safe }}</span>
                    </div>
                    <div class="info-row info-row-highlight">
                        <span class="info-label">Kuskin palkkio</span>
                        <span class="info-value-highlight">
                            {% if order.driver_reward %}{{ order.driver_reward|round(2) }} €
                            {% else %}<span class="text-danger">Ei asetettu</span>{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="order-info">
            <!-- Driver Reward and Details Form -->
            <div class="info-section driver-reward-section">
                <h3 style="color: #166534;">Kuskin palkkio ja lisätiedot</h3>
                <form method="POST" action="{{ url_for('admin.update_order_details', order_id=order.id) }}" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #166534;">Kuskin palkkio (€) *</label>
                        <input type="number" name="driver_reward" step="0.01" min="0" value="{{ order.driver_reward or '' }}"
                               placeholder="Esim. 150.00" required
                               style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #bbf7d0; border-radius: 8px;">
                        <p style="margin: 4px 0 0 0; font-size: 0.85em; color: #166534;">Tämä summa näkyy kuljettajalle (ei ALV-tietoja)</p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Auton merkki</label>
                        <input type="text" name="car_brand" value="{{ order.car_brand or '' }}" placeholder="Esim. Toyota"
                               style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Auton malli</label>
                        <input type="text" name="car_model" value="{{ order.car_model or '' }}" placeholder="Esim. Corolla"
                               style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Lisätiedot kuljettajalle</label>
                        <textarea name="additional_info" rows="4" placeholder="Kirjoita ohjeita tai tietoja kuljettajalle..."
                                  style="width: 100%; padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">{{ order.additional_info or '' }}</textarea>
                        <p style="margin: 4px 0 0 0; font-size: 0.85em; color: #6b7280;">Nämä tiedot näkyvät kuljettajalle kun hän ottaa työn vastaan</p>
                    </div>
                    <button type="submit" class="btn btn-success" style="padding: 12px 24px; font-size: 16px; font-weight: 600;">
                        Tallenna tiedot
                    </button>
                </form>
            </div>

            <div class="status-section">
                <h3>Tilaustoiminnot</h3>

                {% if order.status == 'NEW' %}
                <div class="alert-box alert-warning">
                    <h4 class="alert-title">Toimenpide vaaditaan</h4>
                    <p style="margin: 8px 0; color: #78350f;">Tämä tilaus odottaa vahvistusta. Aseta ensin kuskin palkkio, sitten vahvista tilaus.</p>
                    {% if not order.driver_reward or order.driver_reward <= 0 %}
                    <div class="alert-box alert-error" style="margin: 12px 0;">
                        <strong style="color: #991b1b;">Kuskin palkkio puuttuu!</strong>
                        <p style="margin: 4px 0 0 0; font-size: 0.9em; color: #991b1b;">Aseta kuskin palkkio yllä olevassa lomakkeessa ennen vahvistamista.</p>
                    </div>
                    {% endif %}
                    <form method="POST" action="{{ url_for('admin.confirm_order', order_id=order.id) }}" class="confirm-order-form" style="margin-top: 16px;">
                        <button type="submit" class="btn btn-success" {% if not order.driver_reward or order.driver_reward <= 0 %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %} style="padding: 12px 24px; font-size: 16px; font-weight: 600; border-radius: 8px; background: #22c55e; color: white; border: none; cursor: pointer; transition: background 0.2s;">
                            Vahvista tilaus ja julkaise kuljettajille
                        </button>
                    </form>
                    <div style="margin-top: 12px; font-size: 0.9em; color: #78350f;">
                        <strong>Vahvistamisen jälkeen:</strong><br>
                        • Asiakas saa vahvistusviestin sähköpostiin<br>
                        • Tilaus tulee näkyviin kuljettajille (vain jos palkkio on asetettu)<br>
                        • Kuljettajat voivat ottaa tilauksen vastaan
                    </div>
                </div>
                {% elif order.status == 'CONFIRMED' and not order.driver_id %}
                {% if order.driver_reward and order.driver_reward > 0 %}
                <div class="alert-box alert-success">
                    <h4 class="alert-title">Julkaistu kuljettajille</h4>
                    <p style="margin: 8px 0; color: #166534;">Tämä tilaus on näkyvissä kuljettajille (palkkio: {{ order.driver_reward|round(2) }} €) ja odottaa että kuljettaja ottaa sen vastaan.</p>
                </div>
                {% else %}
                <div class="alert-box alert-warning">
                    <h4 class="alert-title">Palkkio puuttuu</h4>
                    <p style="margin: 8px 0; color: #78350f;">Tilaus on vahvistettu, mutta se EI näy kuljettajille koska kuskin palkkio puuttuu. Aseta palkkio yllä.</p>
                </div>
                {% endif %}
                {% elif order.driver_id %}
                <div class="alert-box alert-info">
                    <h4 class="alert-title">Kuljettaja määritetty</h4>
                    <p style="margin: 8px 0; color: #3730a3;">Kuljettaja on ottanut tämän tilauksen vastaan ja suorittaa kuljetusta.</p>
                </div>
                {% endif %}

                <h4 style="margin-bottom: 16px;">Päivitä tila</h4>
                <form method="POST" action="/admin/update" style="display: flex; flex-direction: column; gap: 12px;">
                    <input type="hidden" name="id" value="{{ order.id }}">
                    <select name="status" class="status-select" style="padding: 12px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; width: 100%;">
                        <option value="NEW" {% if order.status == 'NEW' %}selected{% endif %}>UUSI</option>
                        <option value="CONFIRMED" {% if order.status == 'CONFIRMED' %}selected{% endif %}>VAHVISTETTU</option>
                        <option value="ASSIGNED_TO_DRIVER" {% if order.status == 'ASSIGNED_TO_DRIVER' %}selected{% endif %}>KULJETTAJA MÄÄRITETTY</option>
                        <option value="DRIVER_ARRIVED" {% if order.status == 'DRIVER_ARRIVED' %}selected{% endif %}>KULJETTAJA PAIKALLA</option>
                        <option value="PICKUP_IMAGES_ADDED" {% if order.status == 'PICKUP_IMAGES_ADDED' %}selected{% endif %}>NOUTOKUVAT LISÄTTY</option>
                        <option value="IN_TRANSIT" {% if order.status == 'IN_TRANSIT' %}selected{% endif %}>KULJETUKSESSA</option>
                        <option value="DELIVERY_ARRIVED" {% if order.status == 'DELIVERY_ARRIVED' %}selected{% endif %}>TOIMITUS PAIKALLA</option>
                        <option value="DELIVERY_IMAGES_ADDED" {% if order.status == 'DELIVERY_IMAGES_ADDED' %}selected{% endif %}>TOIMITUSKUVAT LISÄTTY</option>
                        <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>TOIMITETTU</option>
                        <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>PERUUTETTU</option>
                    </select>
                    <button type="submit" class="btn btn-primary" style="padding: 12px 24px; font-size: 16px; font-weight: 600; border-radius: 8px; background: #3b82f6; color: white; border: none; cursor: pointer; transition: background 0.2s;">Päivitä tila</button>
                </form>

                {% if order.driver_id %}
                <div style="margin-top: 24px; padding: 16px; background: #f3f4f6; border-radius: 8px;">
                    <h4 style="margin-top: 0; margin-bottom: 12px; color: #111827;">Kuljettaja</h4>
                    <div>
                        <p style="margin: 4px 0;"><strong>Nimi:</strong> {{ order.driver_name or 'Tuntematon' }}</p>
                        {% if order.driver_phone %}
                        <p style="margin: 4px 0;"><strong>Puhelin:</strong> <a href="tel:{{ order.driver_phone }}" style="color: #3b82f6; text-decoration: none;">{{ order.driver_phone }}</a></p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="images-section">
            {% set image_type = 'pickup' %}
            {% set images_data = order.images.pickup if order.images else [] %}
            {% include 'components/admin_image_section.html' with context %}

            {% set image_type = 'delivery' %}
            {% set images_data = order.images.delivery if order.images else [] %}
            {% include 'components/admin_image_section.html' with context %}
        </div>
    </div>
</div>

<!-- Include Admin Image Modal Component -->
{% include 'components/admin_image_modal.html' %}
{% endblock %}

{% block extra_js %}
<!-- Admin Image Modal -->
<script src="{{ url_for('static', filename='js/components/admin-image-modal.js') }}"></script>

<script>
// Set global order ID for image modal
window.currentOrderId = {{ order.id }};
</script>
{% endblock %}