{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Hakemus #{{ application.id }} – Admin{% endblock %}

{% block content %}
<div class="admin-container">
  {% block admin_title %}Kuljettajahakemus #{{ application.id }}{% endblock %}
  {% include "admin/navigation.html" %}

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="alert alert-{% if category == 'error' %}danger{% else %}{{ category }}{% endif %} mb-4">
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- Application Status -->
  <div class="card mb-6">
    <div class="card-header">
      <h3 class="card-title">Hakemuksen tila</h3>
    </div>
    <div class="card-body">
      <div class="flex items-center justify-between">
        {% if application.status == 'pending' %}
        {% set status_class = 'status-new' %}
        {% set status_text = '- Odottaa käsittelyä' %}
        {% elif application.status == 'approved' %}
        {% set status_class = 'status-confirmed' %}
        {% set status_text = '✓ Hyväksytty' %}
        {% elif application.status == 'denied' %}
        {% set status_class = 'status-cancelled' %}
        {% set status_text = 'X Hylätty' %}
        {% else %}
        {% set status_class = 'status-new' %}
        {% set status_text = 'Tuntematon' %}
        {% endif %}

        <span class="status {{ status_class }}">{{ status_text }}</span>

        {% if application.processed_at %}
        <span class="text-sm text-muted">
          Käsitelty: {{ application.processed_at|helsinki_time if application.processed_at else '-' }}
        </span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Application Details -->
  <div class="card mb-6">
    <div class="card-header">
      <h3 class="card-title">Hakijan tiedot</h3>
    </div>
    <div class="card-body">
      <div class="space-y-4">
        <div class="grid cols-2 gap-4">
          <div>
            <label class="form-label">Etunimi</label>
            <p class="text-primary">{{ application.first_name or '-' }}</p>
          </div>
          <div>
            <label class="form-label">Sukunimi</label>
            <p class="text-primary">{{ application.last_name or '-' }}</p>
          </div>
        </div>

        <div>
          <label class="form-label">Koko nimi</label>
          <p class="text-primary font-semibold">{{ application.name }}</p>
        </div>

        <div class="grid cols-2 gap-4">
          <div>
            <label class="form-label">Sähköposti</label>
            <p class="text-primary"><a href="mailto:{{ application.email }}">{{ application.email }}</a></p>
          </div>
          <div>
            <label class="form-label">Puhelinnumero</label>
            <p class="text-primary"><a href="tel:{{ application.phone }}">{{ application.phone }}</a></p>
          </div>
        </div>

        <div>
          <label class="form-label">Hakemus lähetetty</label>
          <p class="text-primary">{{ application.created_at|helsinki_time if application.created_at else '-' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Driver's License Images -->
  <div class="card mb-6">
    <div class="card-header">
      <h3 class="card-title">Ajokortti</h3>
    </div>
    <div class="card-body">
      {% if application.license_images and (application.license_images.front or application.license_images.back) %}
      <div class="grid cols-2 gap-4">
        <!-- Front Image -->
        <div class="license-image-box">
          <label class="form-label">Ajokortin etupuoli</label>
          {% if application.license_images.front %}
          <a href="{{ url_for('admin.view_license_image', application_id=application.id, image_type='front') }}"
            target="_blank" class="license-preview-link">
            <div class="license-preview">
              <img src="{{ url_for('admin.view_license_image', application_id=application.id, image_type='front') }}"
                alt="Ajokortin etupuoli" class="license-thumbnail">
              <div class="license-preview-overlay">
                <span>{{ icons.search(24, 'white') }} Näytä suurempana</span>
              </div>
            </div>
          </a>
          {% else %}
          <div class="license-preview-empty">
            <p class="text-muted">Ei kuvaa</p>
          </div>
          {% endif %}
        </div>

        <!-- Back Image -->
        <div class="license-image-box">
          <label class="form-label">Ajokortin takapuoli</label>
          {% if application.license_images.back %}
          <a href="{{ url_for('admin.view_license_image', application_id=application.id, image_type='back') }}"
            target="_blank" class="license-preview-link">
            <div class="license-preview">
              <img src="{{ url_for('admin.view_license_image', application_id=application.id, image_type='back') }}"
                alt="Ajokortin takapuoli" class="license-thumbnail">
              <div class="license-preview-overlay">
                <span>{{ icons.search(24, 'white') }} Näytä suurempana</span>
              </div>
            </div>
          </a>
          {% else %}
          <div class="license-preview-empty">
            <p class="text-muted">Ei kuvaa</p>
          </div>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-muted text-center">Ei ajokorttikuvia saatavilla</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Actions -->
  {% if application.status == 'pending' %}
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Toiminnot</h3>
    </div>
    <div class="card-body">
      <div class="flex gap-4">
        <form method="POST" action="{{ url_for('admin.approve_driver_application') }}" style="flex: 1;">
          <input type="hidden" name="application_id" value="{{ application.id }}">
          <button type="submit" class="btn btn-success w-full"
            onclick="return confirm('Hyväksy hakemus ja luo kuljettajatili?\n\nHakijalle lähetetään vahvistusviesti sähköpostiin.')">
            {{ icons.check_circle(18, 'currentColor', 'icon-inline') }} Hyväksy hakemus
          </button>
        </form>

        <form method="POST" action="{{ url_for('admin.deny_driver_application') }}" style="flex: 1;">
          <input type="hidden" name="application_id" value="{{ application.id }}">
          <button type="submit" class="btn btn-error w-full"
            onclick="return confirm('Hylkää hakemus?\n\nHakijalle lähetetään hylkäysviesti sähköpostiin.')">
            {{ icons.x(18, 'currentColor', 'icon-inline') }} Hylkää hakemus
          </button>
        </form>
      </div>

      <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-sm text-muted">
          <strong>Huomio:</strong> Hyväksyminen luo automaattisesti kuljettajatilin ja lähettää kirjautumistiedot
          hakijalle sähköpostitse.
        </p>
      </div>
    </div>
  </div>
  {% elif application.status == 'approved' %}
  <div class="card">
    <div class="card-body text-center">
      <div class="mb-3">{{ icons.check_circle(64, '#16a34a') }}</div>
      <h3 class="font-semibold text-lg mb-2">Hakemus hyväksytty</h3>
      <p class="text-muted">Kuljettajatili on luotu ja hakijalle on lähetetty vahvistusviesti.</p>
    </div>
  </div>
  {% elif application.status == 'denied' %}
  <div class="card">
    <div class="card-body text-center">
      <div class="mb-3">{{ icons.x(64, '#dc2626') }}</div>
      <h3 class="font-semibold text-lg mb-2">Hakemus hylätty</h3>
      <p class="text-muted">Hakijalle on lähetetty hylkäysviesti.</p>
    </div>
  </div>
  {% endif %}

  <!-- Delete Section (Available for all statuses) -->
  <div class="card mt-6 danger-zone-card">
    <div class="card-header danger-zone-header">
      <h3 class="card-title danger-zone-title">
        {{ icons.alert(20, '#dc2626', 'icon-inline') }}
        <span>Vaarallinen alue</span>
      </h3>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('admin.delete_driver_application', application_id=application.id) }}">
        <button type="submit" class="btn btn-danger w-full" onclick="return confirmDelete()">
          {{ icons.x(18, 'currentColor', 'icon-inline') }} Poista hakemus ja käyttäjätili
        </button>
      </form>
      <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <p class="text-sm text-muted">
          <strong>Varoitus:</strong> Tämä poistaa pysyvästi sekä hakemuksen että liittyvän käyttäjätilin.
          Tätä toimintoa ei voi peruuttaa.
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  /* License Image Preview Styles */
  .license-image-box {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .license-preview-link {
    display: block;
    text-decoration: none;
  }

  .license-preview {
    position: relative;
    border-radius: 0.75rem;
    overflow: hidden;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    aspect-ratio: 16 / 10;
    transition: all 0.3s ease;
  }

  .license-preview:hover {
    border-color: #3b82f6;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
  }

  .license-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .license-preview-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .license-preview:hover .license-preview-overlay {
    opacity: 1;
  }

  .license-preview-overlay span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .license-preview-empty {
    padding: 2rem;
    background: #f8fafc;
    border: 2px dashed #e2e8f0;
    border-radius: 0.75rem;
    text-align: center;
  }

  /* Danger Zone Styles */
  .danger-zone-card {
    border: 2px solid #dc2626;
  }

  .danger-zone-header {
    background: #fef2f2;
  }

  .danger-zone-title {
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
  }

  .btn-danger {
    background: #dc2626;
    color: white;
    border: none;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }
</style>

<script>
  function confirmDelete() {
    return confirm(
      "VAROITUS: Tämä toiminto poistaa PYSYVÄSTI:\n\n" +
      "• Kuljettajahakemuksen #{{ application.id }} ({{ application.name }})\n" +
      "• Käyttäjätilin (jos olemassa): {{ application.email }}\n" +
      "• Kaikki liittyvät tiedot\n\n" +
      "Tätä toimintoa EI VOI PERUUTTAA!\n\n" +
      "Haluatko varmasti jatkaa?"
    );
  }
</script>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin_navigation.js') }}"></script>
{% endblock %}
{% endblock %}