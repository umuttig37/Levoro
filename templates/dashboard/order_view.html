{% extends "base/layout.html" %}

{% block title %}Tilaus #{{ order.id }} ‚Äì Levoro{% endblock %}

{% block extra_css %}
<link rel='stylesheet' href='/static/css/order-view.css'>
<link rel='stylesheet' href='/static/css/client-images.css'>
{% endblock %}

{% block content %}
<div class="order-container">
  <!-- Hero Section with Key Information -->
  <div class="order-hero status-{{ order.status.lower() }}">
    <div class="hero-content">
      <div class="hero-header">
        <h1 class="order-title">Tilaus #{{ order.id }}</h1>
        <div class="order-status-main">
          <span class="status-badge status-{{ order.status.lower() }}">{{ status_fi }}</span>
          <p class="status-description">{{ status_description }}</p>
        </div>
      </div>

      <!-- Route Display - Most Important Information -->
      <div class="hero-route">
        <div class="route-card">
          <div class="route-point pickup">
            <div class="point-icon">üìç</div>
            <div class="point-details">
              <span class="point-label">Nouto</span>
              <span class="point-address">{{ order.pickup_address or '?' }}</span>
            </div>
          </div>
          <div class="route-connector">
            <div class="route-line"></div>
            <div class="route-arrow">‚Üí</div>
          </div>
          <div class="route-point delivery">
            <div class="point-icon">üìç</div>
            <div class="point-details">
              <span class="point-label">Toimitus</span>
              <span class="point-address">{{ order.dropoff_address or '?' }}</span>
            </div>
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="hero-metrics">
          <div class="metric-card">
            <span class="metric-value">{{ "%.1f"|format(distance_km) }} km</span>
            <span class="metric-label">Matka</span>
          </div>
          <div class="metric-card price-card">
            <span class="metric-value">{{ "%.2f"|format(price_gross) }} ‚Ç¨</span>
            <span class="metric-label">Hinta</span>
          </div>
          {% if order.status in ['ASSIGNED_TO_DRIVER', 'DRIVER_ARRIVED', 'PICKUP_IMAGES_ADDED', 'IN_TRANSIT', 'DELIVERY_ARRIVED', 'DELIVERY_IMAGES_ADDED', 'DELIVERED'] %}
          <div class="metric-card driver-card">
            <span class="metric-value">
              {% if order.driver_name %}
                {{ order.driver_name }}
                {% if order.driver_phone %}
                  <br><a href="tel:{{ order.driver_phone }}" class="driver-phone-link">üìû {{ order.driver_phone }}</a>
                {% endif %}
              {% else %}
                M√§√§ritet√§√§n...
              {% endif %}
            </span>
            <span class="metric-label">Kuljettaja</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Section -->
  <div class="progress-section">
    {{ progress_bar|safe }}
  </div>

  <!-- Secondary Information -->
  <div class="order-details">
    <div class="details-grid">
      {% if show_vehicle_section or order.status == 'NEW' %}
      <div class="detail-card">
        <h3 class="card-title">üöó Ajoneuvo</h3>
        <div class="card-content">
          {% if has_reg_number %}
          <div class="detail-row">
            <span class="detail-label">Rekisterinumero</span>
            <span class="detail-value">{{ order.reg_number or '' }}</span>
          </div>
          {% endif %}
          {% if has_winter_tires %}
          <div class="detail-row">
            <span class="detail-label">Talvirenkaat</span>
            <span class="detail-value">{{ 'Kyll√§' if order.winter_tires else 'Ei' }}</span>
          </div>
          {% endif %}
          {% if not show_vehicle_section %}
          <div class="detail-row empty-state">
            <span class="detail-label">üìù</span>
            <span class="detail-value">Ajoneuvotiedot t√§ydennet√§√§n noudettaessa</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if has_customer_info or order.status == 'NEW' %}
      <div class="detail-card">
        <h3 class="card-title">üë§ Yhteystiedot</h3>
        <div class="card-content">
          {% if order.customer_name and order.customer_name.strip() %}
          <div class="detail-row">
            <span class="detail-label">Nimi</span>
            <span class="detail-value">{{ order.customer_name }}</span>
          </div>
          {% endif %}
          {% if order.email and order.email.strip() %}
          <div class="detail-row">
            <span class="detail-label">S√§hk√∂posti</span>
            <span class="detail-value">{{ order.email }}</span>
          </div>
          {% endif %}
          {% if order.phone and order.phone.strip() %}
          <div class="detail-row">
            <span class="detail-label">Puhelin</span>
            <span class="detail-value">{{ order.phone }}</span>
          </div>
          {% endif %}
          {% if not has_customer_info %}
          <div class="detail-row empty-state">
            <span class="detail-label">üìû</span>
            <span class="detail-value">Yhteystiedot p√§ivitet√§√§n tilauksen k√§sittelyn yhteydess√§</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    {% if order.additional_info %}
    <div class="detail-card full-width">
      <h3 class="card-title">üìù Lis√§tiedot</h3>
      <div class="card-content">
        <p class="additional-info-text">{{ order.additional_info or 'Ei lis√§tietoja' }}</p>
      </div>
    </div>
    {% endif %}

    {% if has_images or order.status in ['NEW', 'CONFIRMED', 'IN_TRANSIT'] %}
    <div class="detail-card full-width">
      <h3 class="card-title">üì∑ Kuljetuskuvat</h3>
      <div class="card-content">
        <div class="images-grid">
          <div class="image-section">
            <h4 class="image-section-title">Nouto</h4>
            {% set image_type = 'pickup' %}
            {% set images_data = order.images.pickup if order.images else [] %}
            {% include 'components/client_image_section.html' with context %}
          </div>
          <div class="image-section">
            <h4 class="image-section-title">Toimitus</h4>
            {% set image_type = 'delivery' %}
            {% set images_data = order.images.delivery if order.images else [] %}
            {% include 'components/client_image_section.html' with context %}
          </div>
        </div>
        {% if not has_images and order.status in ['NEW', 'CONFIRMED'] %}
        <div class="images-status">
          <p class="status-info">üì∏ Kuljetuskuvat lis√§t√§√§n kuljetuksen aikana</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <div class="order-actions">
    <a href="/dashboard" class="btn btn-ghost">‚Üê Takaisin tilauksiin</a>
  </div>
</div>

<!-- Include Image Modal Component -->
{% include 'components/image_modal.html' %}
{% endblock %}

{% block extra_js %}
<!-- Client Image Modal -->
<script src="{{ url_for('static', filename='js/components/image-modal.js') }}"></script>
{% endblock %}