{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Omat tilaukset – Autonkuljetus{% endblock %}

{% block content %}
<div class="container">
  <div class="section-padding">
    <div class="text-center mb-8">
      <h1 class="calculator-title">Omat tilaukset</h1>
      <p class="calculator-subtitle">Hallinnoi kuljetustilauksiasi ja seuraa niiden etenemistä</p>
    </div>
  </div>

  <div style="max-width: 1200px; margin: 0 auto;">
    <div class="user-orders-section">
      <div class="user-orders-header">
        <h2 class="user-orders-title">
          Tilaushistoria
          <span class="user-orders-count">{{ orders|length }} tilausta</span>
        </h2>
      </div>

      <div style="padding: var(--space-6);">
        {% set current_tab = request.args.get('tab', 'active') %}
        <div class="tabs mb-4">
          <a href="/dashboard?tab=active"
            class="btn {% if current_tab == 'active' %}btn-primary{% else %}btn-ghost{% endif %} mr-2">Aktiiviset</a>
          <a href="/dashboard?tab=completed"
            class="btn {% if current_tab == 'completed' %}btn-primary{% else %}btn-ghost{% endif %}">Valmistuneet</a>
        </div>

        <div class="calculator-actions mb-4">
          <a class="btn btn-primary" href="/order/new/step1">+ Uusi tilaus</a>
        </div>
      </div>

      <!-- Desktop Table View -->
      <div class="user-orders-table-wrapper">
        <table class="user-orders-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tila</th>
              <th>Reitti</th>
              <th>Matka</th>
              <th>Hinta</th>
              <th>Toiminnot</th>
            </tr>
          </thead>
          <tbody>
            {% if orders %}
            {% for order in orders %}
            {% set status_fi = {
            'NEW': 'Uusi',
            'CONFIRMED': 'Vahvistettu',
            'ASSIGNED_TO_DRIVER': 'Kuljettaja osoitettu',
            'DRIVER_ARRIVED': 'Kuljettaja paikalla',
            'PICKUP_IMAGES_ADDED': 'Noutokuva lisätty',
            'IN_TRANSIT': 'Kuljetuksessa',
            'DELIVERY_ARRIVED': 'Toimitus paikalla',
            'DELIVERY_IMAGES_ADDED': 'Toimituskuva lisätty',
            'DELIVERED': 'Toimitettu',
            'COMPLETED': 'Valmis',
            'CANCELLED': 'Peruutettu'
            }.get(order.status, order.status) %}

            {% set status_class = {
            'NEW': 'pending',
            'CONFIRMED': 'confirmed',
            'ASSIGNED_TO_DRIVER': 'confirmed',
            'DRIVER_ARRIVED': 'in-progress',
            'PICKUP_IMAGES_ADDED': 'in-progress',
            'IN_TRANSIT': 'in-progress',
            'DELIVERY_ARRIVED': 'in-progress',
            'DELIVERY_IMAGES_ADDED': 'in-progress',
            'DELIVERED': 'completed',
            'COMPLETED': 'completed',
            'CANCELLED': 'cancelled'
            }.get(order.status, 'pending') %}

            <tr>
              <td class="user-orders-id">#{{ order.id }}</td>
              <td class="user-orders-status">
                <span class="user-status-badge {{ status_class }}">{{ status_fi }}</span>
              </td>
              <td class="user-orders-route">{{ order.pickup_address }} → {{ order.dropoff_address }}</td>
              <td class="user-orders-distance">{{ "%.1f"|format(order.distance_km|float) }} km</td>
              <td class="user-orders-price">
                <div class="price-display">
                  <div class="price-main">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</div>
                  <div class="price-vat">ALV 0%</div>
                  <div class="price-details">ALV 25,5%: {{ "%.2f"|format((order.price_gross|float) -
                    ((order.price_gross|float) / 1.255)) }} € | Yhteensä: {{ "%.2f"|format(order.price_gross|float) }} €
                  </div>
                </div>
              </td>
              <td class="user-orders-actions">
                <a class="user-action-btn" href="/order/{{ order.id }}">Avaa</a>
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="6" class="user-orders-empty">
                <div class="empty-state">
                  {{ icons.package(48, '#94a3b8') }}
                  <div class="empty-title">Ei tilauksia</div>
                  <div class="empty-text">Luo ensimmäinen tilauksesi yllä olevalla napilla</div>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="user-orders-cards">
        {% if orders %}
        {% for order in orders %}
        {% set status_fi = {
        'NEW': 'Uusi',
        'CONFIRMED': 'Vahvistettu',
        'ASSIGNED_TO_DRIVER': 'Kuljettaja osoitettu',
        'DRIVER_ARRIVED': 'Kuljettaja paikalla',
        'PICKUP_IMAGES_ADDED': 'Noutokuva lisätty',
        'IN_TRANSIT': 'Kuljetuksessa',
        'DELIVERY_ARRIVED': 'Toimitus paikalla',
        'DELIVERY_IMAGES_ADDED': 'Toimituskuva lisätty',
        'DELIVERED': 'Toimitettu',
        'COMPLETED': 'Valmis',
        'CANCELLED': 'Peruutettu'
        }.get(order.status, order.status) %}

        {% set status_class = {
        'NEW': 'pending',
        'CONFIRMED': 'confirmed',
        'ASSIGNED_TO_DRIVER': 'confirmed',
        'DRIVER_ARRIVED': 'in-progress',
        'PICKUP_IMAGES_ADDED': 'in-progress',
        'IN_TRANSIT': 'in-progress',
        'DELIVERY_ARRIVED': 'in-progress',
        'DELIVERY_IMAGES_ADDED': 'in-progress',
        'DELIVERED': 'completed',
        'COMPLETED': 'completed',
        'CANCELLED': 'cancelled'
        }.get(order.status, 'pending') %}

        <article class="order-card" role="article" aria-label="Tilaus {{ order.id }}">
          <!-- Card Header -->
          <div class="order-card-header">
            <div class="order-card-id">
              {{ icons.clipboard(20, '#2563eb') }}
              <span>#{{ order.id }}</span>
            </div>
            <span class="user-status-badge {{ status_class }}" role="status" aria-label="Tilauksen tila">{{ status_fi
              }}</span>
          </div>

          <!-- Route Section -->
          <div class="order-card-route" aria-label="Kuljetusreitti">
            <div class="route-point">
              <div class="route-icon pickup">{{ icons.location(20, '#3b82f6') }}</div>
              <div class="route-text">
                <div class="route-label">Nouto</div>
                <div class="route-address">{{ order.pickup_address }}</div>
              </div>
            </div>
            <div class="route-arrow">↓</div>
            <div class="route-point">
              <div class="route-icon delivery">{{ icons.location(20, '#10b981') }}</div>
              <div class="route-text">
                <div class="route-label">Toimitus</div>
                <div class="route-address">{{ order.dropoff_address }}</div>
              </div>
            </div>
          </div>

          <!-- Info Grid -->
          <div class="order-card-info">
            <div class="info-item">
              <div class="info-label">Matka</div>
              <div class="info-value">{{ "%.1f"|format(order.distance_km|float) }} km</div>
            </div>
            <div class="info-item price-item">
              <div class="info-label">Hinta</div>
              <div class="info-value price-value">
                <div class="price-main-mobile">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</div>
                <div class="price-vat-mobile">ALV 0%</div>
              </div>
            </div>
          </div>

          <!-- Price Details (Expandable) -->
          <details class="price-details-toggle">
            <summary class="price-details-summary">Näytä hinnan erittely</summary>
            <div class="price-details-content">
              <div class="price-detail-row">
                <span>Hinta (ALV 0%)</span>
                <span>{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</span>
              </div>
              <div class="price-detail-row">
                <span>ALV 25,5%</span>
                <span>{{ "%.2f"|format((order.price_gross|float) - ((order.price_gross|float) / 1.255)) }} €</span>
              </div>
              <div class="price-detail-row total">
                <span>Yhteensä</span>
                <span>{{ "%.2f"|format(order.price_gross|float) }} €</span>
              </div>
            </div>
          </details>

          <!-- Action Button -->
          <a href="/order/{{ order.id }}" class="order-card-action" aria-label="Avaa tilaus {{ order.id }}">
            Avaa tilaus
            {{ icons.eye(18, '#ffffff') }}
          </a>
        </article>
        {% endfor %}
        {% else %}
        <div class="user-orders-empty">
          <div class="empty-state">
            {{ icons.package(64, '#94a3b8') }}
            <div class="empty-title">Ei tilauksia</div>
            <div class="empty-text">Luo ensimmäinen tilauksesi yllä olevalla napilla</div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}