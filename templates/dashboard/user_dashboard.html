{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Omat tilaukset – Autonkuljetus{% endblock %}

{% block content %}
<div class="container">
  <div class="section-padding">
    <div class="text-center mb-8">
      <h1 class="calculator-title">Omat tilaukset</h1>
      <p class="calculator-subtitle">Hallinnoi kuljetustilauksiasi ja seuraa niiden etenemistä</p>
    </div>
  </div>

  <div class="user-dashboard-wrapper">
    <div class="user-orders-section">
      <div class="user-orders-header">
        <h2 class="user-orders-title">
          Tilaushistoria
          <span class="user-orders-count" id="ordersCount">{{ orders|length }} tilausta</span>
        </h2>
      </div>

      <div class="user-dashboard-inner">
        <div class="tabs mb-4">
          <button type="button" class="btn btn-primary mr-2 tab-btn" data-tab="active"
            id="tabActive">Aktiiviset</button>
          <button type="button" class="btn btn-ghost tab-btn" data-tab="completed"
            id="tabCompleted">Valmistuneet</button>
        </div>

        <div class="calculator-actions mb-4">
          <a class="btn btn-primary" href="/order/new/step1">+ Uusi tilaus</a>
        </div>
      </div>

      <!-- Desktop Table View -->
      <div class="user-orders-table-wrapper">
        <table class="user-orders-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tila</th>
              <th>Reitti</th>
              <th>Matka</th>
              <th>Hinta</th>
              <th>Toiminnot</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            {% if all_orders %}
            {% for order in all_orders %}
            {% set status_fi = {
            'NEW': 'Uusi',
            'CONFIRMED': 'Vahvistettu',
            'ASSIGNED_TO_DRIVER': 'Noudossa',
            'DRIVER_ARRIVED': 'Kuljettaja paikalla',
            'PICKUP_IMAGES_ADDED': 'Noutokuva lisätty',
            'IN_TRANSIT': 'Kuljetuksessa',
            'DELIVERY_ARRIVED': 'Toimitus paikalla',
            'DELIVERY_IMAGES_ADDED': 'Toimituskuva lisätty',
            'DELIVERED': 'Toimitettu',
            'COMPLETED': 'Valmis',
            'CANCELLED': 'Peruutettu'
            }.get(order.status, order.status) %}

            {% set status_class = {
            'NEW': 'pending',
            'CONFIRMED': 'confirmed',
            'ASSIGNED_TO_DRIVER': 'confirmed',
            'DRIVER_ARRIVED': 'in-progress',
            'PICKUP_IMAGES_ADDED': 'in-progress',
            'IN_TRANSIT': 'in-progress',
            'DELIVERY_ARRIVED': 'in-progress',
            'DELIVERY_IMAGES_ADDED': 'in-progress',
            'DELIVERED': 'completed',
            'COMPLETED': 'completed',
            'CANCELLED': 'cancelled'
            }.get(order.status, 'pending') %}

            {% set is_completed = order.status in ['DELIVERED', 'COMPLETED', 'CANCELLED'] %}

            <tr class="order-row" data-status="{{ 'completed' if is_completed else 'active' }}">
              <td class="user-orders-id">
                #{{ order.id }}
                {% if order.trip_type %}
                <span class="trip-type-badge trip-type-{{ order.trip_type.lower() }}">{{ order.trip_type }}</span>
                {% endif %}
              </td>
              <td class="user-orders-status">
                <span class="user-status-badge {{ status_class }}">{{ status_fi }}</span>
              </td>
              <td class="user-orders-route">{{ order.pickup_address }} → {{ order.dropoff_address }}</td>
              <td class="user-orders-distance">{{ "%.1f"|format(order.distance_km|float) }} km</td>
              <td class="user-orders-price">
                <div class="price-display">
                  <div class="price-main">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</div>
                  <div class="price-vat">ALV 0%</div>
                  <div class="price-details">ALV 25,5%: {{ "%.2f"|format((order.price_gross|float) -
                    ((order.price_gross|float) / 1.255)) }} € | Yhteensä: {{ "%.2f"|format(order.price_gross|float) }} €
                  </div>
                </div>
              </td>
              <td class="user-orders-actions">
                <a class="user-action-btn" href="/order/{{ order.id }}">Avaa</a>
                {% if order.status in ['DELIVERED', 'COMPLETED'] and order.driver_id %}
                <a class="user-action-btn user-action-rate" href="/order/{{ order.id }}/rate"
                  title="Arvostele kuljetus">⭐</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
        <div id="tableEmpty" class="user-orders-empty" style="display: none;">
          <div class="empty-state">
            {{ icons.package(48, '#94a3b8') }}
            <div class="empty-title">Ei tilauksia</div>
            <div class="empty-text" id="emptyText">Luo ensimmäinen tilauksesi yllä olevalla napilla</div>
          </div>
        </div>
      </div>

      <!-- Mobile Card View -->
      <div class="user-orders-cards" id="ordersCards">
        {% if all_orders %}
        {% for order in all_orders %}
        {% set status_fi = {
        'NEW': 'Uusi',
        'CONFIRMED': 'Vahvistettu',
        'ASSIGNED_TO_DRIVER': 'Noudossa',
        'DRIVER_ARRIVED': 'Kuljettaja paikalla',
        'PICKUP_IMAGES_ADDED': 'Noutokuva lisätty',
        'IN_TRANSIT': 'Kuljetuksessa',
        'DELIVERY_ARRIVED': 'Toimitus paikalla',
        'DELIVERY_IMAGES_ADDED': 'Toimituskuva lisätty',
        'DELIVERED': 'Toimitettu',
        'COMPLETED': 'Valmis',
        'CANCELLED': 'Peruutettu'
        }.get(order.status, order.status) %}

        {% set status_class = {
        'NEW': 'pending',
        'CONFIRMED': 'confirmed',
        'ASSIGNED_TO_DRIVER': 'confirmed',
        'DRIVER_ARRIVED': 'in-progress',
        'PICKUP_IMAGES_ADDED': 'in-progress',
        'IN_TRANSIT': 'in-progress',
        'DELIVERY_ARRIVED': 'in-progress',
        'DELIVERY_IMAGES_ADDED': 'in-progress',
        'DELIVERED': 'completed',
        'COMPLETED': 'completed',
        'CANCELLED': 'cancelled'
        }.get(order.status, 'pending') %}

        {% set is_completed = order.status in ['DELIVERED', 'COMPLETED', 'CANCELLED'] %}

        <article class="order-card order-card-item" data-status="{{ 'completed' if is_completed else 'active' }}"
          role="article" aria-label="Tilaus {{ order.id }}">
          <!-- Card Header -->
          <div class="order-card-header">
            <div class="order-card-id">
              {{ icons.clipboard(20, '#2563eb') }}
              <span>#{{ order.id }}</span>
              {% if order.trip_type %}
              <span class="trip-type-badge trip-type-{{ order.trip_type.lower() }}">{{ order.trip_type }}</span>
              {% endif %}
            </div>
            <span class="user-status-badge {{ status_class }}" role="status" aria-label="Tilauksen tila">{{ status_fi
              }}</span>
          </div>

          <!-- Route Section -->
          <div class="order-card-route" aria-label="Kuljetusreitti">
            <div class="route-point">
              <div class="route-icon pickup">{{ icons.location(20, '#3b82f6') }}</div>
              <div class="route-text">
                <div class="route-label">Nouto</div>
                <div class="route-address">{{ order.pickup_address }}</div>
              </div>
            </div>
            <div class="route-arrow">↓</div>
            <div class="route-point">
              <div class="route-icon delivery">{{ icons.location(20, '#10b981') }}</div>
              <div class="route-text">
                <div class="route-label">Toimitus</div>
                <div class="route-address">{{ order.dropoff_address }}</div>
              </div>
            </div>
          </div>

          <!-- Info Grid -->
          <div class="order-card-info">
            <div class="info-item">
              <div class="info-label">Matka</div>
              <div class="info-value">{{ "%.1f"|format(order.distance_km|float) }} km</div>
            </div>
            <div class="info-item price-item">
              <div class="info-label">Hinta</div>
              <div class="info-value price-value">
                <div class="price-main-mobile">{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</div>
                <div class="price-vat-mobile">ALV 0%</div>
              </div>
            </div>
          </div>

          <!-- Price Details (Expandable) -->
          <details class="price-details-toggle">
            <summary class="price-details-summary">Näytä hinnan erittely</summary>
            <div class="price-details-content">
              <div class="price-detail-row">
                <span>Hinta (ALV 0%)</span>
                <span>{{ "%.2f"|format((order.price_gross|float) / 1.255) }} €</span>
              </div>
              <div class="price-detail-row">
                <span>ALV 25,5%</span>
                <span>{{ "%.2f"|format((order.price_gross|float) - ((order.price_gross|float) / 1.255)) }} €</span>
              </div>
              <div class="price-detail-row total">
                <span>Yhteensä</span>
                <span>{{ "%.2f"|format(order.price_gross|float) }} €</span>
              </div>
            </div>
          </details>

          <!-- Action Buttons -->
          <div class="order-card-actions">
            <a href="/order/{{ order.id }}" class="order-card-action" aria-label="Avaa tilaus {{ order.id }}">
              Avaa tilaus
              {{ icons.eye(18, '#ffffff') }}
            </a>
            {% if order.status in ['DELIVERED', 'COMPLETED'] and order.driver_id %}
            <a href="/order/{{ order.id }}/rate" class="order-card-rate" aria-label="Arvostele kuljetus">
              ⭐ Arvostele
            </a>
            {% endif %}
          </div>
        </article>
        {% endfor %}
        {% endif %}
      </div>
      <div id="cardsEmpty" class="user-orders-empty" style="display: none;">
        <div class="empty-state">
          {{ icons.package(64, '#94a3b8') }}
          <div class="empty-title">Ei tilauksia</div>
          <div class="empty-text">Luo ensimmäinen tilauksesi yllä olevalla napilla</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tabActive = document.getElementById('tabActive');
    const tabCompleted = document.getElementById('tabCompleted');
    const tableRows = document.querySelectorAll('.order-row');
    const cardItems = document.querySelectorAll('.order-card-item');
    const tableEmpty = document.getElementById('tableEmpty');
    const cardsEmpty = document.getElementById('cardsEmpty');
    const ordersCount = document.getElementById('ordersCount');
    const emptyText = document.getElementById('emptyText');

    let currentTab = 'active';

    function filterOrders(tab) {
      currentTab = tab;
      let visibleCount = 0;

      // Update tab buttons
      if (tab === 'active') {
        tabActive.classList.remove('btn-ghost');
        tabActive.classList.add('btn-primary');
        tabCompleted.classList.remove('btn-primary');
        tabCompleted.classList.add('btn-ghost');
      } else {
        tabCompleted.classList.remove('btn-ghost');
        tabCompleted.classList.add('btn-primary');
        tabActive.classList.remove('btn-primary');
        tabActive.classList.add('btn-ghost');
      }

      // Filter table rows
      tableRows.forEach(row => {
        if (row.dataset.status === tab) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      // Filter card items
      cardItems.forEach(card => {
        if (card.dataset.status === tab) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });

      // Update count
      const tabText = tab === 'active' ? 'aktiivista' : 'valmistunutta';
      ordersCount.textContent = visibleCount + ' ' + tabText;

      // Show/hide empty state
      const showEmpty = visibleCount === 0;
      if (tableEmpty) tableEmpty.style.display = showEmpty ? '' : 'none';
      if (cardsEmpty) cardsEmpty.style.display = showEmpty ? '' : 'none';

      // Update empty text
      if (emptyText) {
        emptyText.textContent = tab === 'active'
          ? 'Luo ensimmäinen tilauksesi yllä olevalla napilla'
          : 'Ei valmistuneita tilauksia';
      }

      // Update URL without reload (for bookmarking)
      const url = new URL(window.location);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, '', url);
    }

    // Add click handlers
    tabActive.addEventListener('click', () => filterOrders('active'));
    tabCompleted.addEventListener('click', () => filterOrders('completed'));

    // Initialize based on URL param or default to active
    const urlParams = new URLSearchParams(window.location.search);
    const initialTab = urlParams.get('tab') || 'active';
    filterOrders(initialTab);
  });
</script>
{% endblock %}