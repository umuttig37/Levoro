{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Työ #{{ order.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/driver-job-detail.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/driver-image-upload.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container driver-job-detail">
  <div class="section-padding">
    <div class="driver-job-header-section">
      <h1 class="calculator-title">Työ #{{ order.id }}</h1>
      <p class="calculator-subtitle">
        {% if order.status == 'CONFIRMED' and not order.driver_id %}Saatavilla oleva työ
        {% elif order.driver_id == driver.id %}Sinulle määritetty työ
        {% else %}Työn yksityiskohdat{% endif %}
      </p>
    </div>
  </div>

  <div class="mb-4">
    <a href="{{ url_for('driver.dashboard') }}" class="btn btn-ghost driver-back-btn"
      aria-label="Palaa takaisin työpöydälle">
      ← Takaisin työpöydälle
    </a>
  </div>

  <!-- Job Status -->
  <div class="card driver-detail-card mb-6" role="region" aria-labelledby="status-title">
    <div class="card-header">
      <h2 id="status-title" class="card-title">Työn tila</h2>
    </div>
    <div class="card-body">
      <div class="flex items-center justify-center">
        {% set progress = order.driver_progress or {} %}
        <span class="driver-status-badge
          {% if order.status == 'CONFIRMED' and not order.driver_id %}bg-green-100 text-green-800
          {% elif not progress %}bg-blue-100 text-blue-800
          {% elif progress.marked_complete %}bg-emerald-100 text-emerald-800
          {% elif progress.delivery_images_complete %}bg-pink-100 text-pink-800
          {% elif progress.arrived_at_delivery %}bg-indigo-100 text-indigo-800
          {% elif progress.started_transit %}bg-purple-100 text-purple-800
          {% elif progress.pickup_images_complete %}bg-orange-100 text-orange-800
          {% elif progress.arrived_at_pickup %}bg-yellow-100 text-yellow-800
          {% else %}bg-gray-100 text-gray-800{% endif %}" role="status" aria-label="Työn tila">
          {% if order.status == 'CONFIRMED' and not order.driver_id %}Saatavilla
          {% elif not progress %}Työ otettu vastaan
          {% elif progress.marked_complete %}Toimitus merkitty valmiiksi
          {% elif progress.delivery_images_complete %}Toimituskuvat vahvistettu
          {% elif progress.arrived_at_delivery %}Saapunut toimituspaikalle
          {% elif progress.started_transit %}Kuljetus aloitettu
          {% elif progress.pickup_images_complete %}Noutokuvat vahvistettu
          {% elif progress.arrived_at_pickup %}Saapunut noutopaikalle
          {% else %}Määritetty sinulle{% endif %}
        </span>
      </div>
    </div>
  </div>

  <!-- Job Details -->
  <div class="driver-grid">
    <div>
      <!-- Consolidated Order Details Card -->
      <div class="card driver-detail-card mb-6" role="region" aria-labelledby="order-details-title">
        <div class="card-header">
          <h2 id="order-details-title" class="card-title">
            {{ icons.clipboard(20, 'currentColor', 'icon-inline') }}
            Tilauksen tiedot
          </h2>
        </div>
        <div class="card-body">
          <div class="driver-form-section">
            <!-- Route -->
            <div class="driver-subsection">
              <div class="driver-form-group">
                <label class="driver-form-label">Noutopaikka</label>
                {% if order.driver_id == driver.id %}
                <p class="driver-form-value">{{ order.pickup_address }}</p>
                {% else %}
                <p class="driver-form-value">{{ order.pickup_address|extract_city }}</p>
                <p class="driver-address-hint">Tarkka osoite näkyy kun otat työn vastaan</p>
                {% endif %}
              </div>
              <div class="driver-form-group">
                <label class="driver-form-label">Toimituspaikka</label>
                {% if order.driver_id == driver.id %}
                <p class="driver-form-value">{{ order.dropoff_address }}</p>
                {% else %}
                <p class="driver-form-value">{{ order.dropoff_address|extract_city }}</p>
                <p class="driver-address-hint">Tarkka osoite näkyy kun otat työn vastaan</p>
                {% endif %}
              </div>
            </div>

            <!-- Distance & Reward -->
            <div class="driver-metrics-grid">
              <div class="driver-form-group">
                <label class="driver-form-label">Matka</label>
                <p class="driver-form-value distance">{{ order.distance_km|default(0)|round(1) }} km</p>
              </div>
              <div class="driver-form-group">
                <label class="driver-form-label">Palkkio</label>
                <p class="driver-form-value reward"
                  aria-label="Palkkio {{ order.driver_reward|round(2) if order.driver_reward else 0.00 }} euroa">
                  {% if order.driver_reward %}{{ order.driver_reward|round(2) }}{% else %}0.00{% endif %} €
                </p>
              </div>
            </div>

            <!-- Pickup Date -->
            {% if order.pickup_date %}
            <div class="driver-form-group">
              <label class="driver-form-label">Viimeinen noutopäivä</label>
              <p class="driver-form-value" style="font-weight: 700; color: #1f2937;">{{ order.pickup_date|finnish_date
                }}</p>
            </div>
            {% endif %}

            <!-- Car Brand/Model - Always visible if set -->
            {% if order.car_brand or order.car_model %}
            <div class="driver-form-group">
              <label class="driver-form-label">Auton merkki ja malli</label>
              <p class="driver-form-value">{{ order.car_brand or '' }} {{ order.car_model or '' }}</p>
            </div>
            {% endif %}

            <!-- Vehicle Details - Only for assigned driver -->
            {% if order.driver_id == driver.id %}
            {% if order.reg_number %}
            <div class="driver-form-group">
              <label class="driver-form-label">Rekisterinumero</label>
              <p class="driver-form-value">{{ order.reg_number }}</p>
            </div>
            {% endif %}
            {% if order.winter_tires is not none %}
            <div class="driver-form-group">
              <label class="driver-form-label">Talvirenkaat</label>
              <p class="driver-form-value">{{ "Kyllä" if order.winter_tires else "Ei" }}</p>
            </div>
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Contact Information - Only show if job is accepted -->
      {% if order.driver_id == driver.id and order.status != 'NEW' %}
      <div class="card driver-detail-card mb-6" role="region" aria-labelledby="contact-title">
        <div class="card-header">
          <h2 id="contact-title" class="card-title">
            {{ icons.phone(20, 'currentColor', 'icon-inline') }}
            Yhteystiedot
          </h2>
        </div>
        <div class="card-body">
          <div class="driver-form-section">
            <!-- Orderer Section -->
            <div class="driver-contact-section orderer">
              <h3 class="driver-contact-section-title">
                {{ icons.building(18, '#1e40af', 'icon-inline') }} Tilaaja
              </h3>
              <div class="driver-form-section">
                <div class="driver-form-group">
                  <label class="driver-form-label">Nimi</label>
                  <p class="driver-form-value">{{ order.orderer_name or order.user_name or '-' }}</p>
                </div>
                <div class="driver-form-group">
                  <label class="driver-form-label">Sähköposti</label>
                  <p class="driver-form-value">{{ order.orderer_email or order.user_email or '-' }}</p>
                </div>
                <div class="driver-form-group">
                  <label class="driver-form-label">Puhelin</label>
                  <p class="driver-form-value">
                    {% if order.orderer_phone %}
                    <a href="tel:{{ order.orderer_phone }}"
                      aria-label="Soita tilaajan numeroon {{ order.orderer_phone }}">
                      {{ order.orderer_phone }}
                    </a>
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>

            <!-- Customer Section -->
            <div class="driver-contact-section customer">
              <h3 class="driver-contact-section-title">
                {{ icons.user(18, '#854d0e', 'icon-inline') }} Asiakas (vastaanottaja)
              </h3>
              <div class="driver-form-section">
                <div class="driver-form-group">
                  <label class="driver-form-label">Nimi</label>
                  <p class="driver-form-value">{{ order.customer_name or '-' }}</p>
                </div>
                <div class="driver-form-group">
                  <label class="driver-form-label">Puhelinnumero</label>
                  <p class="driver-form-value">
                    {% if order.customer_phone or order.phone %}
                    <a href="tel:{{ order.customer_phone or order.phone }}"
                      aria-label="Soita asiakkaan numeroon {{ order.customer_phone or order.phone }}">
                      {{ order.customer_phone or order.phone }}
                    </a>
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Consolidated Instructions & Notes Card -->
      {% set has_additional_info = order.additional_info and order.additional_info|trim %}
      {% set has_driver_notes = order.driver_id == driver.id and order.driver_notes and order.driver_notes|trim %}
      {% set has_customer_extras = order.extras and order.extras|trim %}

      {% if has_additional_info or has_driver_notes or has_customer_extras %}
      <div class="card driver-detail-card mb-6" role="region" aria-labelledby="instructions-title">
        <div class="card-header">
          <h2 id="instructions-title" class="card-title">
            {{ icons.document(20, 'currentColor', 'icon-inline') }}
            Ohjeet ja lisätiedot
          </h2>
        </div>
        <div class="card-body">
          <div class="driver-form-section">
            <!-- Admin Instructions (visible to all drivers) -->
            {% if has_additional_info %}
            <div class="driver-info-subsection">
              <label class="driver-form-label">Tilaajan tiedot</label>
              <p class="driver-admin-notes">{{ order.additional_info }}</p>
            </div>
            {% endif %}

            <!-- Driver-Specific Notes (only for assigned driver) -->
            {% if has_driver_notes %}
            <div class="driver-info-subsection driver-notes-subsection">
              <label class="driver-form-label driver-notes-label">
                {{ icons.lock(16, '#065f46', 'icon-inline') }}
                Lisätiedot sinulle
              </label>
              <p class="driver-admin-notes driver-notes-content">{{ order.driver_notes }}</p>
            </div>
            {% endif %}

            <!-- Customer Extras -->
            {% if has_customer_extras %}
            <div class="driver-info-subsection">
              <label class="driver-form-label">Asiakkaan lisätiedot</label>
              <p class="driver-form-value">{{ order.extras }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Images Section -->
      {% if order.driver_id == driver.id %}
      <div class="card driver-detail-card mb-6" role="region" aria-labelledby="images-title">
        <div class="card-header">
          <h2 id="images-title" class="card-title">
            {{ icons.camera(20, 'currentColor', 'icon-inline') }}
            Kuvat
          </h2>
        </div>
        <div class="card-body">
          <div class="driver-images-grid">
            <!-- Pickup Images -->
            <div class="driver-images-section">
              {% set pickup_images = order.images.pickup if order.images and order.images.pickup else [] %}
              {% set image_type = 'pickup' %}
              {% set images_data = pickup_images %}
              {% set can_upload = (progress.arrived_at_pickup and not progress.started_transit) %}
              {% include 'components/driver_image_section.html' %}

              <!-- Confirm Pickup Images Button -->
              {% if progress.arrived_at_pickup and not progress.pickup_images_complete %}
              <form method="POST" action="{{ url_for('driver.confirm_pickup_images', order_id=order.id) }}"
                style="margin-top: 1rem;">
                <button type="submit" class="btn btn-primary w-full" id="confirm-pickup-btn" {% if pickup_images|length
                  < 5 %}disabled{% endif %} data-min-images="5" data-current-images="{{ pickup_images|length }}"
                  aria-label="Vahvista noutokuvat">
                  Vahvista noutokuvat (min. 5 kuvaa)
                </button>
                {% if pickup_images|length < 5 %} <p class="driver-action-hint"
                  style="text-align: center; margin-top: 0.5rem;">
                  Lataa vielä {{ 5 - pickup_images|length }} kuvaa
                  </p>
                  {% endif %}
              </form>
              {% endif %}
            </div>

            <!-- Delivery Images -->
            <div class="driver-images-section">
              {% set delivery_images = order.images.delivery if order.images and order.images.delivery else [] %}
              {% set image_type = 'delivery' %}
              {% set images_data = delivery_images %}
              {% set can_upload = (progress.arrived_at_delivery and not progress.delivery_images_complete) %}
              {% include 'components/driver_image_section.html' %}

              <!-- Confirm Delivery Images Button -->
              {% if progress.arrived_at_delivery and not progress.delivery_images_complete %}
              <form method="POST" action="{{ url_for('driver.confirm_delivery_images', order_id=order.id) }}"
                style="margin-top: 1rem;">
                <button type="submit" class="btn btn-primary w-full" id="confirm-delivery-btn" {% if
                  delivery_images|length < 5 %}disabled{% endif %} data-min-images="5"
                  data-current-images="{{ delivery_images|length }}" aria-label="Vahvista toimituskuvat">
                  Vahvista toimituskuvat (min. 5 kuvaa)
                </button>
                {% if delivery_images|length < 5 %} <p class="driver-action-hint"
                  style="text-align: center; margin-top: 0.5rem;">
                  Lataa vielä {{ 5 - delivery_images|length }} kuvaa
                  </p>
                  {% endif %}
              </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Actions Panel - Bottom Duplicate for Convenience -->
  <div class="driver-actions-panel-bottom mt-6">
    <div class="card driver-detail-card" role="region" aria-labelledby="actions-title-bottom">
      <div class="card-header">
        <h2 id="actions-title-bottom" class="card-title">Toiminnot</h2>
      </div>
      <div class="card-body">
        <div class="space-y-3">
          {% if order.status == 'CONFIRMED' and not order.driver_id %}
          <!-- Job is available for assignment -->
          <form method="POST" action="{{ url_for('driver.accept_job', order_id=order.id) }}">
            <button type="submit" class="btn btn-primary w-full"
              onclick="return confirm('Haluatko varmasti ottaa tämän työn vastaan?')" aria-label="Ota työ vastaan">
              Ota työ vastaan
            </button>
          </form>

          {% elif order.driver_id == driver.id %}
          <!-- Job belongs to this driver - use driver_progress -->

          {% if not progress %}
          <!-- Just accepted, no progress yet -->
          <form method="POST" action="{{ url_for('driver.arrive_pickup', order_id=order.id) }}">
            <button type="submit" class="btn btn-primary w-full" aria-label="Kuittaa saapuminen noutopaikalle">
              {{ icons.location(18, 'currentColor', 'icon-inline') }} Saavuin noutopaikalle
            </button>
          </form>

          {% elif progress.marked_complete %}
          <!-- Driver marked complete, waiting for admin to set DELIVERED -->
          <div class="driver-completed-state">
            <div class="completed-icon">{{ icons.check_circle(48, '#16a34a') }}</div>
            <p class="completed-title">Toimitus merkitty valmiiksi!</p>
          </div>

          {% elif progress.delivery_images_complete %}
          <!-- Delivery images confirmed, can mark complete -->
          <form method="POST" action="{{ url_for('driver.mark_complete', order_id=order.id) }}">
            <button type="submit" class="btn btn-primary w-full" aria-label="Merkitse toimitus valmiiksi">
              {{ icons.check_circle(18, 'currentColor', 'icon-inline') }} Toimitettu
            </button>
          </form>

          {% elif progress.arrived_at_delivery and not progress.delivery_images_complete %}
          <!-- At delivery, need to upload & confirm images -->
          <button type="button" class="btn btn-primary w-full scroll-to-images-btn" data-scroll-target="images-title">
            {{ icons.camera(18, 'currentColor', 'icon-inline') }} Lisää toimituskuvat
          </button>

          {% elif progress.started_transit and not progress.arrived_at_delivery %}
          <!-- In transit, can mark delivery arrival -->
          <form method="POST" action="{{ url_for('driver.arrive_delivery', order_id=order.id) }}">
            <button type="submit" class="btn btn-primary w-full" aria-label="Kuittaa saapuminen toimituspaikalle">
              {{ icons.location(18, 'currentColor', 'icon-inline') }} Saavuin toimituspaikalle
            </button>
          </form>

          {% elif progress.pickup_images_complete and not progress.started_transit %}
          <!-- Pickup confirmed, can start transit -->
          <form method="POST" action="{{ url_for('driver.start_transit', order_id=order.id) }}">
            <button type="submit" class="btn btn-primary w-full" aria-label="Aloita kuljetus">
              Aloita ajo
            </button>
          </form>

          {% elif progress.arrived_at_pickup and not progress.pickup_images_complete %}
          <!-- At pickup, need to upload & confirm images -->
          <button type="button" class="btn btn-primary w-full scroll-to-images-btn" data-scroll-target="images-title">
            {{ icons.camera(18, 'currentColor', 'icon-inline') }} Lisää noutokuvat
          </button>

          {% endif %}

          {% else %}
          <!-- Job belongs to another driver -->
          <div class="driver-other-state">
            <div class="other-icon">{{ icons.user(48, '#94a3b8') }}</div>
            <p class="other-message">Tämä työ on määritetty toiselle kuljettajalle</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Scroll to images section when button is clicked
  document.addEventListener('DOMContentLoaded', function () {
    const scrollButtons = document.querySelectorAll('.scroll-to-images-btn');

    scrollButtons.forEach(button => {
      button.addEventListener('click', function () {
        const targetId = this.dataset.scrollTarget;
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });

          // Flash the target element to draw attention
          const card = targetElement.closest('.card');
          if (card) {
            card.style.transition = 'box-shadow 0.3s ease';
            card.style.boxShadow = '0 0 0 4px rgba(59, 130, 246, 0.5)';
            setTimeout(() => {
              card.style.boxShadow = '';
            }, 1500);
          }
        }
      });
    });
  });
</script>

{% endblock %}