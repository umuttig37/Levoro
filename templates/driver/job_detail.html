{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Työ #{{ order.id }}{% endblock %}

{% block content %}
<div class="container">
  <div class="sect              <h3 style=" margin: 0 0 0.5rem 0; color: #1e40af; font-size: 0.875rem; font-weight:
    600;">
    {{ icons.building(16, '#1e40af', 'icon-inline') }} Tilaaja
    </h3>-padding">
    <div class="text-center mb-8">
      <h1 class="calculator-title">Työ #{{ order.id }}</h1>
      <p class="calculator-subtitle">
      <div class="text-center">
        <div class="mb-3">{{ icons.clipboard(48, '#94a3b8') }}</div>
        <p class="text-sm text-secondary">Odottaa admin hyväksyntää</p>
        <p class="text-xs text-secondary mt-1">Admin vahvistaa noutokuvat ja aloittaa kuljetuksen</p>
      </div>

      {% elif order.status == 'IN_TRANSIT' %} order.sta <div class="text-center">
        <div class="mb-3">{{ icons.clipboard(48, '#94a3b8') }}</div>
        <p class="text-sm text-secondary">Odottaa admin hyväksyntää</p>
        <p class="text-xs text-secondary mt-1">Admin vahvistaa toimituskuvat ja päättää toimituksen</p>
      </div>

      {% elif order.status == 'DELIVERED' %}'CONFIRMED' and not order.driver_id %}Saatavilla oleva työ
      {% elif order.driver_id == driver.id %}Sinulle määritetty työ
      {% else %}Työn yksityiskohdat{% endif %}
      </p>
    </div>
  </div>

  <div class="mb-4">
    <a href="{{ url_for('driver.dashboard') }}" class="btn btn-ghost">← Takaisin työpöydälle</a>
  </div>

  <!-- Job Status -->
  <div class="card mb-6">
    <div class="card-header">
      <h2 class="card-title">Työn tila</h2>
    </div>
    <div class="card-body">
      <div class="flex items-center justify-between">
        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium
          {% if order.status == 'CONFIRMED' %}bg-green-100 text-green-800
          {% elif order.status == 'ASSIGNED_TO_DRIVER' %}bg-blue-100 text-blue-800
          {% elif order.status == 'DRIVER_ARRIVED' %}bg-yellow-100 text-yellow-800
          {% elif order.status == 'PICKUP_IMAGES_ADDED' %}bg-orange-100 text-orange-800
          {% elif order.status == 'IN_TRANSIT' %}bg-purple-100 text-purple-800
          {% elif order.status == 'DELIVERY_ARRIVED' %}bg-indigo-100 text-indigo-800
          {% elif order.status == 'DELIVERY_IMAGES_ADDED' %}bg-pink-100 text-pink-800
          {% elif order.status == 'DELIVERED' %}bg-emerald-100 text-emerald-800
          {% else %}bg-gray-100 text-gray-800{% endif %}">
          {% if order.status == 'CONFIRMED' %}Saatavilla
          {% elif order.status == 'ASSIGNED_TO_DRIVER' %}Määritetty sinulle
          {% elif order.status == 'DRIVER_ARRIVED' %}Saapunut noutopaikalle
          {% elif order.status == 'PICKUP_IMAGES_ADDED' %}Noutokuvat lisätty
          {% elif order.status == 'IN_TRANSIT' %}Kuljetuksessa
          {% elif order.status == 'DELIVERY_ARRIVED' %}Kuljetus saapunut
          {% elif order.status == 'DELIVERY_IMAGES_ADDED' %}Toimituskuvat lisätty
          {% elif order.status == 'DELIVERED' %}Toimitettu
          {% else %}{{ order.status }}{% endif %}
        </span>
      </div>
    </div>
  </div>

  <!-- Job Details -->
  <div class="driver-grid">
    <div>
      <!-- Route Information -->
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Reittitiedot</h2>
        </div>
        <div class="card-body">
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Noutopaikka</label>
              {% if order.driver_id == driver.id %}
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.pickup_address }}</p>
              {% else %}
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.pickup_address|extract_city }}
              </p>
              <p class="text-xs text-muted" style="margin: 0.125rem 0 0 0; font-size: 0.7rem;">Tarkka osoite näkyy kun
                otat työn vastaan</p>
              {% endif %}
            </div>
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Toimituspaikka</label>
              {% if order.driver_id == driver.id %}
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.dropoff_address }}</p>
              {% else %}
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.dropoff_address|extract_city }}
              </p>
              <p class="text-xs text-muted" style="margin: 0.125rem 0 0 0; font-size: 0.7rem;">Tarkka osoite näkyy kun
                otat työn vastaan</p>
              {% endif %}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Matka</label>
                <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.distance_km|default(0)|round(1)
                  }} km</p>
              </div>
              <div>
                <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Palkkio</label>
                <p class="text-primary" style="margin: 0; font-size: 1.2em; font-weight: 700; color: #059669;">{% if
                  order.driver_reward %}{{ order.driver_reward|round(2) }}{% else %}0.00{% endif %} €</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Car Information - ALWAYS visible if set by admin -->
      {% if order.car_brand or order.car_model %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Ajoneuvo</h2>
        </div>
        <div class="card-body">
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Merkki ja malli</label>
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.car_brand or '' }} {{
                order.car_model or '' }}</p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Vehicle Information - Only show if job is accepted -->
      {% if (order.reg_number or order.winter_tires is not none) and order.driver_id == driver.id %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Ajoneuvotiedot</h2>
        </div>
        <div class="card-body">
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            {% if order.reg_number %}
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Rekisterinumero</label>
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.reg_number }}</p>
            </div>
            {% endif %}
            {% if order.winter_tires is not none %}
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Talvirenkaat</label>
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ "Kyllä" if order.winter_tires else "Ei"
                }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Contact Information - Only show if job is accepted -->
      {% if order.driver_id == driver.id and order.status != 'NEW' %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Yhteystiedot</h2>
        </div>
        <div class="card-body">
          <div class="space-y-3">
            <!-- Orderer Section -->
            <div style="background: #f0f9ff; padding: 0.75rem; border-radius: 6px; border: 1px solid #bfdbfe;">
              <h3 style="margin: 0 0 0.5rem 0; color: #1e40af; font-size: 0.875rem; font-weight: 600;">
                {{ icons.building(16, '#1e40af', 'icon-inline') }} Tilaaja
              </h3>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div>
                  <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Nimi</label>
                  <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.orderer_name or
                    order.user_name or '-' }}</p>
                </div>
                <div>
                  <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Sähköposti</label>
                  <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.orderer_email or
                    order.user_email or '-' }}</p>
                </div>
                <div>
                  <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Puhelin</label>
                  <p class="text-primary" style="margin: 0; font-size: 0.875rem;">
                    {% if order.orderer_phone %}
                    <a href="tel:{{ order.orderer_phone }}" style="color: #2563eb; text-decoration: none;">{{
                      order.orderer_phone }}</a>
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>

            <!-- Customer Section -->
            <div style="background: #fefce8; padding: 0.75rem; border-radius: 6px; border: 1px solid #fde047;">
              <h3 style="margin: 0 0 0.5rem 0; color: #854d0e; font-size: 0.875rem; font-weight: 600;">
                {{ icons.user(16, '#854d0e', 'icon-inline') }} Asiakas (vastaanottaja)
              </h3>
              <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div>
                  <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Nimi</label>
                  <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.customer_name or '-' }}</p>
                </div>
                <div>
                  <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Puhelinnumero</label>
                  <p class="text-primary" style="margin: 0; font-size: 0.875rem;">
                    {% if order.customer_phone or order.phone %}
                    <a href="tel:{{ order.customer_phone or order.phone }}"
                      style="color: #854d0e; text-decoration: none;">{{ order.customer_phone or order.phone }}</a>
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Admin Notes (Lisätiedot) - Always visible if set by admin -->
      {% if order.additional_info and order.additional_info|trim %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Ohjeita kuljettajalle</h2>
        </div>
        <div class="card-body">
          <p style="white-space: pre-wrap; margin: 0; font-size: 0.875rem; line-height: 1.5;">{{ order.additional_info
            }}</p>
        </div>
      </div>
      {% endif %}

      <!-- Additional Information -->
      {% if order.extras or order.pickup_date %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Lisätiedot</h2>
        </div>
        <div class="card-body">
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            {% if order.pickup_date %}
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Toivottu noutopäivä</label>
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.pickup_date }}</p>
            </div>
            {% endif %}
            {% if order.extras %}
            <div>
              <label class="form-label" style="margin-bottom: 0.125rem; font-size: 0.75rem;">Lisätiedot</label>
              <p class="text-primary" style="margin: 0; font-size: 0.875rem;">{{ order.extras }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Images Section -->
      {% if order.driver_id == driver.id %}
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Kuvat</h2>
        </div>
        <div class="card-body">
          <div class="driver-images-grid">
            <!-- Pickup Images -->
            <div class="driver-images-section">
              {% set pickup_images = order.images.pickup if order.images and order.images.pickup else [] %}
              {% set image_type = 'pickup' %}
              {% set images_data = pickup_images %}
              {% set can_upload = (order.status in ['DRIVER_ARRIVED', 'PICKUP_IMAGES_ADDED']) %}
              {% include 'components/driver_image_section.html' %}
            </div>

            <!-- Delivery Images -->
            <div class="driver-images-section">
              {% set delivery_images = order.images.delivery if order.images and order.images.delivery else [] %}
              {% set image_type = 'delivery' %}
              {% set images_data = delivery_images %}
              {% set can_upload = (order.status in ['DELIVERY_ARRIVED', 'DELIVERY_IMAGES_ADDED']) %}
              {% include 'components/driver_image_section.html' %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Actions Panel -->
    <div class="driver-actions-panel">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Toiminnot</h2>
        </div>
        <div class="card-body">
          <div class="space-y-3">
            {% if order.status == 'CONFIRMED' and not order.driver_id %}
            <!-- Job is available for assignment -->
            <form method="POST" action="{{ url_for('driver.accept_job', order_id=order.id) }}">
              <button type="submit" class="btn btn-primary w-full"
                onclick="return confirm('Haluatko varmasti ottaa tämän työn vastaan?')">
                Ota työ vastaan
              </button>
            </form>
            <p class="text-xs text-muted mt-2">Ajoneuvon tiedot ja tarkat osoitteet tulevat näkyviin kun kuitattu
              napilla olevan paikalla</p>

            {% elif order.driver_id == driver.id %}
            <!-- Job belongs to this driver -->
            {% if order.status == 'ASSIGNED_TO_DRIVER' %}
            <form method="POST" action="{{ url_for('driver.mark_arrival', order_id=order.id) }}">
              <button type="submit" class="btn btn-primary w-full">
                {{ icons.location(18, 'currentColor', 'icon-inline') }} Saavuin noutopaikalle
              </button>
            </form>

            {% elif order.status == 'DRIVER_ARRIVED' %}
            <p class="text-sm text-secondary mb-3">Lisää noutokuvat ennen kuljetuksen aloittamista</p>

            {% elif order.status == 'PICKUP_IMAGES_ADDED' %}
            <div class="text-center">
              <div class="mb-2">{{ icons.circle(48, '#94a3b8') }}</div>
              <p class="text-sm text-secondary">Odottaa admin hyväksyntää</p>
              <p class="text-xs text-secondary mt-1">Admin vahvistaa noutokuvat ja aloittaa kuljetuksen</p>
            </div>

            {% elif order.status == 'IN_TRANSIT' %}
            <form method="POST" action="{{ url_for('driver.arrive_delivery', order_id=order.id) }}">
              <button type="submit" class="btn btn-primary w-full">
                {{ icons.location(18, 'currentColor', 'icon-inline') }} Saavuin toimituspaikalle
              </button>
            </form>

            {% elif order.status == 'DELIVERY_ARRIVED' %}
            <p class="text-sm text-secondary mb-3">Lisää toimituskuvat ennen toimituksen päättämistä</p>

            {% elif order.status == 'DELIVERY_IMAGES_ADDED' %}
            <div class="text-center">
              <div class="mb-2">{{ icons.circle(48, '#94a3b8') }}</div>
              <p class="text-sm text-secondary">Odottaa admin hyväksyntää</p>
              <p class="text-xs text-secondary mt-1">Admin vahvistaa toimituskuvat ja päättää toimituksen</p>
            </div>

            {% elif order.status == 'DELIVERED' %}
            <div class="text-center">
              <div class="mb-3">{{ icons.check_circle(48, '#16a34a') }}</div>
              <p class="font-semibold text-green-600">Toimitus suoritettu!</p>
            </div>
            {% endif %}

            {% else %}
            <!-- Job belongs to another driver -->
            <div class="text-center">
              <div class="mb-3">{{ icons.user(48, '#94a3b8') }}</div>
              <p class="text-sm text-secondary">Tämä työ on määritetty toiselle kuljettajalle</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}