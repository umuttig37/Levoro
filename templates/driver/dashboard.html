{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Kuljettajan työpöytä{% endblock %}

{% block content %}
<div class="container">
  <div class="section-padding">
    <div class="text-center mb-8">
      <h1 class="calculator-title">Tervetuloa, {{ driver.name }}!</h1>
      <p class="calculator-subtitle">Kuljettajan työpöytä</p>
    </div>
  </div>

  <!-- Driver Statistics -->
  <div class="driver-stats-grid">
    <div class="driver-stats-card">
      <div class="driver-stats-header">
        <h3 class="driver-stats-title">Aktiiviset työt</h3>
      </div>
      <div class="driver-stats-body">
        <div class="driver-metric-value active">{{ stats.active_jobs }}</div>
        <p class="driver-metric-label">Käynnissä olevia töitä</p>
      </div>
    </div>

    <div class="driver-stats-card">
      <div class="driver-stats-header">
        <h3 class="driver-stats-title">Suoritetut työt</h3>
      </div>
      <div class="driver-stats-body">
        <div class="driver-metric-value completed">{{ stats.completed_jobs }}</div>
        <p class="driver-metric-label">Valmistuneita töitä</p>
      </div>
    </div>

  </div>

  <!-- Tab Navigation -->
  <div class="driver-tabs">
    <div class="driver-tabs-header">
      <button class="driver-tab-button" data-tab="active">
        Aktiiviset työt
        {% if active_jobs|length > 0 %}
        <span class="driver-tab-badge">{{ active_jobs|length }}</span>
        {% endif %}
      </button>
      <button class="driver-tab-button active" data-tab="available">
        Saatavilla
        {% if available_jobs|length > 0 %}
        <span class="driver-tab-badge">{{ available_jobs|length }}</span>
        {% endif %}
      </button>
      <button class="driver-tab-button" data-tab="history">
        Historia
        {% if all_jobs|selectattr('status', 'equalto', 'DELIVERED')|list|length > 0 %}
        <span class="driver-tab-badge">{{ all_jobs|selectattr('status', 'equalto', 'DELIVERED')|list|length }}</span>
        {% endif %}
      </button>
    </div>

    <!-- Active Jobs Tab Content -->
    <div class="driver-tab-content" id="tab-active">
      {% if active_jobs %}
      <div class="driver-section-body">
        <div class="driver-job-list">
          {% for job in active_jobs %}
          <article class="driver-job-card" role="article" aria-label="Tilaus {{ job.id }}">
            <div class="driver-job-header">
              <div class="driver-job-content">
                <h3 class="driver-job-title">Tilaus #{{ job.id }}</h3>
                <p class="driver-job-route" aria-label="Reitti">{{ job.pickup_address }} → {{ job.dropoff_address }}</p>

                <div class="driver-job-meta">
                  {% if job.pickup_date %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Noutopäivä</span>
                    <span class="driver-job-info-value" style="font-weight: 700; color: #1f2937;">{{
                      job.pickup_date|finnish_date }}</span>
                  </div>
                  {% endif %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Matka</span>
                    <span class="driver-job-info-value">{{ job.distance_km|default(0)|round(1) }} km</span>
                  </div>
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Palkkio</span>
                    <span class="driver-job-info-value large">{% if job.driver_reward %}{{ job.driver_reward|round(2)
                      }}{% else %}0.00{% endif %} €</span>
                  </div>
                </div>

                {% if job.additional_info and job.additional_info|trim %}
                <div class="driver-job-subsection driver-job-admin-notes">
                  <h4 class="driver-job-subsection-title">Tilaajan kommentti</h4>
                  <p class="driver-job-admin-text">{{ job.additional_info[:80] }}{% if job.additional_info|length > 80
                    %}...{% endif %}</p>
                </div>
                {% endif %}

                {% if job.car_brand or job.car_model %}
                <div class="driver-job-subsection">
                  <h4 class="driver-job-subsection-title">Ajoneuvo</h4>
                  <p class="driver-job-info-value">{{ job.car_brand or '' }} {{ job.car_model or '' }}</p>
                </div>
                {% endif %}
              </div>
              <div class="driver-job-actions">
                <span
                  class="driver-job-status {% if job.status == 'CONFIRMED' %}available{% elif job.status == 'ASSIGNED_TO_DRIVER' %}assigned{% elif job.status == 'DRIVER_ARRIVED' %}arrived{% elif job.status == 'PICKUP_IMAGES_ADDED' %}pickup-images{% elif job.status == 'IN_TRANSIT' %}in-transit{% elif job.status == 'DELIVERY_ARRIVED' %}delivery-arrived{% elif job.status == 'DELIVERY_IMAGES_ADDED' %}delivery-images{% else %}available{% endif %}"
                  role="status" aria-label="Tilauksen tila">
                  {{ job.status|translate_status }}
                </span>
                <div class="mt-2">
                  <a href="{{ url_for('driver.job_detail', order_id=job.id) }}" class="btn btn-primary btn-sm"
                    aria-label="Avaa tilaus {{ job.id }}">Avaa työ</a>
                </div>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="driver-empty-state">
        <div class="driver-empty-icon">{{ icons.check_circle(48, '#94a3b8') }}</div>
        <h3 class="driver-empty-title">Ei aktiivisia töitä</h3>
        <p class="driver-empty-message">Kaikki työsi on suoritettu. Hienoa työtä!</p>
      </div>
      {% endif %}
    </div>

    <!-- Available Jobs Tab Content -->
    <div class="driver-tab-content active" id="tab-available">
      {% if available_jobs %}
      <div class="driver-section-body">
        <div class="driver-job-list">
          {% for job in available_jobs %}
          <article class="driver-job-card" role="article" aria-label="Tilaus {{ job.id }}">
            <div class="driver-job-header">
              <div class="driver-job-content">
                <h3 class="driver-job-title">Tilaus #{{ job.id }}</h3>
                <p class="driver-job-route" aria-label="Reitti">{{ job.pickup_address|extract_city }} → {{
                  job.dropoff_address|extract_city }}</p>

                <div class="driver-job-meta">
                  {% if job.pickup_date %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Noutopäivä</span>
                    <span class="driver-job-info-value" style="font-weight: 700; color: #1f2937;">{{
                      job.pickup_date|finnish_date }}</span>
                  </div>
                  {% endif %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Matka</span>
                    <span class="driver-job-info-value">{{ job.distance_km|default(0)|round(1) }} km</span>
                  </div>
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Palkkio</span>
                    <span class="driver-job-info-value large">{% if job.driver_reward %}{{ job.driver_reward|round(2)
                      }}{% else %}0.00{% endif %} €</span>
                  </div>
                </div>

                {% if job.additional_info and job.additional_info|trim %}
                <div class="driver-job-subsection driver-job-admin-notes">
                  <h4 class="driver-job-subsection-title">Tilaajan kommentti</h4>
                  <p class="driver-job-admin-text">{{ job.additional_info[:80] }}{% if job.additional_info|length > 80
                    %}...{% endif %}</p>
                </div>
                {% endif %}

                {% if job.car_brand or job.car_model %}
                <div class="driver-job-subsection">
                  <h4 class="driver-job-subsection-title">Ajoneuvo</h4>
                  <p class="driver-job-info-value">{{ job.car_brand or '' }} {{ job.car_model or '' }}</p>
                </div>
                {% endif %}
              </div>
              <div class="driver-job-actions">
                <span class="driver-job-status available" role="status" aria-label="Tilauksen tila">Saatavilla</span>
                <div class="mt-2">
                  <a href="{{ url_for('driver.job_detail', order_id=job.id) }}" class="btn btn-primary btn-sm"
                    aria-label="Katso tilaus {{ job.id }}">Katso työ</a>
                </div>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="driver-empty-state">
        <div class="driver-empty-icon">{{ icons.package(48, '#94a3b8') }}</div>
        <h3 class="driver-empty-title">Ei saatavilla olevia töitä</h3>
        <p class="driver-empty-message">Tarkista myöhemmin uusien töiden varalta</p>
      </div>
      {% endif %}
    </div>

    <!-- History Tab Content -->
    <div class="driver-tab-content" id="tab-history">
      {% set completed_jobs = all_jobs|selectattr('status', 'equalto', 'DELIVERED')|list %}
      {% if completed_jobs %}
      <div class="driver-section-body">
        <div class="driver-job-list">
          {% for job in completed_jobs %}
          <article class="driver-job-card" role="article" aria-label="Tilaus {{ job.id }}">
            <div class="driver-job-header">
              <div class="driver-job-content">
                <h3 class="driver-job-title">Tilaus #{{ job.id }}</h3>
                <p class="driver-job-route" aria-label="Reitti">{{ job.pickup_address }} → {{ job.dropoff_address }}</p>

                <div class="driver-job-meta">
                  {% if job.pickup_date %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Noutopäivä</span>
                    <span class="driver-job-info-value" style="font-weight: 700; color: #1f2937;">{{
                      job.pickup_date|finnish_date }}</span>
                  </div>
                  {% endif %}
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Matka</span>
                    <span class="driver-job-info-value">{{ job.distance_km|default(0)|round(1) }} km</span>
                  </div>
                  <div class="driver-job-info-row">
                    <span class="driver-job-info-label">Palkkio</span>
                    <span class="driver-job-info-value large">{% if job.driver_reward %}{{ job.driver_reward|round(2)
                      }}{% else %}0.00{% endif %} €</span>
                  </div>
                </div>

                {% if job.car_brand or job.car_model %}
                <div class="driver-job-subsection">
                  <h4 class="driver-job-subsection-title">Ajoneuvo</h4>
                  <p class="driver-job-info-value">{{ job.car_brand or '' }} {{ job.car_model or '' }}</p>
                </div>
                {% endif %}
              </div>
              <div class="driver-job-actions">
                <span class="driver-job-status delivered" role="status" aria-label="Tilauksen tila">Toimitettu</span>
                <div class="mt-2">
                  <a href="{{ url_for('driver.job_detail', order_id=job.id) }}" class="btn btn-ghost btn-sm"
                    aria-label="Katso tilauksen {{ job.id }} tiedot">Katso tiedot</a>
                </div>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="driver-empty-state">
        <div class="driver-empty-icon">{{ icons.clipboard(48, '#94a3b8') }}</div>
        <h3 class="driver-empty-title">Ei vielä suoritettuja töitä</h3>
        <p class="driver-empty-message">Suoritetut työt näkyvät täällä</p>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', function () {
      const tabButtons = document.querySelectorAll('.driver-tab-button');
      const tabContents = document.querySelectorAll('.driver-tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          const targetTab = this.getAttribute('data-tab');

          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked button and corresponding content
          this.classList.add('active');
          const targetContent = document.getElementById('tab-' + targetTab);
          if (targetContent) {
            targetContent.classList.add('active');
          }
        });
      });
    });
  </script>
</div>
{% endblock %}