<!DOCTYPE html>
<html lang="fi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Levoro - Kuljetushintalaskuri</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#2563eb", // Royal Blue
                        secondary: "#10b981", // Emerald Green
                        "brand-gradient-start": "#3b82f6",
                        "brand-gradient-end": "#2563eb",
                        "background-light": "#f3f6fa", // Very light cool gray/blueish tint
                        "background-dark": "#0f172a",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.6rem",
                        xl: "1.25rem",
                        '2xl': "1.75rem",
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.03), 0 2px 8px -2px rgba(0, 0, 0, 0.02)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 8px 30px rgba(0,0,0,0.04)',
                        'card-hover': '0 0 0 1px rgba(0,0,0,0.03), 0 20px 40px rgba(0,0,0,0.06)',
                        'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(59, 130, 246, 0.5)'
                    }
                },
            },
        };
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Main CSS (for header styles) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(circle at top center, #f8fafc 0%, #eff6ff 40%, #f3f6fa 100%);
        }

        .dark body {
            background-image: none;
        }

        .map-marker {
            position: absolute;
            transform: translate(-50%, -100%);
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--tw-gradient-stops));
            background-size: 200% 200%;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            background-position: 100% 0;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
        }

        /* AutoComplete Styles */
        .autocomplete {
            position: relative;
        }

        .ac-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .ac-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
            color: #334155;
            transition: all 0.2s;
        }

        .ac-item:last-child {
            border-bottom: none;
        }

        .ac-item:hover,
        .ac-item.active {
            background: #f8fafc;
            color: #2563eb;
            padding-left: 20px;
        }

        .ac-item strong {
            color: #0f172a;
            font-weight: 600;
        }

        /* Loading & Error */
        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
            cursor: wait;
        }

        .ac-loading {
            padding: 12px;
            color: #64748b;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Map specific */
        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
            z-index: 10;
            border-radius: 0.75rem;
        }

        .distance-label {
            background: white;
            border-radius: 20px;
            padding: 4px 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: #2563eb;
            border: 2px solid #2563eb;
            white-space: nowrap;
            text-align: center;
        }
    </style>
</head>

<body data-saved-addresses='{{ (saved_addresses or []) | tojson | safe }}'>


    <!-- Header (same as landing page) -->
    <header class="header" style="z-index: 99999; background: white;">
        <div class="container">
            <div class="header-inner">
                <!-- Brand Logo -->
                <div class="brand">
                    <a href="/" class="brand-link" aria-label="Etusivu">
                        <img src="{{ url_for('static', filename='LevoroLogo.png') }}" alt="" class="brand-logo">
                    </a>
                </div>

                <!-- Mobile Menu Toggle -->
                <button class="mobile-menu-toggle" aria-label="Avaa menu" id="mobile-menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

                <!-- Navigation -->
                <nav class="nav" id="nav-menu">
                    <a href="/" class="nav-link">Etusivu</a>
                    <a href="/#contact" class="nav-link">Yhteystiedot</a>

                    <!-- Role-based navigation -->
                    {% if current_user and current_user.get('role') == 'driver' %}
                    <a href="/driver/dashboard" class="nav-link">Kuljettajan sivu</a>
                    {% elif current_user and current_user.get('role') == 'admin' %}
                    <!-- Admin users don't need Oma sivu link -->
                    {% elif current_user %}
                    <a href="/dashboard" class="nav-link">Oma sivu</a>
                    {% endif %}

                    <!-- Admin Link -->
                    {% if current_user and current_user.get('role') == 'admin' %}
                    <a href="/admin" class="nav-link">Admin</a>
                    {% endif %}

                    <!-- Auth Links -->
                    {% if current_user %}
                    <span class="pill">Hei, {{ current_user.get('name', 'K√§ytt√§j√§') }}</span>
                    <a class="nav-link" href="/logout">Kirjaudu ulos</a>
                    {% else %}
                    <a href="/login" class="nav-link">Kirjaudu</a>
                    <a href="/register" class="nav-link">Luo tili</a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </header>

    <main class="container" style="padding-top: 3rem; padding-bottom: 3rem;">
        <!-- Header -->
        <div class="text-center mb-16 space-y-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 dark:text-white tracking-tight">
                Laske kuljetushinta
            </h1>
            <p class="text-slate-500 dark:text-slate-400 max-w-xl mx-auto text-lg font-light leading-relaxed">
                Hanki tarkka hinta-arvio ja reittisuunnitelma sekunneissa. Sy√∂t√§ vain l√§ht√∂- ja kohdeosoite.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Left Column: Form -->
            <div class="lg:col-span-5 space-y-6">
                <div
                    class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-card hover:shadow-card-hover transition-shadow duration-300 p-8">
                    <div class="mb-8">
                        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Reitin tiedot</h2>
                        <p class="text-xs text-slate-400 font-medium mt-1">Aloita sy√∂tt√§m√§ll√§ osoitteet</p>
                    </div>

                    <div class="space-y-6">
                        <!-- From Address -->
                        <div class="group">
                            <label
                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 pl-1"
                                for="from">L√§ht√∂osoite</label>
                            <div
                                class="relative transition-all duration-300 focus-within:transform focus-within:-translate-y-0.5 autocomplete">
                                <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <span
                                        class="material-symbols-outlined text-lg text-slate-400 group-focus-within:text-primary transition-colors">my_location</span>
                                </span>
                                <input
                                    class="block w-full rounded-xl border-gray-200 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 text-slate-900 dark:text-white placeholder-gray-400 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 sm:text-sm py-4 pl-10 pr-4 shadow-input transition-all"
                                    id="from" name="from_addr" placeholder="Esim. Mannerheimintie 1, Helsinki"
                                    type="text" autocomplete="off" autocorrect="off" autocapitalize="off"
                                    spellcheck="false" value="{{ request.args.get('pickup', '') }}">
                                <input type="hidden" id="from_place_id">
                                <div id="ac_from" class="ac-list"></div>
                            </div>
                        </div>

                        <!-- To Address -->
                        <div class="group">
                            <label
                                class="block text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 mb-2 pl-1"
                                for="to">Kohdeosoite</label>
                            <div
                                class="relative transition-all duration-300 focus-within:transform focus-within:-translate-y-0.5 autocomplete">
                                <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <span class="material-symbols-outlined text-lg text-primary">location_on</span>
                                </span>
                                <input
                                    class="block w-full rounded-xl border-gray-200 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 text-slate-900 dark:text-white placeholder-gray-400 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 sm:text-sm py-4 pl-10 pr-4 shadow-input transition-all"
                                    id="to" name="to_addr" placeholder="Esim. H√§meenkatu 1, Tampere" type="text"
                                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                                    value="{{ request.args.get('destination', '') }}">
                                <input type="hidden" id="to_place_id">
                                <div id="ac_to" class="ac-list"></div>
                            </div>
                        </div>

                        <!-- Saved Addresses (if logged in) -->
                        {% if current_user %}
                        <div class="group pt-2">
                            <div
                                class="relative transition-all duration-300 focus-within:transform focus-within:-translate-y-0.5">
                                <button onclick="toggleSavedAddresses()" type="button"
                                    class="w-full flex justify-between items-center bg-white dark:bg-gray-800/50 border-2 border-solid border-slate-300 dark:border-gray-600 rounded-xl pl-12 pr-4 py-4 text-sm font-medium text-slate-600 dark:text-slate-300 shadow-sm hover:border-primary/50 hover:shadow-md focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all group/btn">
                                    <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="material-symbols-outlined text-primary/70 text-xl"
                                            style="font-variation-settings: 'FILL' 1;">bookmark</span>
                                    </span>
                                    <span class="text-slate-600 dark:text-slate-300">Tallennetut osoitteet</span>
                                    <span id="savedAddressesChevron"
                                        class="material-symbols-outlined text-slate-400 group-hover/btn:text-primary transition-transform duration-300 text-lg">expand_more</span>
                                </button>
                            </div>
                            <!-- Dropdown container for saved addresses -->
                            <div id="savedAddressesContainer"
                                class="transition-all duration-300 ease-out overflow-hidden max-h-0 opacity-0 -translate-y-2 p-0 border-0 bg-white dark:bg-gray-800 rounded-xl border-gray-200 dark:border-gray-700 shadow-lg">
                                <!-- Header with Add button -->
                                <div
                                    class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200 dark:border-gray-600">
                                    <span class="text-sm font-semibold text-slate-700 dark:text-slate-300">Valitse
                                        osoite</span>
                                    <button type="button" onclick="openAddressModal()"
                                        class="inline-flex items-center gap-1 text-xs font-semibold text-primary hover:text-blue-700 transition-colors">
                                        <span class="material-symbols-outlined text-sm">add</span>
                                        Lis√§√§ uusi
                                    </button>
                                </div>
                                <!-- List of addresses (populated by JS) -->
                                <div id="addressesList" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-slate-400 text-center text-sm py-4">Ei tallennettuja osoitteita.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
                            <button id="calcBtn" onclick="calc()"
                                class="btn-gradient w-full inline-flex justify-center items-center rounded-xl border border-transparent from-brand-gradient-start to-brand-gradient-end px-4 py-3.5 text-sm font-bold text-white shadow-lg shadow-blue-500/30 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
                                type="button">
                                Laske hinta
                            </button>
                            <button onclick="demo()"
                                class="w-full inline-flex justify-center items-center rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3.5 text-sm font-semibold text-slate-600 dark:text-slate-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-750 hover:text-slate-900 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-200 transition-all"
                                type="button">
                                T√§yt√§ esimerkki
                            </button>
                        </div>

                        <p id="err" class="text-center text-sm text-red-500 font-medium hidden mt-2"></p>
                    </div>
                </div>

                <!-- Results Panel (Hidden by default) -->
                <div id="receipt"
                    class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-card p-8 border-t-4 border-primary hidden transition-all duration-500 ease-in-out transform">
                    <div class="mb-6 flex justify-between items-end">
                        <div>
                            <h2 class="text-lg font-bold text-slate-900 dark:text-white">Arvioitu hinta</h2>
                            <p class="text-xs text-slate-400 font-medium mt-1">Laskettu et√§isyyden perusteella</p>
                        </div>

                    </div>

                    <div class="space-y-6">
                        <div
                            class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700/50">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                    <span class="material-symbols-outlined text-slate-400">straighten</span>
                                </div>
                                <span class="text-sm font-medium text-slate-600 dark:text-slate-300">Matkan
                                    pituus</span>
                            </div>
                            <span id="r_km" class="text-lg font-bold text-slate-900 dark:text-white">‚Äî</span>
                        </div>

                        <div class="relative py-6 border-t border-dashed border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Yhteens√§ (ALV
                                    0%)</span>
                                <span id="r_net"
                                    class="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">‚Äî</span>
                            </div>

                            <!-- Discount info -->
                            <div id="discount_summary"
                                class="hidden mb-2 bg-green-50 p-2 rounded border border-green-100">
                                <div class="flex justify-between text-xs font-semibold text-green-700">
                                    <span>S√§√§st√§t</span>
                                    <span id="discount_total_amount">-0,00 ‚Ç¨</span>
                                </div>
                            </div>

                            <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400 mt-2">
                                <span>ALV 25,5% osuus</span>
                                <span id="r_vat">‚Äî</span>
                            </div>
                            <div
                                class="flex justify-between text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1">
                                <span>Maksettava yhteens√§</span>
                                <span id="r_gross">‚Äî</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <a id="continueBtn" href="#"
                                class="group w-full inline-flex justify-center items-center rounded-xl border border-transparent bg-secondary px-6 py-4 text-base font-bold text-white shadow-lg shadow-emerald-500/20 hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-all transform active:scale-[0.98] pointer-events-none opacity-50">
                                Jatka tilaukseen
                                <span
                                    class="material-symbols-outlined ml-2 text-xl group-hover:translate-x-1 transition-transform">arrow_forward</span>
                            </a>
                            <a href="/dashboard"
                                class="w-full inline-block text-center text-sm font-medium text-slate-500 hover:text-primary transition-colors py-2">
                                Tarkastele aiempia tilauksia
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Map -->
            <div class="lg:col-span-7 h-full min-h-[600px] lg:h-auto lg:sticky lg:top-32 z-10">
                <div
                    class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-card hover:shadow-card-hover transition-shadow duration-300 p-2 h-full flex flex-col min-h-[600px]">
                    <div
                        class="relative flex-grow rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800 h-full relative z-0">
                        <!-- Map Container -->
                        <div id="map"></div>

                        <!-- Overlay Hints on top of map (optional, hide when map active?) -->
                        <div id="map-overlay-hint"
                            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none text-center">
                            <span class="material-symbols-outlined text-slate-300 text-6xl">map</span>
                            <p class="text-slate-400 text-sm font-medium mt-2">Kartta p√§ivittyy haun j√§lkeen</p>
                        </div>
                    </div>

                    <div class="pt-4 px-4 pb-2 flex justify-between items-center text-xs text-slate-400">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span>Kuljetusreitti</span>
                        </div>
                        <span>Levoro Maps ¬©</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-background-dark text-white pt-12 pb-12 mt-auto relative overflow-hidden">
        <!-- Top gradient line -->
        <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent">
        </div>

        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm text-slate-400">¬© 2025 Levoro - Tiyouba Oy | Y-tunnus: 1541430-2</p>
        </div>
    </footer>

    <!-- Google Maps & Leaflet JS -->
    {% if google_places_api_key %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_places_api_key }}&libraries=places&loading=async"
        async defer></script>
    {% endif %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Constants & State
        const RATE_LIMIT_MS = 2000;
        let isCalculating = false;
        let lastCalculationTime = 0;
        let map, routeLayer;

        // Saved Addresses (injected from backend if available)
        // Saved Addresses (read from body data attribute)
        let savedAddresses = [];
        try {
            savedAddresses = JSON.parse(document.body.dataset.savedAddresses || '[]');
        } catch (e) {
            console.error('Failed to parse saved addresses', e);
        }
        window.savedAddresses = savedAddresses;

        document.addEventListener('DOMContentLoaded', function () {
            initMap();

            // Init AutoComplete
            initAutocomplete('from', 'ac_from', 'from_place_id');
            initAutocomplete('to', 'ac_to', 'to_place_id');

            // Load saved addresses from server
            loadSavedAddresses();

            // Setup Event Delegation for Addresses List
            const listContainer = document.getElementById('addressesList');
            if (listContainer) {
                listContainer.addEventListener('click', (e) => {
                    const target = e.target;

                    // Handle Delete
                    const delBtn = target.closest('.btn-delete-addr');
                    if (delBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = delBtn.getAttribute('data-id');
                        handleDeleteAddress(id);
                        return;
                    }

                    // Handle Edit
                    const editBtn = target.closest('.btn-edit-addr');
                    if (editBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = editBtn.getAttribute('data-id');
                        openAddressModal(id);
                        return;
                    }

                    // Handle Selection (Row Click)
                    const row = target.closest('.addr-row-clickable');
                    if (row) {
                        e.preventDefault();
                        const id = row.getAttribute('data-id');
                        // Find address object
                        const addr = window.savedAddresses.find(a => String(a.id) === String(id)) || window.savedAddresses[Number(id)];
                        if (addr) {
                            // Populate fields
                            document.getElementById('from').value = addr.fullAddress;
                            document.getElementById('from_place_id').value = ''; // Saved addresses have no place_id
                            // Close dropdown
                            toggleSavedAddresses();
                            // Trigger change/calc
                            if (document.getElementById('to').value.trim()) {
                                calc();
                            }
                        }
                    }
                });
            }

            // Auto-calc if params exist
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('pickup') && urlParams.get('destination')) {
                // Wait slighty for map init
                setTimeout(calc, 500);
            }
        });

        // Toggle saved addresses dropdown with slide down animation
        function toggleSavedAddresses() {
            const container = document.getElementById('savedAddressesContainer');
            const icon = document.getElementById('savedAddressesChevron');

            if (!container) return;

            // Check if currently closed (using max-h-0 as indicator)
            const isClosed = container.classList.contains('max-h-0');

            if (isClosed) {
                // Open - slide down
                container.classList.remove('max-h-0', 'opacity-0', '-translate-y-2', 'p-0', 'border-0');
                container.classList.add('max-h-[500px]', 'opacity-100', 'translate-y-0', 'p-4', 'border', 'mt-2');
                if (icon) icon.style.transform = 'rotate(180deg)';
            } else {
                // Close - slide up
                container.classList.remove('max-h-[500px]', 'opacity-100', 'translate-y-0', 'p-4', 'border', 'mt-2');
                container.classList.add('max-h-0', 'opacity-0', '-translate-y-2', 'p-0', 'border-0');
                if (icon) icon.style.transform = 'rotate(0deg)';
            }
        }

        // Populate saved addresses management list
        function populateSavedAddresses() {
            const container = document.getElementById('addressesList');
            if (!container) return;

            const list = window.savedAddresses || [];

            if (list.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center text-sm py-4">Ei tallennettuja osoitteita.</p>';
                return;
            }

            let html = '';
            list.forEach((addr, index) => {
                const displayName = addr.displayName || addr.name || addr.address || 'Tallennettu osoite';
                const fullAddress = addr.fullAddress || addr.address || addr;
                const phone = addr.phone || '';
                const addrId = addr.id || index;

                html += `
                <div class="flex items-start gap-3 p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-primary/50 hover:shadow-sm transition-all group cursor-pointer addr-row-clickable" data-id="${addrId}">
                    <div class="flex items-start gap-2 flex-1 min-w-0 pointer-events-none">
                        <span class="material-symbols-outlined text-primary text-lg mt-0.5 flex-shrink-0" style="font-variation-settings: 'FILL' 1;">bookmark</span>
                        <div class="min-w-0">
                            <div class="font-semibold text-slate-800 dark:text-white text-sm truncate">${displayName}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 truncate">${fullAddress}</div>
                            ${phone ? `<div class="text-xs text-slate-400 mt-0.5">üìû ${phone}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="btn-edit-addr p-1.5 text-slate-400 hover:text-primary hover:bg-blue-50 rounded-md transition-colors" data-id="${addrId}" title="Muokkaa">
                            <span class="material-symbols-outlined text-sm pointer-events-none">edit</span>
                        </button>
                        <button type="button" class="btn-delete-addr p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors" data-id="${addrId}" title="Poista">
                            <span class="material-symbols-outlined text-sm pointer-events-none">delete</span>
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- CRUD Functions for Saved Addresses ---
        async function apiCall(url, options = {}) {
            const res = await fetch(url, options);
            let data = null;
            try { data = await res.json(); } catch { }
            if (!res.ok) throw new Error((data && (data.error || data.message)) || ('HTTP ' + res.status));
            return data;
        }

        async function fetchServerAddresses() {
            const data = await apiCall('/api/saved_addresses', { method: 'GET' });
            return Array.isArray(data.items) ? data.items : [];
        }

        async function createServerAddress(displayName, fullAddress, phone) {
            const payload = { displayName, fullAddress };
            if (phone) payload.phone = phone;
            const data = await apiCall('/api/saved_addresses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return data.item;
        }

        async function updateServerAddress(id, displayName, fullAddress, phone) {
            const payload = { displayName, fullAddress };
            if (phone !== undefined) payload.phone = phone;
            const data = await apiCall(`/api/saved_addresses/${encodeURIComponent(id)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return data.item;
        }

        async function deleteServerAddress(id) {
            // Handle legacy "index as ID" case
            if (id.length < 5 && !isNaN(id)) {
                const realAddr = window.savedAddresses[Number(id)];
                if (realAddr) {
                    id = realAddr.id || "None";
                }
            }
            await apiCall(`/api/saved_addresses/${encodeURIComponent(id)}`, { method: 'DELETE' });
        }

        // Open Add Address Modal
        function openAddressModal(editId = null) {
            const isEdit = !!editId;
            let existingAddr = null;
            if (isEdit) {
                existingAddr = (window.savedAddresses || []).find(a => String(a.id) === String(editId));
            }

            const html = `
            <div id="addressModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this) closeAddressModal()">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">${isEdit ? 'Muokkaa osoitetta' : 'Lis√§√§ uusi osoite'}</h3>
                        <button type="button" onclick="closeAddressModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nimi *</label>
                            <input id="addrName" type="text" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white transition-colors" placeholder="Esim. Koti, Toimisto" value="${existingAddr ? existingAddr.displayName : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Osoite *</label>
                            <input id="addrFull" type="text" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white transition-colors" placeholder="Esim. Mannerheimintie 1, Helsinki" value="${existingAddr ? existingAddr.fullAddress : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Puhelinnumero (valinnainen)</label>
                            <input id="addrPhone" type="tel" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white transition-colors" placeholder="+358..." value="${existingAddr && existingAddr.phone ? existingAddr.phone : ''}">
                        </div>
                    </div>
                    <input type="hidden" id="addrEditId" value="${editId || ''}">
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeAddressModal()" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl text-slate-600 dark:text-slate-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Peruuta</button>
                        <button type="button" onclick="saveAddressFromModal()" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors shadow-lg shadow-blue-500/30">Tallenna</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('addrName').focus();
        }

        function closeAddressModal() {
            const m = document.getElementById('addressModal');
            if (m) m.remove();
        }

        async function saveAddressFromModal() {
            const name = document.getElementById('addrName').value.trim();
            const addr = document.getElementById('addrFull').value.trim();
            const phone = document.getElementById('addrPhone').value.trim();
            const editId = document.getElementById('addrEditId').value;

            if (!name || !addr) {
                showToast('T√§yt√§ nimi ja osoite.', 'warning');
                return;
            }
            if (phone && !/^[+]?[0-9\s\-()]+$/.test(phone)) {
                showToast('Virheellinen puhelinnumero. K√§yt√§ vain numeroita ja merkkej√§ +, -, ( ).', 'warning');
                return;
            }

            try {
                if (editId) {
                    // Update existing
                    const updated = await updateServerAddress(editId, name, addr, phone);
                    const idx = window.savedAddresses.findIndex(a => String(a.id) === String(editId));
                    if (idx >= 0) window.savedAddresses[idx] = updated;
                } else {
                    // Create new
                    const created = await createServerAddress(name, addr, phone);
                    window.savedAddresses.push(created);
                }
                populateSavedAddresses();
                closeAddressModal();
            } catch (e) {
                showToast('Tallennus ep√§onnistui: ' + e.message, 'error');
            }
        }

        window.handleDeleteAddress = async function (id) {

            // if (!confirm('Haluatko varmasti poistaa t√§m√§n osoitteen?')) return; 
            // Confirm disabled for debugging per user request

            try {
                const response = await deleteServerAddress(id);

                const oldLen = window.savedAddresses.length;
                window.savedAddresses = window.savedAddresses.filter(a => String(a.id) !== String(id));
                const newLen = window.savedAddresses.length;


                populateSavedAddresses();
            } catch (e) {
                console.error('Delete failed:', e);
                showToast('Poistaminen ep√§onnistui: ' + e.message, 'error');
            }
        }

        // Load saved addresses on init
        async function loadSavedAddresses() {
            try {
                const addresses = await fetchServerAddresses();
                window.savedAddresses = addresses;
                populateSavedAddresses();
            } catch (e) {
                console.error('Failed to load saved addresses:', e);
            }
        }

        // --- Map Logic ---
        function initMap() {
            if (map) return;
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false, // Hide watermark
                dragging: false,           // Disable interactions
                touchZoom: false,
                doubleClickZoom: false,
                scrollWheelZoom: false,
                boxZoom: false,
                keyboard: false
            }).setView([61.9241, 25.7482], 6); // Finland center

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            // No zoom control needed if interaction disabled
        }

        function drawRoute(latlngs, start, end, km) {
            if (routeLayer) map.removeLayer(routeLayer);

            // Create feature group for route elements
            const routeGroup = L.featureGroup();

            // Polyline
            const polyline = L.polyline(latlngs, { color: '#2563eb', weight: 5, opacity: 0.9 }).addTo(routeGroup);

            // Markers
            const startIcon = L.divIcon({
                className: 'bg-transparent',
                html: `<div class="w-4 h-4 rounded-full bg-white border-4 border-blue-600 shadow-sm"></div>`,
                iconSize: [16, 16], iconAnchor: [8, 8]
            });
            const endIcon = L.divIcon({
                className: 'bg-transparent',
                html: `<span class="material-symbols-outlined text-blue-600 text-3xl drop-shadow-md" style="font-variation-settings: 'FILL' 1;">location_on</span>`,
                iconSize: [30, 30], iconAnchor: [15, 30]
            });

            L.marker(start, { icon: startIcon }).addTo(routeGroup);
            L.marker(end, { icon: endIcon }).addTo(routeGroup);

            // Distance Label
            const center = polyline.getBounds().getCenter();
            L.marker(center, {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);white-space:nowrap;" class="text-sm font-bold text-blue-600 bg-white px-4 py-2 rounded-full shadow-md border border-blue-100">${km} km</div>`,
                    iconSize: [0, 0], iconAnchor: [0, 0]
                }),
                zIndexOffset: 1000
            }).addTo(routeGroup);

            // City Labels
            const startCity = start.city || 'L√§ht√∂';
            const endCity = end.city || 'Kohde';

            L.marker(start, {
                icon: L.divIcon({
                    className: 'city-label-start',
                    html: `<div style="position:absolute;left:50%;bottom:24px;transform:translateX(-50%);white-space:nowrap;" class="bg-white/95 backdrop-blur px-3 py-1.5 rounded-lg shadow-md text-xs font-bold text-slate-700 border border-slate-100">${startCity}</div>`,
                    iconSize: [0, 0], iconAnchor: [0, 0]
                })
            }).addTo(routeGroup);

            L.marker(end, {
                icon: L.divIcon({
                    className: 'city-label-end',
                    html: `<div style="position:absolute;left:50%;bottom:42px;transform:translateX(-50%);white-space:nowrap;" class="bg-white/95 backdrop-blur px-3 py-1.5 rounded-lg shadow-md text-xs font-bold text-slate-700 border border-slate-100">${endCity}</div>`,
                    iconSize: [0, 0], iconAnchor: [0, 0]
                })
            }).addTo(routeGroup);

            routeGroup.addTo(map);
            routeLayer = routeGroup;

            // Increased padding to handle labels better
            map.fitBounds(routeGroup.getBounds(), { padding: [80, 80] });

            // Hide hint
            document.getElementById('map-overlay-hint').style.display = 'none';
        }

        // --- Calculation Logic ---
        async function calc() {
            // Rate limiting
            const now = Date.now();
            if (isCalculating) return;
            if (now - lastCalculationTime < RATE_LIMIT_MS) {
                showError(`Odota hetki ennen uutta laskentaa.`);
                return;
            }

            const fromVal = document.getElementById('from').value.trim();
            const toVal = document.getElementById('to').value.trim();

            if (!fromVal || !toVal) {
                showError('Sy√∂t√§ molemmat osoitteet.');
                return;
            }

            // UI Loading State
            isCalculating = true;
            lastCalculationTime = now;
            const btn = document.getElementById('calcBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-xl mr-2">progress_activity</span> Lasketaan...`;
            btn.classList.add('opacity-75', 'cursor-wait');
            document.getElementById('err').classList.add('hidden');

            // Normalize addresses for comparison (remove spaces, lowercase)
            const normFrom = fromVal.toLowerCase().replace(/\s/g, '');
            const normTo = toVal.toLowerCase().replace(/\s/g, '');

            // Validation: Same address
            if (normFrom === normTo) {
                showError('L√§ht√∂- ja kohdeosoite eiv√§t voi olla samat. Ole hyv√§ ja tarkista osoitteet.');
                isCalculating = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-75', 'cursor-wait');
                return;
            }

            try {
                const payload = {
                    pickup: fromVal,
                    dropoff: toVal,
                    pickup_place_id: document.getElementById('from_place_id').value,
                    dropoff_place_id: document.getElementById('to_place_id').value
                };

                // 1. Get Quote
                const quoteRes = await fetch('/api/quote_for_addresses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const quote = await quoteRes.json();

                if (!quoteRes.ok) {
                    // Map common backend errors to user-friendly messages
                    let friendlyMsg = quote.error || 'Virhe hinnan laskennassa';

                    if (quote.error && (quote.error.includes('ZERO_RESULTS') || quote.error.includes('NOT_FOUND'))) {
                        friendlyMsg = 'Reitti√§ ei l√∂ytynyt n√§iden osoitteiden v√§lille. Tarkista osoitteet.';
                    } else if (quote.error && quote.error.includes('same')) {
                        friendlyMsg = 'L√§ht√∂- ja kohdeosoite ovat liian l√§hell√§ toisiaan.';
                    } else if (quoteRes.status === 500) {
                        friendlyMsg = 'Palvelussa tapahtui virhe. Yrit√§ hetken kuluttua uudelleen.';
                    }

                    throw new Error(friendlyMsg);
                }

                // Update Results
                document.getElementById('r_km').textContent = (Number(quote.km).toFixed(1).replace('.', ',')) + ' km';
                document.getElementById('r_net').textContent = (Number(quote.net).toFixed(2).replace('.', ',')) + ' ‚Ç¨';
                document.getElementById('r_vat').textContent = (Number(quote.vat).toFixed(2).replace('.', ',')) + ' ‚Ç¨';
                document.getElementById('r_gross').textContent = (Number(quote.gross).toFixed(2).replace('.', ',')) + ' ‚Ç¨';

                // Show Results Panel
                const receipt = document.getElementById('receipt');
                receipt.classList.remove('hidden');

                // Enable Continue Button
                const contBtn = document.getElementById('continueBtn');
                contBtn.href = `/order/new/step1?pickup=${encodeURIComponent(fromVal)}&dropoff=${encodeURIComponent(toVal)}`;
                contBtn.classList.remove('pointer-events-none', 'opacity-50');

                // 2. Get Route Geometry
                const routeRes = await fetch('/api/route_geo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const route = await routeRes.json();

                if (routeRes.ok) {
                    // Extract city names from response or inputs for labels
                    // Assuming regular geocoding, we use the input values as "cities" for now
                    // Ideally, we'd parse the city from the geocode result
                    const startRaw = document.getElementById('from').value.split(',')[0];
                    const endRaw = document.getElementById('to').value.split(',')[0];

                    route.start.city = startRaw;
                    route.end.city = endRaw;

                    drawRoute(route.latlngs, route.start, route.end, quote.km);
                }

                // Scroll to results on mobile
                if (window.innerWidth < 1024) {
                    receipt.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

            } catch (e) {
                showError(e.message);
            } finally {
                isCalculating = false;
                btn.innerHTML = originalText;
                btn.classList.remove('opacity-75', 'cursor-wait');
            }
        }

        function showError(msg) {
            const err = document.getElementById('err');
            err.textContent = msg;
            err.classList.remove('hidden');
        }

        function demo() {
            document.getElementById('from').value = 'Mannerheimintie 1, Helsinki';
            document.getElementById('to').value = 'H√§meenkatu 1, Tampere';
            calc();
        }


        // --- Autocomplete Logic with Saved Addresses ---
        function renderSavedAddressesHtml(inputId, listId, hiddenId, filterQuery = '') {
            const addresses = window.savedAddresses || [];
            if (addresses.length === 0) return '';

            // Filter addresses if query is provided
            const filtered = filterQuery
                ? addresses.filter(a => {
                    const searchText = ((a.displayName || '') + ' ' + (a.fullAddress || '')).toLowerCase();
                    return searchText.includes(filterQuery.toLowerCase());
                })
                : addresses;

            if (filtered.length === 0) return '';

            let html = `<div class="ac-saved-section">
                <div class="ac-section-header">
                    <span class="material-symbols-outlined text-primary text-sm mr-1" style="font-variation-settings: 'FILL' 1;">bookmark</span>
                    Tallennetut osoitteet
                </div>`;

            filtered.forEach((addr, idx) => {
                const displayName = addr.displayName || addr.name || 'Tallennettu osoite';
                const fullAddress = addr.fullAddress || addr.address || '';
                const safeAddress = fullAddress.replace(/'/g, "\\'");
                html += `<div class="ac-item ac-saved-item" onclick="selectSavedAddress('${inputId}', '${listId}', '${hiddenId}', '${safeAddress}', ${addresses.indexOf(addr)})">
                    <span class="material-symbols-outlined text-primary text-sm mr-2 align-middle" style="font-variation-settings: 'FILL' 1;">bookmark</span>
                    <div class="ac-item-content">
                        <div class="ac-item-name">${displayName}</div>
                        <div class="ac-item-address">${fullAddress}</div>
                    </div>
                </div>`;
            });

            html += `<div class="ac-add-new" onclick="openAddressModal()">
                <span class="material-symbols-outlined text-sm mr-1">add</span>
                Lis√§√§ uusi osoite
            </div></div>`;

            return html;
        }

        function initAutocomplete(inputId, listId, hiddenId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const hidden = document.getElementById(hiddenId);
            let timer;

            // Show saved addresses on focus (if user is logged in and has saved addresses)
            input.addEventListener('focus', () => {
                const savedHtml = renderSavedAddressesHtml(inputId, listId, hiddenId);
                if (savedHtml) {
                    list.innerHTML = savedHtml;
                    list.style.display = 'block';
                }
            });

            input.addEventListener('input', () => {
                clearTimeout(timer);
                const q = input.value.trim();

                // Show saved addresses immediately (filtered if query exists)
                const savedHtml = renderSavedAddressesHtml(inputId, listId, hiddenId, q);

                if (q.length < 3) {
                    // Just show saved addresses if query is short
                    if (savedHtml) {
                        list.innerHTML = savedHtml;
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                    return;
                }

                // Show saved addresses immediately, then fetch Google Places
                if (savedHtml) {
                    list.innerHTML = savedHtml + '<div class="ac-loading"><span class="material-symbols-outlined animate-spin text-gray-400 text-sm">progress_activity</span> Haetaan...</div>';
                    list.style.display = 'block';
                }

                timer = setTimeout(async () => {
                    try {
                        const res = await fetch('/api/places_autocomplete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: q })
                        });
                        const data = await res.json();

                        let placesHtml = '';
                        if (data.predictions && data.predictions.length) {
                            placesHtml = `<div class="ac-places-section">
                                <div class="ac-section-header">
                                    <span class="material-symbols-outlined text-gray-400 text-sm mr-1">search</span>
                                    Hakutulokset
                                </div>`;
                            placesHtml += data.predictions.map((p) =>
                                `<div class="ac-item" onclick="selectPlace('${inputId}', '${listId}', '${hiddenId}', '${p.description.replace(/'/g, "\\'")}', '${p.place_id}')">
                                <span class="material-symbols-outlined text-gray-400 text-sm mr-2 align-middle">location_on</span>
                                ${p.description}
                            </div>`
                            ).join('');
                            placesHtml += '</div>';
                        }

                        const finalHtml = savedHtml + placesHtml;
                        if (finalHtml) {
                            list.innerHTML = finalHtml;
                            list.style.display = 'block';
                        } else {
                            list.style.display = 'none';
                        }
                    } catch (e) {
                        console.error(e);
                        // Still show saved addresses even if Places API fails
                        if (savedHtml) {
                            list.innerHTML = savedHtml;
                            list.style.display = 'block';
                        }
                    }
                }, 300);
            });

            // Hide when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.style.display = 'none';
                }
            });
        }

        // Select a saved address
        window.selectSavedAddress = function (inputId, listId, hiddenId, address, index) {
            document.getElementById(inputId).value = address;
            document.getElementById(hiddenId).value = ''; // Saved addresses may not have place_id
            document.getElementById(listId).style.display = 'none';

            // Auto-calc check
            const otherId = inputId === 'from' ? 'to' : 'from';
            if (document.getElementById(otherId).value.trim()) {
                calc();
            }
        };

        // Global select function for onclick (Google Places)
        window.selectPlace = function (inputId, listId, hiddenId, text, placeId) {
            document.getElementById(inputId).value = text;
            document.getElementById(hiddenId).value = placeId;
            document.getElementById(listId).style.display = 'none';

            // Auto-calc check
            const otherId = inputId === 'from' ? 'to' : 'from';
            if (document.getElementById(otherId).value.trim()) {
                calc();
            }
        };
    </script>

    <!-- Toast notification container and function -->
    <div id="toast-container" style="position:fixed;top:80px;right:20px;z-index:999999;display:flex;flex-direction:column;gap:10px;"></div>
    <script>
        window.showToast = function(message, type = 'error') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            const colors = {
                error: { bg: '#ef4444', icon: 'error' },
                success: { bg: '#10b981', icon: 'check_circle' },
                warning: { bg: '#f59e0b', icon: 'warning' },
                info: { bg: '#3b82f6', icon: 'info' }
            };
            const { bg, icon } = colors[type] || colors.error;
            
            toast.style.cssText = `
                display:flex;align-items:center;gap:10px;padding:14px 20px;
                background:${bg};color:white;border-radius:10px;
                box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:14px;font-weight:500;
                transform:translateX(120%);transition:transform 0.3s ease;max-width:360px;
            `;
            toast.innerHTML = `<span class="material-symbols-outlined" style="font-size:20px;">${icon}</span><span>${message}</span>`;
            container.appendChild(toast);
            
            requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };
    </script>

</body>

</html>
