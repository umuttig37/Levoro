{% extends "base/layout.html" %}
{% import 'components/icons.html' as icons %}

{% block title %}Hae kuljettajaksi – Levoro{% endblock %}

{% block extra_css %}
<style>
    /* Application Container */
    .application-container {
        max-width: 640px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* Page Header */
    .application-page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .application-page-title {
        font-size: clamp(1.75rem, 4vw, 2.25rem);
        font-weight: 700;
        color: var(--color-heading, #1f2937);
        margin-bottom: 0.5rem;
        letter-spacing: -0.02em;
    }

    /* Progress Stepper */
    .progress-stepper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        padding: 0 1rem;
        position: relative;
    }

    .progress-track {
        position: absolute;
        top: 50%;
        left: 30px;
        right: 30px;
        height: 2px;
        background: var(--color-gray-200, #e5e7eb);
        transform: translateY(-50%);
        z-index: 0;
    }

    .progress-track-fill {
        height: 100%;
        background: var(--color-primary, #3b82f6);
        width: 0%;
        transition: width 0.3s ease;
    }

    .step-item {
        position: relative;
        z-index: 1;
        background: white;
        padding: 0 0.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background: white;
        border: 2px solid var(--color-gray-200, #e5e7eb);
        color: var(--color-gray-500, #6b7280);
        transition: all 0.3s ease;
    }

    .step-item.active .step-icon {
        border-color: var(--color-primary, #3b82f6);
        color: var(--color-primary, #3b82f6);
    }

    .step-item.completed .step-icon {
        background: var(--color-primary, #3b82f6);
        border-color: var(--color-primary, #3b82f6);
        color: white;
    }

    .step-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-gray-500, #6b7280);
        transition: color 0.3s ease;
    }

    .step-item.active .step-label {
        color: var(--color-heading, #1f2937);
    }

    .step-item.completed .step-label {
        color: var(--color-primary, #3b82f6);
    }

    /* Form Card */
    .application-card {
        background: white;
        border: 1px solid var(--border-light, #e5e7eb);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    /* Steps */
    .form-step {
        display: none;
        animation: fadeIn 0.4s ease;
    }

    .form-step.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-heading, #1f2937);
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light, #e5e7eb);
    }

    /* Form Fields */
    .form-group-new {
        margin-bottom: 1.25rem;
    }

    .form-label-new {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-gray-700, #374151);
        margin-bottom: 0.5rem;
    }

    .form-label-new.required::after {
        content: "*";
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-input-new {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-light, #e5e7eb);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-input-new:focus {
        outline: none;
        border-color: var(--color-primary, #3b82f6);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-help-new {
        font-size: 0.8rem;
        color: var(--color-gray-500, #6b7280);
        margin-top: 0.375rem;
    }

    /* Form Actions */
    .form-actions-new {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-light, #e5e7eb);
    }

    .btn-prev,
    .btn-next,
    .btn-submit-new {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-prev {
        background: transparent;
        border: 1px solid var(--border-light, #e5e7eb);
        color: var(--color-gray-600, #4b5563);
    }

    .btn-prev:hover {
        background: var(--color-gray-50, #f9fafb);
        border-color: var(--color-gray-300, #d1d5db);
    }

    .btn-next,
    .btn-submit-new {
        background: var(--color-primary, #3b82f6);
        border: none;
        color: white;
    }

    .btn-next:hover,
    .btn-submit-new:hover {
        background: var(--color-primary-dark, #2563eb);
        transform: translateY(-1px);
    }

    .btn-submit-new:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    /* Compact Upload Box */
    .upload-box {
        width: 180px;
        height: 180px;
        border: 2px dashed var(--border-light, #d1d5db);
        border-radius: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--color-gray-50, #f9fafb);
        position: relative;
        overflow: hidden;
    }

    .upload-box:hover {
        border-color: var(--color-primary, #3b82f6);
        background: #eff6ff;
    }

    .upload-box.has-image {
        border-style: solid;
        border-color: var(--color-primary, #3b82f6);
        background: white;
    }

    .upload-box input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
    }

    .upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-gray-400, #9ca3af);
        pointer-events: none;
    }

    .upload-box.has-image .upload-placeholder {
        display: none;
    }

    .upload-icon {
        width: 32px;
        height: 32px;
        color: var(--color-gray-400, #9ca3af);
    }

    .upload-text {
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
    }

    .upload-preview {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 0.5rem;
        display: none;
    }

    .upload-box.has-image .upload-preview {
        display: block;
    }

    .upload-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: rgba(220, 38, 38, 0.9);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 14px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3;
        transition: background 0.2s ease;
    }

    .upload-box.has-image .upload-remove {
        display: flex;
    }

    .upload-remove:hover {
        background: #dc2626;
    }

    .upload-boxes-row {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .upload-box-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .upload-box-label {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--color-gray-600, #4b5563);
    }

    .upload-box-label.required::after {
        content: "*";
        color: #ef4444;
        margin-left: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="application-container">
    <div class="application-page-header">
        <h1 class="application-page-title">Hae kuljettajaksi</h1>
        <p style="color: var(--color-gray-600, #4b5563);">Liity tiimiimme muutamalla askeleella</p>
    </div>

    <!-- Progress Stepper -->
    <div class="progress-stepper">
        <div class="progress-track">
            <div class="progress-track-fill" id="progressFill"></div>
        </div>

        <div class="step-item active" data-step="1">
            <div class="step-icon">1</div>
            <span class="step-label">Tiedot</span>
        </div>
        <div class="step-item" data-step="2">
            <div class="step-icon">2</div>
            <span class="step-label">Turvallisuus</span>
        </div>
        <div class="step-item" data-step="3">
            <div class="step-icon">3</div>
            <span class="step-label">Ajokortti</span>
        </div>
    </div>

    <!-- Form Card -->
    <form class="application-card" id="applicationForm" method="POST" action="/hae-kuljettajaksi"
        enctype="multipart/form-data">

        <!-- Step 1: Personal Info -->
        <div class="form-step active" data-step="1">
            <h2 class="step-title">Henkilötiedot</h2>
            <div class="form-group-new">
                <label class="form-label-new required" for="first_name">Etunimi</label>
                <input type="text" id="first_name" name="first_name" class="form-input-new" required
                    value="{{ request.form.get('first_name', '') }}" placeholder="Anna etunimesi">
            </div>
            <div class="form-group-new">
                <label class="form-label-new required" for="last_name">Sukunimi</label>
                <input type="text" id="last_name" name="last_name" class="form-input-new" required
                    value="{{ request.form.get('last_name', '') }}" placeholder="Anna sukunimesi">
            </div>
            <div class="form-group-new">
                <label class="form-label-new required" for="email">Sähköposti</label>
                <input type="email" id="email" name="email" class="form-input-new" required
                    value="{{ request.form.get('email', '') }}" placeholder="esimerkki@sähköposti.fi">
            </div>
            <div class="form-group-new">
                <label class="form-label-new required" for="phone">Puhelinnumero</label>
                <input type="tel" id="phone" name="phone" class="form-input-new" required
                    value="{{ request.form.get('phone', '') }}" placeholder="+358 40 123 4567">
            </div>
        </div>

        <!-- Step 2: Password -->
        <div class="form-step" data-step="2">
            <h2 class="step-title">Luo salasana</h2>
            <div class="form-group-new">
                <label class="form-label-new required" for="password">Salasana</label>
                <input type="password" id="password" name="password" class="form-input-new" required minlength="6"
                    placeholder="Vähintään 6 merkkiä">
                <p class="form-help-new">Käytä vähintään 6 merkkiä.</p>
            </div>
            <div class="form-group-new">
                <label class="form-label-new required" for="password_confirm">Vahvista salasana</label>
                <input type="password" id="password_confirm" name="password_confirm" class="form-input-new" required
                    placeholder="Syötä salasana uudelleen">
            </div>
        </div>

        <!-- Step 3: Files -->
        <div class="form-step" data-step="3">
            <h2 class="step-title">Ajokorttitiedot</h2>
            <div class="upload-boxes-row">
                <div class="upload-box-group">
                    <span class="upload-box-label required">Ajokortti (etuosa)</span>
                    <div class="upload-box" id="upload_box_front">
                        <input type="file" id="license_front" name="license_front" accept=".jpg,.jpeg,.png,.webp"
                            required onchange="previewUpload(this, 'front')">
                        <div class="upload-placeholder">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            <span class="upload-text">Valitse kuva</span>
                        </div>
                        <img src="" alt="Esikatselu" class="upload-preview" id="preview_front">
                        <button type="button" class="upload-remove" onclick="removeUpload('front', event)">✕</button>
                    </div>
                </div>
                <div class="upload-box-group">
                    <span class="upload-box-label required">Ajokortti (takaosa)</span>
                    <div class="upload-box" id="upload_box_back">
                        <input type="file" id="license_back" name="license_back" accept=".jpg,.jpeg,.png,.webp" required
                            onchange="previewUpload(this, 'back')">
                        <div class="upload-placeholder">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            <span class="upload-text">Valitse kuva</span>
                        </div>
                        <img src="" alt="Esikatselu" class="upload-preview" id="preview_back">
                        <button type="button" class="upload-remove" onclick="removeUpload('back', event)">✕</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-actions-new">
            <button type="button" class="btn-prev" id="prevBtn" style="visibility: hidden;">Takaisin</button>
            <button type="button" class="btn-next" id="nextBtn">Seuraava</button>
            <button type="submit" class="btn-submit-new" id="submitBtn" style="display: none;">Lähetä hakemus</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('applicationForm');
        const steps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.step-item');
        const progressFill = document.getElementById('progressFill');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        let currentStep = 1;
        const totalSteps = steps.length;

        function updateUI() {
            // Show/Hide steps
            steps.forEach(step => {
                if (parseInt(step.dataset.step) === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Update Progress Bar
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressFill.style.width = `${progress}%`;

            // Update Indicators
            stepIndicators.forEach(indicator => {
                const stepNum = parseInt(indicator.dataset.step);
                indicator.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    indicator.classList.add('active');
                } else if (stepNum < currentStep) {
                    indicator.classList.add('completed');
                    indicator.querySelector('.step-icon').innerHTML = '✓';
                } else {
                    indicator.querySelector('.step-icon').innerText = stepNum;
                }
            });

            // Update Buttons
            prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';

            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                nextBtn.innerText = 'Seuraava';
                submitBtn.style.display = 'none';
            }
        }

        function validateStep(step) {
            const activeStepEl = document.querySelector(`.form-step[data-step="${step}"]`);
            const inputs = activeStepEl.querySelectorAll('input[required]');
            let isValid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    isValid = false;
                    input.reportValidity();
                }
            });

            // Password match check on step 2
            if (step === 2 && isValid) {
                const pwd = document.getElementById('password').value;
                const pwdConfirm = document.getElementById('password_confirm').value;
                if (pwd !== pwdConfirm) {
                    const confirmInput = document.getElementById('password_confirm');
                    confirmInput.setCustomValidity('Salasanat eivät täsmää');
                    confirmInput.reportValidity();
                    isValid = false;
                    // Reset custom validity after reporting so typing can clear it
                    confirmInput.addEventListener('input', () => confirmInput.setCustomValidity(''), { once: true });
                }
            }

            return isValid;
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                updateUI();
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        });

        // Initialize Phone Formatting
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.startsWith('358')) {
                    value = '+' + value;
                } else if (value.startsWith('0')) {
                    value = '+358' + value.substring(1);
                } else if (value.length > 0 && !value.startsWith('+')) {
                    // Optional: auto-add prefix if user types raw number
                }
                e.target.value = value;
            });
        }

        // Initial Render
        updateUI();
    });

    // Image Preview Functions for Compact Upload Boxes
    function previewUpload(input, type) {
        const box = document.getElementById('upload_box_' + type);
        const preview = document.getElementById('preview_' + type);

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
                preview.src = e.target.result;
                box.classList.add('has-image');
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeUpload(type, event) {
        event.preventDefault();
        event.stopPropagation();

        const input = document.getElementById('license_' + type);
        const box = document.getElementById('upload_box_' + type);
        const preview = document.getElementById('preview_' + type);

        // Clear the file input
        input.value = '';

        // Hide and clear preview
        preview.src = '';
        box.classList.remove('has-image');
    }
</script>
{% endblock %}